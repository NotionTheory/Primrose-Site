function reloadPage(){document.location=document.location.href}function cascadeElement(a,b,c){var d=null;if(null===a?(d=document.createElement(b),d.id=a="auto_"+b+Date.now()):void 0===c||a instanceof c?d=a:"string"==typeof a&&(d=document.getElementById(a),null===d?(d=document.createElement(b),d.id=a):d.tagName!==b.toUpperCase()&&(d=null)),null===d)throw new Error(a+" does not refer to a valid "+b+" element.");return d.innerHTML="",d}function findEverything(a,b){a=a||document,b=b||{};for(var c=a.querySelectorAll("*"),d=0;d<c.length;++d){var e=c[d];e.id&&e.id.length>0&&(b[e.id]=e,e.parentElement&&(e.parentElement[e.id]=e))}return b}function makeHidingContainer(a,b){var c=cascadeElement(a,"div",window.HTMLDivElement);return c.style.position="absolute",c.style.left=0,c.style.top=0,c.style.width=0,c.style.height=0,c.style.overflow="hidden",c.appendChild(b),c}function makeSelectorFromObj(a,b,c,d,e,f,g){var h=cascadeElement(a,"select",window.HTMLSelectElement),i=[];for(var j in b)if(b.hasOwnProperty(j)){var k=b[j];if(!g||k instanceof g){k=k.name||j;var l=document.createElement("option");l.innerHTML=k,i.push(b[j]),k===c&&(l.selected="selected"),h.appendChild(l)}}"function"==typeof d[e]?h.addEventListener("change",function(){d[e](i[h.selectedIndex])}):h.addEventListener("change",function(){d[e]=i[h.selectedIndex]});var m=cascadeElement("container -"+a,"div",window.HTMLDivElement),n=cascadeElement("label-"+a,"span",window.HTMLSpanElement);return n.innerHTML=f+": ",n["for"]=h,h.title=f,h.alt=f,m.appendChild(n),m.appendChild(h),m}function sigfig(a,b){var c=Math.pow(10,b),d=(Math.round(a*c)/c).toString();if(b>0){var e=d.indexOf(".");for(-1===e&&(d+=".",e=d.length-1);d.length-e-1<b;)d+="0"}return d}function getSetting(a,b){if(window.localStorage){var c=window.localStorage.getItem(a);if(c)try{return JSON.parse(c)}catch(d){console.error("getSetting",a,c,typeof c,d)}}return b}function setSetting(a,b){if(window.localStorage&&b)try{window.localStorage.setItem(a,JSON.stringify(b))}catch(c){console.error("setSetting",a,b,typeof b,c)}}function deleteSetting(a){window.localStorage&&window.localStorage.removeItem(a)}function readForm(a){var b={};if(a)for(var c in a){var d=a[c];"INPUT"!==d.tagName&&"SELECT"!==d.tagName||d.dataset&&d.dataset.skipcache||("text"===d.type||"password"===d.type||"SELECT"===d.tagName?b[c]=d.value:("checkbox"===d.type||"radio"===d.type)&&(b[c]=d.checked))}return b}function writeForm(a,b){if(b)for(var c in a){var d=a[c];null===b[c]||void 0===b[c]||"INPUT"!==d.tagName&&"SELECT"!==d.tagName||d.dataset&&d.dataset.skipcache||("text"===d.type||"password"===d.type||"SELECT"===d.tagName?d.value=b[c]:("checkbox"===d.type||"radio"===d.type)&&(d.checked=b[c]))}}function isFullScreenMode(){return document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function requestFullScreen(a,b){var c;window.HMDVRDevice&&b&&b instanceof HMDVRDevice&&(c={vrDisplay:b}),a.webkitRequestFullscreen?a.webkitRequestFullscreen(c||window.Element.ALLOW_KEYBOARD_INPUT):a.mozRequestFullScreen&&c?a.mozRequestFullScreen(c):a.mozRequestFullScreen&&!c?a.mozRequestFullScreen():a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen&&a.msRequestFullscreen()}function exitFullScreen(){isFullScreenMode()&&(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen())}function toggleFullScreen(a,b){isFullScreenMode()?exitFullScreen():requestFullScreen(a,b)}function addFullScreenShim(a){function b(){a.forEach(function(a){a.events.forEach(function(b){a.removeEventListener(b,c)})})}function c(){requestFullScreen(b)}a=a.map(function(a){return{elem:a,events:help(a).events}}),a.forEach(function(a){a.events.forEach(function(b){b.indexOf("fullscreenerror")<0&&a.addEventListener(b,c,!1)})})}function InsideSphereGeometry(a,b,c,d,e,f,g){"use strict";THREE.Geometry.call(this),this.type="InsideSphereGeometry",this.parameters={radius:a,widthSegments:b,heightSegments:c,phiStart:d,phiLength:e,thetaStart:f,thetaLength:g},a=a||50,b=Math.max(3,Math.floor(b)||8),c=Math.max(2,Math.floor(c)||6),d=void 0!==d?d:0,e=void 0!==e?e:2*Math.PI,f=void 0!==f?f:0,g=void 0!==g?g:Math.PI;var h,i,j=[],k=[];for(i=0;c>=i;i++){var l=[],m=[];for(h=b;h>=0;h--){var n=h/b,o=i/c,p=new THREE.Vector3;p.x=-a*Math.cos(d+n*e)*Math.sin(f+o*g),p.y=a*Math.cos(f+o*g),p.z=a*Math.sin(d+n*e)*Math.sin(f+o*g),this.vertices.push(p),l.push(this.vertices.length-1),m.push(new THREE.Vector2(1-n,1-o))}j.push(l),k.push(m)}for(i=0;c>i;i++)for(h=0;b>h;h++){var q=j[i][h+1],r=j[i][h],s=j[i+1][h],t=j[i+1][h+1],u=this.vertices[q].clone().normalize(),v=this.vertices[r].clone().normalize(),w=this.vertices[s].clone().normalize(),x=this.vertices[t].clone().normalize(),y=k[i][h+1].clone(),z=k[i][h].clone(),A=k[i+1][h].clone(),B=k[i+1][h+1].clone();Math.abs(this.vertices[q].y)===a?(y.x=(y.x+z.x)/2,this.faces.push(new THREE.Face3(q,s,t,[u,w,x])),this.faceVertexUvs[0].push([y,A,B])):Math.abs(this.vertices[s].y)===a?(A.x=(A.x+B.x)/2,this.faces.push(new THREE.Face3(q,r,s,[u,v,w])),this.faceVertexUvs[0].push([y,z,A])):(this.faces.push(new THREE.Face3(q,r,t,[u,v,x])),this.faceVertexUvs[0].push([y,z,B]),this.faces.push(new THREE.Face3(r,s,t,[v.clone(),w,x.clone()])),this.faceVertexUvs[0].push([z.clone(),A,B.clone()]))}this.computeFaceNormals();for(var C=0;C<this.faces.length;++C){var D=this.faces[C];D.normal.multiplyScalar(-1);for(var E=0;E<D.vertexNormals.length;++E)D.vertexNormals[E].multiplyScalar(-1)}this.boundingSphere=new THREE.Sphere(new THREE.Vector3,a)}function axis(a,b){var c=hub();return put(brick(16711680,a,b,b)).on(c),put(brick(65280,b,b,a)).on(c),put(brick(255,b,a,b)).on(c),c}function box(a,b,c){return void 0===b&&(b=a,c=a),new THREE.BoxGeometry(a,b,c)}function light(a,b,c,d){return new THREE.PointLight(a,b,c,d)}function v3(a,b,c){return new THREE.Vector3(a,b,c)}function quad(a,b,c,d){return void 0===b&&(b=a),new THREE.PlaneGeometry(a,b,c,d)}function hub(){return new THREE.Object3D}function brick(a,b,c,d){return textured(box(b||1,c||1,d||1),a,!1,1,b,d)}function put(a){return{on:function(b){return b.add(a),{at:function(b,c,d){return a.position.set(b,c,d),a}}}}}function fill(a,b,c,d){void 0===c&&(c=1,void 0===d&&(d=1,void 0===b&&(b=1)));var e=hub();return put(brick(a,b,c,d)).on(e).at(b/2,c/2,d/2),e}function textured(a,b,c,d,e,f){var g;if(void 0===d&&(d=1),"number"==typeof b)g=c?new THREE.MeshBasicMaterial({transparent:!0,color:b,opacity:d,shading:THREE.FlatShading}):new THREE.MeshLambertMaterial({transparent:!0,color:b,opacity:d});else{var h;h="string"==typeof b?THREE.ImageUtils.loadTexture(b):b instanceof Primrose.Text.Controls.TextBox?b.getRenderer().getTexture():b,g=c?new THREE.MeshBasicMaterial({color:16777215,map:h,transparent:!0,shading:THREE.FlatShading,side:THREE.DoubleSide,opacity:d}):new THREE.MeshLambertMaterial({color:16777215,map:h,transparent:!0,side:THREE.DoubleSide,opacity:d}),e*f>1&&(h.wrapS=h.wrapT=THREE.RepeatWrapping,h.repeat.set(e,f))}var i=null;return a.type.indexOf("Geometry")>-1?i=new THREE.Mesh(a,g):a instanceof THREE.Object3D&&(a.material=g,i=a),i}function sphere(a,b,c){return new THREE.SphereBufferGeometry(a,b,c)}function cylinder(a,b,c,d,e,f,g,h){return new THREE.CylinderGeometry(a,b,c,d,e,f,g,h)}function shell(a,b,c,d,e){var f=.45;void 0===d&&(d=Math.PI*f),void 0===e&&(e=Math.PI*f);var g=1.5*Math.PI-.5*d,h=.5*(Math.PI-e),i=new InsideSphereGeometry(a,b,c,g,d,h,e,!0);return i}function range(a,b,c,d){for(var e=c&&a||0,f=c&&b||a,g=d&&c||1,h=d||c||b,i=e;f>i;i+=g)h(i)}function cloud(a,b,c){var d=new THREE.Geometry;d.vertices.splice.bind(d.vertices,0,0).apply(d.vertices,a);var e=new THREE.PointCloudMaterial({color:b,size:c});return new THREE.PointCloud(d,e)}function makeEditor(a,b,c,d,e,f,g,h,i,j,k){var l=isMobile?.25:.5;k.size=k.size||new Primrose.Text.Size(1024*c,1024*d),k.fontSize=k.fontSize||32,k.theme=k.theme||Primrose.Text.Themes.Dark,k.tokenizer=k.tokenizer||Primrose.Text.Grammars.PlainText,void 0===k.opacity&&(k.opacity=1);var m=new Primrose.Text.Controls.TextBox(b,k),n=Math.round(1024*l*c/k.fontSize),o=Math.round(1024*l*d/k.fontSize),p=k.useShell?shell.bind(this,1,n,o):quad.bind(this,c,d,n,o),q=textured(p(),m,!1,k.opacity);return q.position.set(e,f,g),q.rotation.set(h,i,j),a.add(q),q.textarea=m,q}function help(a){var b={},c={},d=[];if(a){for(var e in a)0!==e.indexOf("on")||a===navigator&&"onLine"===e?"function"==typeof a[e]?b[e]=a[e]:c[e]=a[e]:d.push(e.substring(2));var f=typeof a;if("function"===f)f=a.toString().match(/(function [^(]*)/)[1];else if("object"===f)if(f=null,a.constructor&&a.constructor.name)f=a.constructor.name;else{for(var g=[{prefix:"",obj:window}],h=[];g.length>0&&null===f;){var i=g.shift();i.___traversed___=!0,h.push(i);for(e in i.obj){var j=i.obj[e];if(j)if("function"==typeof j){if(j.prototype&&a instanceof j){f=i.prefix+e;break}}else j.___tried___||g.push({prefix:i.prefix+e+".",obj:j})}}h.forEach(function(a){delete a.___traversed___})}return a={type:f,events:d,functions:b,properties:c}}console.warn("Object was falsey.")}function randomRange(a,b){return Math.random()*(b-a)+a}function randomInt(a,b,c){c=c||1,void 0===b&&(b=a,a=0);var d=b-a,e=Math.pow(Math.random(),c);return Math.floor(a+e*d)}function randomSteps(a,b,c){return a+randomInt(0,(1+b-a)/c)*c}function isNumber(a){return!isNaN(a)}function copyObject(a,b){for(var c=[{dest:a,source:b}];c.length>0;){var d=c.pop();b=d.source,a=d.dest;for(var e in b)b.hasOwnProperty(e)&&("object"!=typeof b[e]?a[e]=b[e]:(a[e]||(a[e]={}),c.push({dest:a[e],source:b[e]})))}}function inherit(a,b){a.prototype=Object.create(b.prototype),a.prototype.constructor=a}function fireAll(){for(var a=Array.prototype.slice.call(arguments),b=a.shift(),c=this.listeners[b],d=0;d<c.length;++d){var e=c[d];e.apply(e.executionContext||this,a)}}function clearKeyOption(){this.value="",this.dataset.keycode=""}function setKeyOption(a,b,c){this.dataset.keycode=c.keyCode,this.value=this.value||Primrose.Keys[c.keyCode],this.value=this.value.toLocaleLowerCase().replace("arrow",""),this.blur();var d=b.map(function(a){return a.value.toLocaleUpperCase()}).join(", ");10===d.length&&(d=d.replace(/, /g,"")),a.innerHTML=d}function setupKeyOption(a,b,c,d,e){var f=b[c];f.value=d.toLocaleLowerCase(),f.dataset.keycode=e,f.addEventListener("keydown",clearKeyOption),f.addEventListener("keyup",setKeyOption.bind(f,a,b))}function combineDefaults(a,b){var c,d={};for(c in a)d[c]=a[c];for(c in b)d.hasOwnProperty(c)||(d[c]=b[c]);return d}function makeURL(a,b){var c=[];for(var d in b)b.hasOwnProperty(d)&&"function"!=typeof b[d]&&c.push(encodeURIComponent(d)+"="+encodeURIComponent(b[d]));return a+"?"+c.join("&")}function XHR(a,b,c,d,e,f,g){var h=new XMLHttpRequest;h.onerror=e,h.onabort=e,h.onprogress=d,h.onload=function(){h.status<400?f&&f(h.response):e&&e()},h.open(b,a),c&&(h.responseType=c),g?(h.setRequestHeader("Content-Type","application/json;charset=UTF-8"),h.send(JSON.stringify(g))):h.send()}function GET(a,b,c,d,e){b=b||"text";var f=e&&d&&c,g=e&&d||d&&c,h=e||d||c;XHR(a,"GET",b,f,g,h)}function POST(a,b,c,d,e,f){var g=f&&e&&d,h=f&&e||e&&d,i=f||e||d;XHR(a,"POST",c,g,h,i,b)}function getObject(a,b,c,d){var e=d&&c&&b,f=d&&c||c&&b,g=d||c||b;GET(a,"json",e,f,g)}function sendObject(a,b,c,d,e){POST(a,b,"json",e&&d&&c,e&&d||d&&c,e||d||c)}console.clear();var Primrose={Input:{},Output:{},Text:{CodePages:{},CommandPacks:{},Controls:{},Grammars:{},OperatingSystems:{},Renderers:{},Themes:{}},SYS_FONTS:"-apple-system, '.SFNSText-Regular', 'San Francisco', 'Roboto', 'Segoe UI', 'Helvetica Neue', 'Lucida Grande', sans-serif",SKINS:["#FFDFC4","#F0D5BE","#EECEB3","#E1B899","#E5C298","#FFDCB2","#E5B887","#E5A073","#E79E6D","#DB9065","#CE967C","#C67856","#BA6C49","#A57257","#F0C8C9","#DDA8A0","#B97C6D","#A8756C","#AD6452","#5C3836","#CB8442","#BD723C","#704139","#A3866A","#870400","#710101","#430000","#5B0001","#302E2E"]};Primrose.Application=function(){function a(a,b){for(var c=0;c<b.changedTouches.length;++c)a.call(this,b.changedTouches[c],b.changedTouches[c].identifier);b.preventDefault()}function b(b,c,d,e){var f;f=b instanceof String||"string"==typeof b?Array.prototype.slice.call(document.querySelectorAll(b)):[b];for(var g=0;g<f.length;++g)b=f[g],e?b.addEventListener(c,a.bind(b,d),!1):b.addEventListener(c,d.bind(b),!1);return f}function c(a,c,d,e){function f(a,b){void 0===b&&(b=10),10===b&&a.preventDefault();var c=l[b]||{};c.x=a.clientX,c.y=a.clientY,c.rx=a.radiusX,c.ry=a.radiusY,c.b=a.buttons,isFirefox&&void 0!==c.rx&&(c.rx/=3,c.ry/=3),void 0===c.b&&(c.b=1),void 0===c.rx&&(0===c.b?(c.rx=1,c.ry=1):(c.rx=1.5,c.ry=1.5)),l[b]=c}function g(a,b){void 0===b&&(b=10),10===b&&a.preventDefault(),l[b]=null}function h(a){m[a.keyCode]=!0,m.shift=a.shiftKey,m.ctrl=a.ctrlKey,m.alt=a.altKey}function i(a){m[a.keyCode]=!1,m.shift=a.shiftKey,m.ctrl=a.ctrlKey,m.alt=a.altKey}var j=0,k=0,l={},m={},n=function o(b){var d=requestAnimationFrame(o);try{k=b-j,a(k,l,m),c(k)}catch(e){throw cancelAnimationFrame(d),e}j=b};b(e,"mousedown",f),b(e,"mousemove",f),b(e,"mouseup",g),b(e,"mouseout",g),b(e,"touchstart",f,!0),b(e,"touchmove",f,!0),b(e,"touchend",g,!0),b(window,"keydown",h),b(window,"keyup",i),b(window,"resize",d),d(),requestAnimationFrame(requestAnimationFrame.bind(window,n))}return c}(),Primrose.Button=function(){function a(b,c,d){this.options=combineDefaults(d,a),this.options.minDeflection=Math.cos(this.options.minDeflection),this.options.colorUnpressed=new THREE.Color(this.options.colorUnpressed),this.options.colorPressed=new THREE.Color(this.options.colorPressed),this.listeners={click:[]},this.cap=b.children[0],this.cap.name=c,this.cap.isSolid=!0,this.cap.material=this.cap.material.clone(),this.color=this.cap.material.color,this.base=b.children[1],this.name=c,this.toggle=!1,this.value=!1,this.pressed=!1,this.wasPressed=!1}return a.DEFAULTS={maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0,minDistance:2},a.prototype.addEventListener=function(a,b){this.listeners[a]&&this.listeners[a].push(b)},a.prototype.moveBy=function(a,b,c){this.base.position.x+=a,this.base.position.y+=b,this.base.position.z+=c,this.cap.physics.position.x+=a,this.cap.physics.position.y+=b,this.cap.physics.position.z+=c},a.prototype.readContacts=function(a){this.wasPressed=this.pressed,this.pressed=!1;for(var b=0;b<a.length;++b){var c=a[b];if(c.bi.graphics===this.cap||c.bj.graphics===this.cap){this.pressed=!0;break}}this.pressed?(fireAll.call(this),this.color.copy(this.options.colorPressed)):this.color.copy(this.options.colorUnpressed)},a}(),Primrose.ButtonFactory=function(){function a(a,b){this.options=b,"string"==typeof a?Primrose.ModelLoader.loadObject(a,function(a){this.template=a}.bind(this)):this.template=a}var b=0;return a.prototype.create=function(a){var c="button"+ ++b,d=this.template.clone(),e=new Primrose.Button(d,c,this.options);return e.toggle=a,e},a}(),Primrose.ChatApplication=function(){function a(b,c){this.formStateKey=b+" - formState",this.formState=getSetting(this.formStateKey),this.ctrls=findEverything(),this.fullscreenElement=document.documentElement,this.options=combineDefaults(c,a),this.users={},this.chatLines=[],this.userName=a.DEFAULT_USER_NAME,this.focused=!0,this.wasFocused=!1}return a.DEFAULT_USER_NAME="CURRENT_USER_OFFLINE",a.DEFAULTS={},a}(),Primrose.Keys=function(){"use strict";var a={MODIFIER_KEYS:["ctrl","shift","alt","meta","meta_l","meta_r"],SHIFT:16,CTRL:17,ALT:18,META:91,META_L:91,META_R:92,BACKSPACE:8,TAB:9,ENTER:13,SPACE:32,DELETE:46,PAUSEBREAK:19,CAPSLOCK:20,NUMLOCK:144,SCROLLLOCK:145,INSERT:45,ESCAPE:27,PAGEUP:33,PAGEDOWN:34,END:35,HOME:36,LEFTARROW:37,UPARROW:38,RIGHTARROW:39,DOWNARROW:40,SELECTKEY:93,NUMBER0:48,NUMBER1:49,NUMBER2:50,NUMBER3:51,NUMBER4:52,NUMBER5:53,NUMBER6:54,NUMBER7:55,NUMBER8:56,NUMBER9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD0:96,NUMPAD1:97,NUMPAD2:98,NUMPAD3:99,NUMPAD4:100,NUMPAD5:101,NUMPAD6:102,NUMPAD7:103,NUMPAD8:104,NUMPAD9:105,MULTIPLY:106,ADD:107,SUBTRACT:109,DECIMALPOINT:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123};for(var b in a){var c=a[b];a.hasOwnProperty(b)&&"number"==typeof c&&(a[c]=b)}return a}(),Primrose.ModelLoader=function(){function a(a){return a.traverse(function(a){a.geometry&&(a.geometry.computeBoundingSphere(),a.geometry.computeBoundingBox())}),a}function b(a,b){b.buttons=[],b.traverse(function(a){a.isButton&&b.buttons.push(new Primrose.Button(a.parent,a.name)),a.name&&(b[a.name]=a)}),a&&a(b)}function c(a){a.traverse(function(a){if(a instanceof THREE.Mesh)for(var b in f)a[b]=a[b]||f[b](a)})}function d(a,b){if(a){var c=function(a){this.template=a,b&&b(a)}.bind(this);d.loadObject(a,c)}}if("undefined"==typeof THREE)return function(){};var e;THREE.ObjectLoader&&(e=new THREE.ObjectLoader);var f={isButton:function(a){return a.material&&a.material.name.match(/^button\d+$/)},isSolid:function(a){return!a.name.match(/^(water|sky)/)},isGround:function(a){return a.material&&a.material.name&&a.material.name.match(/\bground\b/)}};return d.prototype.clone=function(){var a=this.template.clone();return a.traverse(function(b){b instanceof THREE.SkinnedMesh&&(a.animation=new THREE.Animation(b,b.geometry.animation),!this.template.originalAnimationData&&a.animation.data&&(this.template.originalAnimationData=a.animation.data),a.animation.data||(a.animation.data=this.template.originalAnimationData))}.bind(this)),c(a),a},d.loadScene=function(a,c){var e=b.bind(window,c);d.loadObject(a,e)},d.loadObject=function(b,d){var f=function(a){c(a),d&&d(a)};/\.json$/.test(b)&&(e?(e.setCrossOrigin(THREE.ImageUtils.crossOrigin),e.load(b,function(b){f(a(b))})):console.error("JSON seems to be broken right now"))},d}(),Primrose.NetworkedInput=function(){function a(a,b,c){function d(a){for(var b=0;b<Primrose.Keys.MODIFIER_KEYS.length;++b){var c=Primrose.Keys.MODIFIER_KEYS[b];this.inputState[c]=a[c+"Key"]}}this.name=a,this.commandState={},this.commands=[],this.socket=c,this.enabled=!0,this.paused=!1,this.ready=!0,this.transmitting=!0,this.receiving=!0,this.socketReady=!1,this.inPhysicalUse=!0,this.inputState={},this.lastState="",window.addEventListener("keydown",d.bind(this),!1),window.addEventListener("keyup",d.bind(this),!1),c&&(c.on("open",function(){this.socketReady=!0,this.inPhysicalUse=!this.receiving}.bind(this)),c.on(a,function(a){this.receiving&&(this.inPhysicalUse=!1,this.decodeStateSnapshot(a),this.fireCommands())}.bind(this)),c.on("close",function(){this.inPhysicalUse=!0,this.socketReady=!1}.bind(this)));for(var e=0;e<b.length;++e)this.addCommand(b[e]);for(e=0;e<Primrose.Keys.MODIFIER_KEYS.length;++e)this.inputState[Primrose.Keys.MODIFIER_KEYS[e]]=!1}return a.prototype.addCommand=function(a){a=this.cloneCommand(a),a.repetitions=a.repetitions||1,this.commands.push(a),this.commandState[a.name]={value:null,pressed:!1,wasPressed:!1,fireAgain:!1,lt:0,ct:0,repeatCount:0}},a.prototype.cloneCommand=function(){throw new Error("cloneCommand function must be defined in subclass")},a.prototype.update=function(a){if(this.ready&&this.enabled&&this.inPhysicalUse&&!this.paused){for(var b=0;b<this.commands.length;++b){var c=this.commands[b],d=this.commandState[c.name];if(d.wasPressed=d.pressed,d.pressed=!1,!c.disabled){var e=!0;if(c.metaKeys)for(var f=0;f<c.metaKeys.length&&e;++f){var g=c.metaKeys[f];e=e&&(this.inputState[Primrose.Keys.MODIFIER_KEYS[g.index]]&&!g.toggle||!this.inputState[Primrose.Keys.MODIFIER_KEYS[g.index]]&&g.toggle)}this.evalCommand(c,d,e,a),d.lt+=a,d.lt>=c.dt&&d.repeatCount++,d.fireAgain=d.pressed&&d.lt>=c.dt&&d.repeatCount>=c.repetitions,d.fireAgain&&(d.lt=0,d.repeatCount=0)}}if(this.socketReady&&this.transmitting){var h=this.makeStateSnapshot();h!==this.lastState&&(this.socket.emit(this.name,h),this.lastState=h)}this.fireCommands()}},a.prototype.fireCommands=function(){if(this.ready&&!this.paused)for(var a=0;a<this.commands.length;++a){var b=this.commands[a],c=this.commandState[b.name];c.fireAgain&&b.commandDown&&b.commandDown(),!c.pressed&&c.wasPressed&&b.commandUp&&b.commandUp()}},a.prototype.makeStateSnapshot=function(){for(var a="",b=0;b<this.commands.length;++b){var c=this.commands[b],d=this.commandState[c.name];d&&(a+=fmt("$1:$2",b<<2|(d.pressed?1:0)|(d.fireAgain?2:0),d.value),b<this.commands.length-1&&(a+="|"))}return a},a.prototype.decodeStateSnapshot=function(a){for(var b,c=0;c<this.commands.length;++c){b=this.commands[c];var d=this.commandState[b.name];d.wasPressed=d.pressed}for(var e=a.split("|"),f=0;f<e.length;++f){var g=e[f],h=g.split(":"),i=parseInt(h[0],10),j=0!==(1&i),k=0!==(2&l);i>>=2,b=this.commands[i];var l=parseInt(h[2],10);this.commandState[b.name]={value:parseFloat(h[1]),pressed:j,fireAgain:k}}},a.prototype.setProperty=function(a,b,c){for(var d=0;d<this.commands.length;++d)if(this.commands[d].name===b){this.commands[d][a]=c;break}},a.prototype.addToArray=function(a,b,c){for(var d=0;d<this.commands.length;++d)if(this.commands[d].name===b){this.commands[d][a].push(c);break}},a.prototype.removeFromArray=function(a,b,c){for(var d=-1,e=0;e<this.commands.length;++e){var f=this.commands[e],g=f[a];if(d=g.indexOf(c),f.name===b&&d>-1){g.splice(d,1);break}}},a.prototype.invertInArray=function(a,b,c){for(var d=-1,e=0;e<this.commands.length;++e){var f=this.commands[e],g=f[a];if(d=g.indexOf(c),f.name===b&&d>-1){g[d]*=-1;break}}},a.prototype.pause=function(a){this.paused=a},a.prototype.isPaused=function(){return this.paused},a.prototype.enable=function(a,b){(void 0===b||null===b)&&(b=a,a=null),a?this.setProperty("disabled",a,!b):this.enabled=b},a.prototype.isEnabled=function(a){if(a){for(var b=0;b<this.commands.length;++b)if(this.commands[b].name===a)return!this.commands[b].disabled;return!1}return this.enabled},a.prototype.transmit=function(a){this.transmitting=a},a.prototype.isTransmitting=function(){return this.transmitting},a.prototype.receive=function(a){this.receiving=a},a.prototype.isReceiving=function(){return this.receiving},a}(),Primrose.Projector=function(){function a(a){a&&"undefined"==typeof THREE&&(self.THREE={REVISION:"72dev"},void 0===Math.sign&&(Math.sign=function(a){return 0>a?-1:a>0?1:+a}),void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*(\S*)\s*\(/)[1]}}),THREE.Quaternion=function(a,b,c,d){this._x=a||0,this._y=b||0,this._z=c||0,this._w=void 0!==d?d:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,get x(){return this._x},set x(a){this._x=a,this.onChangeCallback()},get y(){return this._y},set y(a){this._y=a,this.onChangeCallback()},get z(){return this._z},set z(a){this._z=a,this.onChangeCallback()},get w(){return this._w},set w(a){this._w=a,this.onChangeCallback()},set:function(a,b,c,d){return this._x=a,this._y=b,this._z=c,this._w=d,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(a){return this._x=a.x,this._y=a.y,this._z=a.z,this._w=a.w,this.onChangeCallback(),this},setFromEuler:function(a,b){if(a instanceof THREE.Euler==!1)throw new Error("THREE.Quaternion: .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var c=Math.cos(a._x/2),d=Math.cos(a._y/2),e=Math.cos(a._z/2),f=Math.sin(a._x/2),g=Math.sin(a._y/2),h=Math.sin(a._z/2);return"XYZ"===a.order?(this._x=f*d*e+c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e-f*g*h):"YXZ"===a.order?(this._x=f*d*e+c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e+f*g*h):"ZXY"===a.order?(this._x=f*d*e-c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e-f*g*h):"ZYX"===a.order?(this._x=f*d*e-c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e+f*g*h):"YZX"===a.order?(this._x=f*d*e+c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e-f*g*h):"XZY"===a.order&&(this._x=f*d*e-c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e+f*g*h),b!==!1&&this.onChangeCallback(),this},setFromAxisAngle:function(a,b){var c=b/2,d=Math.sin(c);return this._x=a.x*d,this._y=a.y*d,this._z=a.z*d,this._w=Math.cos(c),this.onChangeCallback(),this},setFromRotationMatrix:function(a){var b,c=a.elements,d=c[0],e=c[4],f=c[8],g=c[1],h=c[5],i=c[9],j=c[2],k=c[6],l=c[10],m=d+h+l;return m>0?(b=.5/Math.sqrt(m+1),this._w=.25/b,this._x=(k-i)*b,this._y=(f-j)*b,this._z=(g-e)*b):d>h&&d>l?(b=2*Math.sqrt(1+d-h-l),this._w=(k-i)/b,this._x=.25*b,this._y=(e+g)/b,this._z=(f+j)/b):h>l?(b=2*Math.sqrt(1+h-d-l),this._w=(f-j)/b,this._x=(e+g)/b,this._y=.25*b,this._z=(i+k)/b):(b=2*Math.sqrt(1+l-d-h),this._w=(g-e)/b,this._x=(f+j)/b,this._y=(i+k)/b,this._z=.25*b),this.onChangeCallback(),this},setFromUnitVectors:function(){var a,b,c=1e-6;return function(d,e){return void 0===a&&(a=new THREE.Vector3),b=d.dot(e)+1,c>b?(b=0,Math.abs(d.x)>Math.abs(d.z)?a.set(-d.y,d.x,0):a.set(0,-d.z,d.y)):a.crossVectors(d,e),this._x=a.x,this._y=a.y,this._z=a.z,this._w=b,this.normalize(),this}}(),inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(a){return this._x*a._x+this._y*a._y+this._z*a._z+this._w*a._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var a=this.length();return 0===a?(this._x=0,this._y=0,this._z=0,this._w=1):(a=1/a,this._x=this._x*a,this._y=this._y*a,this._z=this._z*a,this._w=this._w*a),this.onChangeCallback(),this},multiply:function(a,b){return void 0!==b?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(a,b)):this.multiplyQuaternions(this,a)},multiplyQuaternions:function(a,b){var c=a._x,d=a._y,e=a._z,f=a._w,g=b._x,h=b._y,i=b._z,j=b._w;return this._x=c*j+f*g+d*i-e*h,this._y=d*j+f*h+e*g-c*i,this._z=e*j+f*i+c*h-d*g,this._w=f*j-c*g-d*h-e*i,this.onChangeCallback(),this},multiplyVector3:function(a){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),a.applyQuaternion(this)},slerp:function(a,b){if(0===b)return this;if(1===b)return this.copy(a);var c=this._x,d=this._y,e=this._z,f=this._w,g=f*a._w+c*a._x+d*a._y+e*a._z;if(0>g?(this._w=-a._w,this._x=-a._x,this._y=-a._y,this._z=-a._z,g=-g):this.copy(a),g>=1)return this._w=f,this._x=c,this._y=d,this._z=e,this;var h=Math.acos(g),i=Math.sqrt(1-g*g);if(Math.abs(i)<.001)return this._w=.5*(f+this._w),this._x=.5*(c+this._x),this._y=.5*(d+this._y),this._z=.5*(e+this._z),this;var j=Math.sin((1-b)*h)/i,k=Math.sin(b*h)/i;return this._w=f*j+this._w*k,this._x=c*j+this._x*k,this._y=d*j+this._y*k,this._z=e*j+this._z*k,this.onChangeCallback(),this},equals:function(a){return a._x===this._x&&a._y===this._y&&a._z===this._z&&a._w===this._w},fromArray:function(a,b){return void 0===b&&(b=0),this._x=a[b],this._y=a[b+1],this._z=a[b+2],this._w=a[b+3],this.onChangeCallback(),this},toArray:function(a,b){return void 0===a&&(a=[]),void 0===b&&(b=0),a[b]=this._x,a[b+1]=this._y,a[b+2]=this._z,a[b+3]=this._w,a},onChange:function(a){return this.onChangeCallback=a,this},onChangeCallback:function(){}},THREE.Quaternion.slerp=function(a,b,c,d){return c.copy(a).slerp(b,d)},THREE.Vector3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(a,b,c){return this.x=a,this.y=b,this.z=c,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setZ:function(a){return this.z=a,this},setComponent:function(a,b){switch(a){case 0:this.x=b;break;case 1:this.y=b;break;case 2:this.z=b;break;default:throw new Error("index is out of range: "+a)}},getComponent:function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+a)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},add:function(a,b){return void 0!==b?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(a,b)):(this.x+=a.x,this.y+=a.y,this.z+=a.z,this)},addScalar:function(a){return this.x+=a,this.y+=a,this.z+=a,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},addScaledVector:function(a,b){return this.x+=a.x*b,this.y+=a.y*b,this.z+=a.z*b,this},sub:function(a,b){return void 0!==b?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(a,b)):(this.x-=a.x,this.y-=a.y,this.z-=a.z,this)},subScalar:function(a){return this.x-=a,this.y-=a,this.z-=a,this},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},multiply:function(a,b){return void 0!==b?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(a,b)):(this.x*=a.x,this.y*=a.y,this.z*=a.z,this)},multiplyScalar:function(a){return this.x*=a,this.y*=a,this.z*=a,this},multiplyVectors:function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},applyEuler:function(){var a;return function(b){return b instanceof THREE.Euler==!1&&console.error("THREE.Vector3: .applyEuler() now expects a Euler rotation rather than a Vector3 and order."),void 0===a&&(a=new THREE.Quaternion),this.applyQuaternion(a.setFromEuler(b)),this}}(),applyAxisAngle:function(){var a;return function(b,c){return void 0===a&&(a=new THREE.Quaternion),this.applyQuaternion(a.setFromAxisAngle(b,c)),this}}(),applyMatrix3:function(a){var b=this.x,c=this.y,d=this.z,e=a.elements;return this.x=e[0]*b+e[3]*c+e[6]*d,this.y=e[1]*b+e[4]*c+e[7]*d,this.z=e[2]*b+e[5]*c+e[8]*d,this},applyMatrix4:function(a){var b=this.x,c=this.y,d=this.z,e=a.elements;return this.x=e[0]*b+e[4]*c+e[8]*d+e[12],this.y=e[1]*b+e[5]*c+e[9]*d+e[13],this.z=e[2]*b+e[6]*c+e[10]*d+e[14],this},applyProjection:function(a){var b=this.x,c=this.y,d=this.z,e=a.elements,f=1/(e[3]*b+e[7]*c+e[11]*d+e[15]);return this.x=(e[0]*b+e[4]*c+e[8]*d+e[12])*f,this.y=(e[1]*b+e[5]*c+e[9]*d+e[13])*f,this.z=(e[2]*b+e[6]*c+e[10]*d+e[14])*f,this},applyQuaternion:function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z,h=a.w,i=h*b+f*d-g*c,j=h*c+g*b-e*d,k=h*d+e*c-f*b,l=-e*b-f*c-g*d;return this.x=i*h+l*-e+j*-g-k*-f,this.y=j*h+l*-f+k*-e-i*-g,this.z=k*h+l*-g+i*-f-j*-e,this},project:function(){var a;return function(b){return void 0===a&&(a=new THREE.Matrix4),a.multiplyMatrices(b.projectionMatrix,a.getInverse(b.matrixWorld)),this.applyProjection(a)}}(),unproject:function(){var a;return function(b){return void 0===a&&(a=new THREE.Matrix4),a.multiplyMatrices(b.matrixWorld,a.getInverse(b.projectionMatrix)),this.applyProjection(a)}}(),transformDirection:function(a){var b=this.x,c=this.y,d=this.z,e=a.elements;return this.x=e[0]*b+e[4]*c+e[8]*d,this.y=e[1]*b+e[5]*c+e[9]*d,this.z=e[2]*b+e[6]*c+e[10]*d,this.normalize(),this},divide:function(a){return this.x/=a.x,this.y/=a.y,this.z/=a.z,this},divideScalar:function(a){if(0!==a){var b=1/a;this.x*=b,this.y*=b,this.z*=b}else this.x=0,this.y=0,this.z=0;return this},min:function(a){return this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this.z>a.z&&(this.z=a.z),this},max:function(a){return this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this.z<a.z&&(this.z=a.z),this},clamp:function(a,b){return this.x<a.x?this.x=a.x:this.x>b.x&&(this.x=b.x),this.y<a.y?this.y=a.y:this.y>b.y&&(this.y=b.y),this.z<a.z?this.z=a.z:this.z>b.z&&(this.z=b.z),this},clampScalar:function(){var a,b;return function(c,d){return void 0===a&&(a=new THREE.Vector3,b=new THREE.Vector3),a.set(c,c,c),b.set(d,d,d),this.clamp(a,b)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this
},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(a){var b=this.length();return 0!==b&&a!==b&&this.multiplyScalar(a/b),this},lerp:function(a,b){return this.x+=(a.x-this.x)*b,this.y+=(a.y-this.y)*b,this.z+=(a.z-this.z)*b,this},lerpVectors:function(a,b,c){return this.subVectors(b,a).multiplyScalar(c).add(a),this},cross:function(a,b){if(void 0!==b)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(a,b);var c=this.x,d=this.y,e=this.z;return this.x=d*a.z-e*a.y,this.y=e*a.x-c*a.z,this.z=c*a.y-d*a.x,this},crossVectors:function(a,b){var c=a.x,d=a.y,e=a.z,f=b.x,g=b.y,h=b.z;return this.x=d*h-e*g,this.y=e*f-c*h,this.z=c*g-d*f,this},projectOnVector:function(){var a,b;return function(c){return void 0===a&&(a=new THREE.Vector3),a.copy(c).normalize(),b=this.dot(a),this.copy(a).multiplyScalar(b)}}(),projectOnPlane:function(){var a;return function(b){return void 0===a&&(a=new THREE.Vector3),a.copy(this).projectOnVector(b),this.sub(a)}}(),reflect:function(){var a;return function(b){return void 0===a&&(a=new THREE.Vector3),this.sub(a.copy(b).multiplyScalar(2*this.dot(b)))}}(),angleTo:function(a){var b=this.dot(a)/(this.length()*a.length());return Math.acos(THREE.Math.clamp(b,-1,1))},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x,c=this.y-a.y,d=this.z-a.z;return b*b+c*c+d*d},setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(a){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(a)},getScaleFromMatrix:function(a){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(a)},getColumnFromMatrix:function(a,b){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(a,b)},setFromMatrixPosition:function(a){return this.x=a.elements[12],this.y=a.elements[13],this.z=a.elements[14],this},setFromMatrixScale:function(a){var b=this.set(a.elements[0],a.elements[1],a.elements[2]).length(),c=this.set(a.elements[4],a.elements[5],a.elements[6]).length(),d=this.set(a.elements[8],a.elements[9],a.elements[10]).length();return this.x=b,this.y=c,this.z=d,this},setFromMatrixColumn:function(a,b){var c=4*a,d=b.elements;return this.x=d[c],this.y=d[c+1],this.z=d[c+2],this},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z},fromArray:function(a,b){return void 0===b&&(b=0),this.x=a[b],this.y=a[b+1],this.z=a[b+2],this},toArray:function(a,b){return void 0===a&&(a=[]),void 0===b&&(b=0),a[b]=this.x,a[b+1]=this.y,a[b+2]=this.z,a},fromAttribute:function(a,b,c){return void 0===c&&(c=0),b=b*a.itemSize+c,this.x=a.array[b],this.y=a.array[b+1],this.z=a.array[b+2],this}},THREE.Matrix4=function(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this.elements;return q[0]=a,q[4]=b,q[8]=c,q[12]=d,q[1]=e,q[5]=f,q[9]=g,q[13]=h,q[2]=i,q[6]=j,q[10]=k,q[14]=l,q[3]=m,q[7]=n,q[11]=o,q[15]=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new THREE.Matrix4).fromArray(this.elements)},copy:function(a){return this.elements.set(a.elements),this},extractPosition:function(a){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(a)},copyPosition:function(a){var b=this.elements,c=a.elements;return b[12]=c[12],b[13]=c[13],b[14]=c[14],this},extractBasis:function(a,b,c){var d=this.elements;return a.set(d[0],d[1],d[2]),b.set(d[4],d[5],d[6]),c.set(d[8],d[9],d[10]),this},makeBasis:function(a,b,c){return this.set(a.x,b.x,c.x,0,a.y,b.y,c.y,0,a.z,b.z,c.z,0,0,0,0,1),this},extractRotation:function(){var a;return function(b){void 0===a&&(a=new THREE.Vector3);var c=this.elements,d=b.elements,e=1/a.set(d[0],d[1],d[2]).length(),f=1/a.set(d[4],d[5],d[6]).length(),g=1/a.set(d[8],d[9],d[10]).length();return c[0]=d[0]*e,c[1]=d[1]*e,c[2]=d[2]*e,c[4]=d[4]*f,c[5]=d[5]*f,c[6]=d[6]*f,c[8]=d[8]*g,c[9]=d[9]*g,c[10]=d[10]*g,this}}(),makeRotationFromEuler:function(a){a instanceof THREE.Euler==!1&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var b=this.elements,c=a.x,d=a.y,e=a.z,f=Math.cos(c),g=Math.sin(c),h=Math.cos(d),i=Math.sin(d),j=Math.cos(e),k=Math.sin(e);if("XYZ"===a.order){var l=f*j,m=f*k,n=g*j,o=g*k;b[0]=h*j,b[4]=-h*k,b[8]=i,b[1]=m+n*i,b[5]=l-o*i,b[9]=-g*h,b[2]=o-l*i,b[6]=n+m*i,b[10]=f*h}else if("YXZ"===a.order){var p=h*j,q=h*k,r=i*j,s=i*k;b[0]=p+s*g,b[4]=r*g-q,b[8]=f*i,b[1]=f*k,b[5]=f*j,b[9]=-g,b[2]=q*g-r,b[6]=s+p*g,b[10]=f*h}else if("ZXY"===a.order){var p=h*j,q=h*k,r=i*j,s=i*k;b[0]=p-s*g,b[4]=-f*k,b[8]=r+q*g,b[1]=q+r*g,b[5]=f*j,b[9]=s-p*g,b[2]=-f*i,b[6]=g,b[10]=f*h}else if("ZYX"===a.order){var l=f*j,m=f*k,n=g*j,o=g*k;b[0]=h*j,b[4]=n*i-m,b[8]=l*i+o,b[1]=h*k,b[5]=o*i+l,b[9]=m*i-n,b[2]=-i,b[6]=g*h,b[10]=f*h}else if("YZX"===a.order){var t=f*h,u=f*i,v=g*h,w=g*i;b[0]=h*j,b[4]=w-t*k,b[8]=v*k+u,b[1]=k,b[5]=f*j,b[9]=-g*j,b[2]=-i*j,b[6]=u*k+v,b[10]=t-w*k}else if("XZY"===a.order){var t=f*h,u=f*i,v=g*h,w=g*i;b[0]=h*j,b[4]=-k,b[8]=i*j,b[1]=t*k+w,b[5]=f*j,b[9]=u*k-v,b[2]=v*k-u,b[6]=g*j,b[10]=w*k+t}return b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,this},setRotationFromQuaternion:function(a){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(a)},makeRotationFromQuaternion:function(a){var b=this.elements,c=a.x,d=a.y,e=a.z,f=a.w,g=c+c,h=d+d,i=e+e,j=c*g,k=c*h,l=c*i,m=d*h,n=d*i,o=e*i,p=f*g,q=f*h,r=f*i;return b[0]=1-(m+o),b[4]=k-r,b[8]=l+q,b[1]=k+r,b[5]=1-(j+o),b[9]=n-p,b[2]=l-q,b[6]=n+p,b[10]=1-(j+m),b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,this},lookAt:function(){var a,b,c;return function(d,e,f){void 0===a&&(a=new THREE.Vector3),void 0===b&&(b=new THREE.Vector3),void 0===c&&(c=new THREE.Vector3);var g=this.elements;return c.subVectors(d,e).normalize(),0===c.length()&&(c.z=1),a.crossVectors(f,c).normalize(),0===a.length()&&(c.x+=1e-4,a.crossVectors(f,c).normalize()),b.crossVectors(c,a),g[0]=a.x,g[4]=b.x,g[8]=c.x,g[1]=a.y,g[5]=b.y,g[9]=c.y,g[2]=a.z,g[6]=b.z,g[10]=c.z,this}}(),multiply:function(a,b){return void 0!==b?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(a,b)):this.multiplyMatrices(this,a)},multiplyMatrices:function(a,b){var c=a.elements,d=b.elements,e=this.elements,f=c[0],g=c[4],h=c[8],i=c[12],j=c[1],k=c[5],l=c[9],m=c[13],n=c[2],o=c[6],p=c[10],q=c[14],r=c[3],s=c[7],t=c[11],u=c[15],v=d[0],w=d[4],x=d[8],y=d[12],z=d[1],A=d[5],B=d[9],C=d[13],D=d[2],E=d[6],F=d[10],G=d[14],H=d[3],I=d[7],J=d[11],K=d[15];return e[0]=f*v+g*z+h*D+i*H,e[4]=f*w+g*A+h*E+i*I,e[8]=f*x+g*B+h*F+i*J,e[12]=f*y+g*C+h*G+i*K,e[1]=j*v+k*z+l*D+m*H,e[5]=j*w+k*A+l*E+m*I,e[9]=j*x+k*B+l*F+m*J,e[13]=j*y+k*C+l*G+m*K,e[2]=n*v+o*z+p*D+q*H,e[6]=n*w+o*A+p*E+q*I,e[10]=n*x+o*B+p*F+q*J,e[14]=n*y+o*C+p*G+q*K,e[3]=r*v+s*z+t*D+u*H,e[7]=r*w+s*A+t*E+u*I,e[11]=r*x+s*B+t*F+u*J,e[15]=r*y+s*C+t*G+u*K,this},multiplyToArray:function(a,b,c){var d=this.elements;return this.multiplyMatrices(a,b),c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=d[3],c[4]=d[4],c[5]=d[5],c[6]=d[6],c[7]=d[7],c[8]=d[8],c[9]=d[9],c[10]=d[10],c[11]=d[11],c[12]=d[12],c[13]=d[13],c[14]=d[14],c[15]=d[15],this},multiplyScalar:function(a){var b=this.elements;return b[0]*=a,b[4]*=a,b[8]*=a,b[12]*=a,b[1]*=a,b[5]*=a,b[9]*=a,b[13]*=a,b[2]*=a,b[6]*=a,b[10]*=a,b[14]*=a,b[3]*=a,b[7]*=a,b[11]*=a,b[15]*=a,this},multiplyVector3:function(a){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),a.applyProjection(this)},multiplyVector4:function(a){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)},multiplyVector3Array:function(a){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(a)},applyToVector3Array:function(){var a;return function(b,c,d){void 0===a&&(a=new THREE.Vector3),void 0===c&&(c=0),void 0===d&&(d=b.length);for(var e=0,f=c;d>e;e+=3,f+=3)a.fromArray(b,f),a.applyMatrix4(this),a.toArray(b,f);return b}}(),applyToBuffer:function(){var a;return function(b,c,d){void 0===a&&(a=new THREE.Vector3),void 0===c&&(c=0),void 0===d&&(d=b.length/b.itemSize);for(var e=0,f=c;d>e;e++,f++)a.x=b.getX(f),a.y=b.getY(f),a.z=b.getZ(f),a.applyMatrix4(this),b.setXYZ(a.x,a.y,a.z);return b}}(),rotateAxis:function(a){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),a.transformDirection(this)},crossVector:function(a){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)},determinant:function(){var a=this.elements,b=a[0],c=a[4],d=a[8],e=a[12],f=a[1],g=a[5],h=a[9],i=a[13],j=a[2],k=a[6],l=a[10],m=a[14],n=a[3],o=a[7],p=a[11],q=a[15];return n*(+e*h*k-d*i*k-e*g*l+c*i*l+d*g*m-c*h*m)+o*(+b*h*m-b*i*l+e*f*l-d*f*m+d*i*j-e*h*j)+p*(+b*i*k-b*g*m-e*f*k+c*f*m+e*g*j-c*i*j)+q*(-d*g*j-b*h*k+b*g*l+d*f*k-c*f*l+c*h*j)},transpose:function(){var a,b=this.elements;return a=b[1],b[1]=b[4],b[4]=a,a=b[2],b[2]=b[8],b[8]=a,a=b[6],b[6]=b[9],b[9]=a,a=b[3],b[3]=b[12],b[12]=a,a=b[7],b[7]=b[13],b[13]=a,a=b[11],b[11]=b[14],b[14]=a,this},flattenToArrayOffset:function(a,b){var c=this.elements;return a[b]=c[0],a[b+1]=c[1],a[b+2]=c[2],a[b+3]=c[3],a[b+4]=c[4],a[b+5]=c[5],a[b+6]=c[6],a[b+7]=c[7],a[b+8]=c[8],a[b+9]=c[9],a[b+10]=c[10],a[b+11]=c[11],a[b+12]=c[12],a[b+13]=c[13],a[b+14]=c[14],a[b+15]=c[15],a},getPosition:function(){var a;return function(){void 0===a&&(a=new THREE.Vector3),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead.");var b=this.elements;return a.set(b[12],b[13],b[14])}}(),setPosition:function(a){var b=this.elements;return b[12]=a.x,b[13]=a.y,b[14]=a.z,this},getInverse:function(a,b){var c=this.elements,d=a.elements,e=d[0],f=d[4],g=d[8],h=d[12],i=d[1],j=d[5],k=d[9],l=d[13],m=d[2],n=d[6],o=d[10],p=d[14],q=d[3],r=d[7],s=d[11],t=d[15];c[0]=k*p*r-l*o*r+l*n*s-j*p*s-k*n*t+j*o*t,c[4]=h*o*r-g*p*r-h*n*s+f*p*s+g*n*t-f*o*t,c[8]=g*l*r-h*k*r+h*j*s-f*l*s-g*j*t+f*k*t,c[12]=h*k*n-g*l*n-h*j*o+f*l*o+g*j*p-f*k*p,c[1]=l*o*q-k*p*q-l*m*s+i*p*s+k*m*t-i*o*t,c[5]=g*p*q-h*o*q+h*m*s-e*p*s-g*m*t+e*o*t,c[9]=h*k*q-g*l*q-h*i*s+e*l*s+g*i*t-e*k*t,c[13]=g*l*m-h*k*m+h*i*o-e*l*o-g*i*p+e*k*p,c[2]=j*p*q-l*n*q+l*m*r-i*p*r-j*m*t+i*n*t,c[6]=h*n*q-f*p*q-h*m*r+e*p*r+f*m*t-e*n*t,c[10]=f*l*q-h*j*q+h*i*r-e*l*r-f*i*t+e*j*t,c[14]=h*j*m-f*l*m-h*i*n+e*l*n+f*i*p-e*j*p,c[3]=k*n*q-j*o*q-k*m*r+i*o*r+j*m*s-i*n*s,c[7]=f*o*q-g*n*q+g*m*r-e*o*r-f*m*s+e*n*s,c[11]=g*j*q-f*k*q-g*i*r+e*k*r+f*i*s-e*j*s,c[15]=f*k*m-g*j*m+g*i*n-e*k*n-f*i*o+e*j*o;var u=e*c[0]+i*c[4]+m*c[8]+q*c[12];if(0===u){var v="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(b)throw new Error(v);return console.warn(v),this.identity(),this}return this.multiplyScalar(1/u),this},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},scale:function(a){var b=this.elements,c=a.x,d=a.y,e=a.z;return b[0]*=c,b[4]*=d,b[8]*=e,b[1]*=c,b[5]*=d,b[9]*=e,b[2]*=c,b[6]*=d,b[10]*=e,b[3]*=c,b[7]*=d,b[11]*=e,this},getMaxScaleOnAxis:function(){var a=this.elements,b=a[0]*a[0]+a[1]*a[1]+a[2]*a[2],c=a[4]*a[4]+a[5]*a[5]+a[6]*a[6],d=a[8]*a[8]+a[9]*a[9]+a[10]*a[10];return Math.sqrt(Math.max(b,Math.max(c,d)))},makeTranslation:function(a,b,c){return this.set(1,0,0,a,0,1,0,b,0,0,1,c,0,0,0,1),this},makeRotationX:function(a){var b=Math.cos(a),c=Math.sin(a);return this.set(1,0,0,0,0,b,-c,0,0,c,b,0,0,0,0,1),this},makeRotationY:function(a){var b=Math.cos(a),c=Math.sin(a);return this.set(b,0,c,0,0,1,0,0,-c,0,b,0,0,0,0,1),this},makeRotationZ:function(a){var b=Math.cos(a),c=Math.sin(a);return this.set(b,-c,0,0,c,b,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=1-c,f=a.x,g=a.y,h=a.z,i=e*f,j=e*g;return this.set(i*f+c,i*g-d*h,i*h+d*g,0,i*g+d*h,j*g+c,j*h-d*f,0,i*h-d*g,j*h+d*f,e*h*h+c,0,0,0,0,1),this},makeScale:function(a,b,c){return this.set(a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1),this},compose:function(a,b,c){return this.makeRotationFromQuaternion(b),this.scale(c),this.setPosition(a),this},decompose:function(){var a,b;return function(c,d,e){void 0===a&&(a=new THREE.Vector3),void 0===b&&(b=new THREE.Matrix4);var f=this.elements,g=a.set(f[0],f[1],f[2]).length(),h=a.set(f[4],f[5],f[6]).length(),i=a.set(f[8],f[9],f[10]).length(),j=this.determinant();0>j&&(g=-g),c.x=f[12],c.y=f[13],c.z=f[14],b.elements.set(this.elements);var k=1/g,l=1/h,m=1/i;return b.elements[0]*=k,b.elements[1]*=k,b.elements[2]*=k,b.elements[4]*=l,b.elements[5]*=l,b.elements[6]*=l,b.elements[8]*=m,b.elements[9]*=m,b.elements[10]*=m,d.setFromRotationMatrix(b),e.x=g,e.y=h,e.z=i,this}}(),makeFrustum:function(a,b,c,d,e,f){var g=this.elements,h=2*e/(b-a),i=2*e/(d-c),j=(b+a)/(b-a),k=(d+c)/(d-c),l=-(f+e)/(f-e),m=-2*f*e/(f-e);return g[0]=h,g[4]=0,g[8]=j,g[12]=0,g[1]=0,g[5]=i,g[9]=k,g[13]=0,g[2]=0,g[6]=0,g[10]=l,g[14]=m,g[3]=0,g[7]=0,g[11]=-1,g[15]=0,this},makePerspective:function(a,b,c,d){var e=c*Math.tan(THREE.Math.degToRad(.5*a)),f=-e,g=f*b,h=e*b;return this.makeFrustum(g,h,f,e,c,d)},makeOrthographic:function(a,b,c,d,e,f){var g=this.elements,h=b-a,i=c-d,j=f-e,k=(b+a)/h,l=(c+d)/i,m=(f+e)/j;return g[0]=2/h,g[4]=0,g[8]=0,g[12]=-k,g[1]=0,g[5]=2/i,g[9]=0,g[13]=-l,g[2]=0,g[6]=0,g[10]=-2/j,g[14]=-m,g[3]=0,g[7]=0,g[11]=0,g[15]=1,this},equals:function(a){for(var b=this.elements,c=a.elements,d=0;16>d;d++)if(b[d]!==c[d])return!1;return!0},fromArray:function(a){return this.elements.set(a),this},toArray:function(){var a=this.elements;return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]}},THREE.Math={generateUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=new Array(36),d=0;return function(){for(var e=0;36>e;e++)8===e||13===e||18===e||23===e?c[e]="-":14===e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19===e?3&a|8:a]);return c.join("")}}(),clamp:function(a,b,c){return b>a?b:a>c?c:a},clampBottom:function(a,b){return b>a?b:a},euclideanModulo:function(a,b){return(a%b+b)%b},mapLinear:function(a,b,c,d,e){return d+(a-b)*(e-d)/(c-b)},smoothstep:function(a,b,c){return b>=a?0:a>=c?1:(a=(a-b)/(c-b),a*a*(3-2*a))},smootherstep:function(a,b,c){return b>=a?0:a>=c?1:(a=(a-b)/(c-b),a*a*a*(a*(6*a-15)+10))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(a,b){return a+Math.floor(Math.random()*(b-a+1))},randFloat:function(a,b){return a+Math.random()*(b-a)},randFloatSpread:function(a){return a*(.5-Math.random())},degToRad:function(){var a=Math.PI/180;return function(b){return b*a}}(),radToDeg:function(){var a=180/Math.PI;return function(b){return b*a}}(),isPowerOfTwo:function(a){return 0===(a&a-1)&&0!==a},nextPowerOfTwo:function(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}}),this.objectIDs=[],this.objects={},this.transformCache={},this.vertCache={},this.a=new THREE.Vector3,this.b=new THREE.Vector3,this.c=new THREE.Vector3,this.d=new THREE.Vector3,this.f=new THREE.Vector3,this.p=new THREE.Vector3,this.m=new THREE.Matrix4,this.listeners={hit:[]}}return a.prototype.addEventListener=function(a,b){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(b)},a.prototype._fire=fireAll,a.prototype._transform=function(a,b){return b.clone().applyMatrix4(a.matrix)},a.prototype._getVerts=function(a){var b=Array.prototype.join.call(a.matrix.elements,",");if(b!==this.transformCache[a.uuid]){var c=[];this.vertCache[a.uuid]=c;for(var d=a.geometry.vertices,e=0;e<d.length;++e)c[e]=this._transform(a,d[e]);this.transformCache[a.uuid]=b}return this.vertCache[a.uuid]},a.prototype.setObject=function(a){this.objects[a.uuid]?(this.setProperty(a.uuid,"geometry.faces",a.geometry.faces),this.setProperty(a.uuid,"geometry.faceVertexUvs",a.geometry.faceVertexUvs)):(this.objectIDs.push(a.uuid),this.objects[a.uuid]=a),this.setProperty(a.uuid,"geometry.vertices",a.geometry.vertices),this.updateObject(a)},a.prototype.updateObject=function(a){for(var b=a,c=new THREE.Matrix4,d=(new THREE.Matrix4).identity();null!==b;)c.fromArray(b.matrix),d.multiply(c),b=b.parent;this.setProperty(a.uuid,"matrix",d),this.setProperty(a.uuid,"visible",a.visible),delete a.parent},a.prototype.setProperty=function(a,b,c){for(var d=this.objects[a],e=b.split(".");e.length>1;)b=e.shift(),d[b]||(d[b]={}),d=d[b];1===e.length&&(b=e[0],"vertices"===b&&(c=c.map(function(a){return(new THREE.Vector3).fromArray(a)})),d[e[0]]=c)},a.prototype.projectPointer=function(a,b){var c=null;this.p.fromArray(a),this.f.fromArray(b);for(var d=0;d<this.objectIDs.length;++d){var e=this.objectIDs[d],f=this.objects[e];if(f.visible)for(var g=this._getVerts(f),h=f.geometry.faces,i=0;i<h.length;++i){var j=h[i],k=i%2===1,l=g[k?j[1]:j[0]],m=g[k?j[2]:j[1]],n=g[k?j[0]:j[2]];if(this.a.subVectors(m,l),this.b.subVectors(n,l),this.c.subVectors(this.p,this.f),this.m.set(this.a.x,this.b.x,-this.c.x,0,this.a.y,this.b.y,-this.c.y,0,this.a.z,this.b.z,-this.c.z,0,0,0,0,1),0!==this.m.determinant()&&(this.m.getInverse(this.m),this.d.subVectors(this.f,l).applyMatrix4(this.m),this.d.x>=0&&this.d.x<=1&&this.d.y>=0&&this.d.y<=1&&this.d.z>0)){this.c.multiplyScalar(this.d.z).add(this.f);var o=Math.sign(this.d.z)*this.p.distanceTo(this.c);if(!c||o<c.distance){var p=f.geometry.faceVertexUvs[0][i];l=p[k?1:0],m=p[k?2:1],n=p[k?0:2];var q=[this.d.x*(m[0]-l[0])+this.d.y*(n[0]-l[0])+l[0],this.d.x*(m[1]-l[1])+this.d.y*(n[1]-l[1])+l[1]];this.d.crossVectors(this.a.normalize(),this.b.normalize()),c={objectID:e,distance:o,facePoint:this.c.toArray(),faceNormal:this.d.toArray(),point:q}}}}}this._fire("hit",c)},a.prototype._displayVector=function(a,b){return b=b||3,a.toArray().map(function(a){return parseFloat(a.toFixed(b))})},a}(),Primrose.StateList=function(){function a(a,b,c,d,e){for(var f=cascadeElement(a,"select",HTMLSelectElement),g=0;g<c.length;++g){var h=document.createElement("option");h.appendChild(document.createTextNode(c[g].name)),f.appendChild(h)}f.addEventListener("change",function(){var a=c[f.selectedIndex].values;if(void 0!==a){for(var e in a)if(a.hasOwnProperty(e)){var g=a[e];for(var h in g)g.hasOwnProperty(h)&&(b[e][h]=g[h])}d&&d()}}.bind(this),!1),this.DOMElement=f,e&&e.appendChild(this.DOMElement)}return a}(),Primrose.VRApplication=function(){function a(h,i){function j(){var a=this.renderer.domElement.getBoundingClientRect(),b=a.width,c=a.height,d=window.devicePixelRatio||1,e=75,f=b*d,g=c*d,h=f;if(this.inVR){var i=this.input.vr.params,j=i.left,k=i.right;f=j.renderRect.width+k.renderRect.width,g=Math.max(j.renderRect.height,k.renderRect.height),h=f/2,e=j.recommendedFieldOfView.leftDegrees+j.recommendedFieldOfView.rightDegrees}this.renderer.domElement.width=f,this.renderer.domElement.height=g,this.renderer.setViewport(0,0,f,g),this.renderer.setScissor(0,0,f,g),this.camera&&(this.camera.fov=e,this.camera.aspect=h/g,this.camera.updateProjectionMatrix())}function k(a){if(q=a,this.camera&&this.scene&&this.buttonFactory&&this.buttonFactory.template){if(j.call(this),this.scene.add(this.currentUser),this.scene.add(this.pointer),this.currentUser.add(this.camera),this.camera.near=.01,this.camera.far=2*this.options.drawDistance,this.camera.add(this.nose),this.camera.add(light(16777215,1,2,.5)),this.options.useFog&&(this.scene.fog=new THREE.FogExp2(this.options.backgroundColor,2/this.options.drawDistance)),this.options.skyTexture&&(this.sky=textured(shell(this.options.drawDistance,18,9,2*Math.PI,Math.PI),this.options.skyTexture,!0),this.sky.name="Sky",this.scene.add(this.sky)),this.options.groundTexture){var b=2*this.options.drawDistance,c=new THREE.PlaneGeometry(b,b,b,b);this.ground=textured(c,this.options.groundTexture,!1,1,b,b),this.ground.rotation.x=Math.PI/2,this.ground.name="Ground",this.scene.add(this.ground),this.registerPickableObject(this.ground)}this.passthrough&&this.camera.add(this.passthrough.mesh),fireAll.call(this,"ready"),requestAnimationFrame(z)}else requestAnimationFrame(k.bind(this))}function l(a){for(var b={uuid:a.uuid,visible:a.visible,name:a.name},c=b,d=a;null!==d;)d.updateMatrix(),b.matrix=d.matrix.elements.subarray(0,d.matrix.elements.length),b.parent=d.parent?{}:null,b=b.parent,d=d.parent;return c}function m(a){var b=a.position.clone();for(a=a.parent;null!==a;)b.applyMatrix4(a.matrix),a=a.parent;return b.toArray()}function n(a,b){"string"==typeof b&&(b=document.createTextNode(b));var c=document.createElement("td");c.appendChild(b),a.appendChild(c)}function o(){return new THREE.PerspectiveCamera(45,1,.1,this.options.drawDistance)}function p(){this.inVR=isFullScreenMode()&&r&&this.input.vr.display,isFullScreenMode()||"#fullscreen"!==location.hash||(location.hash=""),j.call(this)}this.options=combineDefaults(i,a.DEFAULTS),Primrose.ChatApplication.call(this,h,this.options),this.listeners={ready:[],update:[]};var q=0,r=!1,s=null,t=0,u=new THREE.Quaternion,v=new THREE.Quaternion,w=new THREE.Quaternion,x=Primrose.SKINS[randomInt(Primrose.SKINS.length)],y=parseInt(x.substring(1),16);this.onground=!0,this.inVR=!1,this.currentEditor=null,this.avatarHeight=this.options.avatarHeight,this.walkSpeed=this.options.walkSpeed,this.audio=new Primrose.Output.Audio3D,this.music=new Primrose.Output.Music(this.audio.context),this.currentUser=new THREE.Object3D,this.pointer=textured(sphere(e,10,10),16711680),this.nose=textured(sphere(.05,10,10),y),this.buttons=[],this.pickableObjects=[],this.projector=new Primrose.Workerize(Primrose.Projector),this.input=new Primrose.Input.FPSInput(this.ctrls.frontBuffer),this.currentUser.velocity=new THREE.Vector3,this.currentUser.position.set(0,this.avatarHeight,0),this.pointer.material.emissive.setRGB(.25,0,0),this.pointer.material.opacity=.75,this.nose.name="Nose",this.nose.scale.set(.5,1,1),this.projector.ready=!0,this.setupModuleEvents=function(a,b,c){var d=c+"Enable",e=c+"Transmit",f=c+"Receive",g=document.createElement("input"),h=document.createElement("input"),i=document.createElement("input"),j=document.createElement("tr");if(this.ctrls[d]=g,this.ctrls[e]=h,this.ctrls[f]=i,g.id=d,h.id=e,i.id=f,g.type=h.type=i.type="checkbox",g.checked=this.formState[d],h.checked=this.formState[e],i.checked=this.formState[f],g.addEventListener("change",function(a,b){b.enable(this.checked),a.disabled=!this.checked,a.checked&&a.disabled&&(a.checked=!1)}.bind(g,h,b)),h.addEventListener("change",function(a){a.transmit(this.checked)}.bind(h,b)),i.addEventListener("change",function(a){a.receive(this.checked)}.bind(i,b)),a.appendChild(j),n(j,c),n(j,g),n(j,h),n(j,i),b.zeroAxes){var k=c+"Zero",l=document.createElement("input");this.ctrls[k]=l,l.id=k,l.type="checkbox",l.checked=this.formState[k],l.addEventListener("click",b.zeroAxes.bind(b),!1),n(j,l)}else i.colspan=2;b.enable(g.checked),b.transmit(h.checked),b.receive(i.checked),h.disabled=!g.checked,h.checked&&h.disabled&&(h.checked=!1)},this.start=function(){requestAnimationFrame(k.bind(this))},this.stop=function(){cancelAnimationFrame(this.timer)},this.goFullScreen=function(a){this.input.mouse.requestPointerLock(),isFullScreenMode()||(r=a,a&&this.input.vr.display?requestFullScreen(this.ctrls.frontBuffer,this.input.vr.display):requestFullScreen(this.ctrls.frontBuffer),history.pushState(null,document.title,"#fullscreen"))},this.addEventListener=function(a,b,c){this.listeners[a]?this.listeners[a].push(b):g.indexOf(a)>=0&&window.addEventListener(a,b,c)},this.zero=function(){this.currentEditor||(this.currentUser.position.set(0,this.avatarHeight,0),this.currentUser.velocity.set(0,0,0)),this.inVR&&this.input.vr.sensor.resetSensor()},this.jump=function(){this.onground&&!this.currentEditor&&(this.currentUser.velocity.y+=this.options.jumpHeight,this.onground=!1)},this.createElement=function(a,b){if("textarea"===a||"pre"===a){var c="textarea"===a?Primrose.Text.Grammars.JavaScript:Primrose.Text.Grammars.PlainText,d=makeEditor(this.scene,b,1,1,0,0,0,0,0,0,{tokenizer:c,useShell:!0,keyEventSource:window,wheelEventSource:this.renderer.domElement,theme:Primrose.Text.Themes.Default,hideLineNumbers:"pre"===a,readOnly:"pre"===a});return this.registerPickableObject(d),d}},this.convertToEditor=function(a){var b=new Primrose.Text.Controls.TextBox("textEditor",{size:new Primrose.Text.Size(1024,1024),fontSize:32,tokenizer:Primrose.Text.Grammars.Basic,theme:Primrose.Text.Themes.Dark,keyEventSource:window,wheelEventSource:this.renderer.domElement,hideLineNumbers:!0});return textured(a,b),a.textarea=b,this.registerPickableObject(a),a},this.registerPickableObject=function(a){if("Object3D"===a.type&&(a.children[0].name=a.children[0].name||a.name,a=a.children[0]),a){var b=l(a);b.geometry={vertices:a.geometry.vertices.map(function(a){return a.toArray()}),faces:a.geometry.faces.map(function(a){return[a.a,a.b,a.c]}),faceVertexUvs:a.geometry.faceVertexUvs.map(function(a){return a.map(function(a){return a.map(function(a){return a.toArray()})})})},this.pickableObjects.push(a),this.projector.setObject(b)}},this.findObject=function(a){for(var b=0;b<this.pickableObjects.length;++b)if(this.pickableObjects[b].uuid===a)return this.pickableObjects[b]};var z=function(a){this.timer=requestAnimationFrame(z);var g,h,i,j=.001*(a-q),k=0,n=0,o=0,p=0;if(q=a,this.input.update(j),k=this.input.getValue("heading"),o=this.input.getValue("strafe"),p=this.input.getValue("drive"),n=this.input.getValue("pitch"),this.input.getQuaternion("headRX","headRY","headRZ","headRW",w),u.setFromAxisAngle(b,n),this.nose.visible=this.inVR&&!isMobile,this.onground?(!this.currentEditor||this.currentEditor.readOnly)&&(o||p?(g=p*p+o*o,g=this.walkSpeed/Math.max(1,Math.sqrt(g))):g=0,o*=g*j,p*=g*j,v.setFromAxisAngle(c,t),this.currentUser.velocity.set(o,0,p),isMobile&&(this.currentUser.velocity.applyQuaternion(w),this.currentUser.velocity.y=0),this.currentUser.velocity.applyQuaternion(v)):this.currentUser.velocity.y-=this.options.gravity*j,this.currentUser.position.add(this.currentUser.velocity),!this.onground&&this.currentUser.position.y<this.avatarHeight&&(this.onground=!0,this.currentUser.position.y=this.avatarHeight,this.currentUser.velocity.y=0),this.sky&&this.sky.position.copy(this.currentUser.position),this.ground&&(this.ground.position.set(Math.floor(this.currentUser.position.x),.5,Math.floor(this.currentUser.position.z)),this.ground.material.needsUpdate=!0),!this.inVR||isMobile)t=k,this.currentUser.quaternion.setFromAxisAngle(c,t),isMobile||this.currentUser.quaternion.multiply(u);else{var r=k-t;if(!this.currentEditor&&Math.abs(r)>Math.PI/5){var x=Math.sign(r)*Math.PI/100;t+=x,k-=x,r=k-t}this.currentUser.quaternion.setFromAxisAngle(c,t),v.setFromAxisAngle(c,r).multiply(u)}if(this.pointer.position.copy(d),this.inVR&&!isMobile&&this.pointer.position.applyQuaternion(v),(!this.currentEditor||isMobile)&&(this.pointer.position.add(this.camera.position),this.pointer.position.applyQuaternion(this.camera.quaternion)),this.pointer.position.applyQuaternion(this.currentUser.quaternion),this.pointer.position.add(this.currentUser.position),this.projector.ready){for(this.projector.ready=!1,h=0;h<this.pickableObjects.length;++h)this.projector.updateObject(l(this.pickableObjects[h]));this.projector.projectPointer(this.pointer.position.toArray(),m(this.currentUser))}var y=this.input.getValue("dButtons");if(s){var A=s.facePoint,B=s.faceNormal;this.pointer.position.set(A[0]+B[0]*e,A[1]+B[1]*e,A[2]+B[2]*e),this.pointer.material.color.setRGB(1,1,1),this.pointer.material.emissive.setRGB(.25,.25,.25);var C=this.findObject(s.objectID);if(C){var D=this.input.getValue("buttons"),E=y>0,F=C.textarea;if(F?this.pointer.scale.set(1,1,1):this.pointer.scale.set(f,f,f),E&&D>0&&(this.currentEditor&&this.currentEditor!==F&&(this.currentEditor.blur(),this.currentEditor=null),!this.currentEditor&&F?(this.currentEditor=F,this.currentEditor.focus()):C===this.ground&&(this.currentUser.position.set(A[0]+B[0]*this.avatarHeight,A[1]+B[1]*this.avatarHeight,A[2]+B[2]*this.avatarHeight),this.currentUser.position.y=this.avatarHeight,this.onground=!1)),this.currentEditor){var G=C.material.map.image,H=Math.floor(G.width*s.point[0]),I=Math.floor(G.height*(1-s.point[1]));!E&&D>0?this.currentEditor.movePointer(H,I):E&&D>0?this.currentEditor.startPointer(H,I):this.currentEditor.endPointer()}}}else this.currentEditor&&y>0&&(this.currentEditor.blur(),this.currentEditor=null),this.pointer.material.color.setRGB(1,0,0),this.pointer.material.emissive.setRGB(.25,0,0),this.pointer.scale.set(1,1,1);for(fireAll.call(this,"update",j),i=0;i<this.pickableObjects.length;++i)this.pickableObjects[i].textarea&&this.pickableObjects[i].textarea.render();if(this.inVR&&this.input.vr.params)for(h=0;h<this.input.vr.transforms.length;++h){var J=this.input.vr.transforms[h],K=J.transform,L=J.viewport,M=2*h-1;this.input.getVector3("headX","headY","headZ",this.camera.position),this.camera.position.applyMatrix4(K),this.camera.quaternion.copy(w),this.camera.position.applyQuaternion(this.camera.quaternion),this.nose.position.set(M*-.12,-.12,-.15),this.nose.rotation.z=.7*M,this.renderer.setViewport(L.left,L.top,L.width,L.height),this.renderer.setScissor(L.left,L.top,L.width,L.height),this.renderer.render(this.scene,this.camera)}else this.camera.position.set(0,0,0),this.camera.quaternion.set(0,0,0,1),this.renderer.render(this.scene,this.camera)}.bind(this);this.renderer=new THREE.WebGLRenderer({canvas:this.ctrls.frontBuffer,antialias:!isMobile,alpha:!isMobile,logarithmicDepthBuffer:!isMobile}),this.renderer.autoSortObjects=!isMobile,this.renderer.enableScissorTest(!0),this.renderer.setClearColor(this.options.backgroundColor),this.options.sceneModel?Primrose.ModelLoader.loadScene(this.options.sceneModel,function(a){this.scene=a,this.camera=this.scene.Camera||o.call(this),this.scene.Camera=this.camera}.bind(this)):(this.scene=new THREE.Scene,this.camera=o.call(this),this.scene.Camera=this.camera),this.buttonFactory=this.options.button?new Primrose.ButtonFactory(this.options.button.model,this.options.button.options):new Primrose.ButtonFactory(brick(16711680,1,1,1),{maxThrow:.1,minDeflection:10,colorUnpressed:8323072,colorPressed:32512,toggle:!0}),this.input.addEventListener("jump",this.jump.bind(this),!1),this.input.addEventListener("zero",this.zero.bind(this),!1),this.projector.addEventListener("hit",function(a){this.projector.ready=!0,s=a
}.bind(this)),writeForm(this.ctrls,this.formState),window.addEventListener("beforeunload",function(){var a=readForm(this.ctrls);setSetting(this.formStateKey,a)}.bind(this),!1),window.addEventListener("popstate",function(a){isFullScreenMode()&&(exitFullScreen(),a.preventDefault())},!0),window.addEventListener("fullscreenchange",p.bind(this),!1),window.addEventListener("webkitfullscreenchange",p.bind(this),!1),window.addEventListener("mozfullscreenchange",p.bind(this),!1),window.addEventListener("resize",j.bind(this),!1),this.options.disableAutoFullScreen||(window.addEventListener("mousedown",this.goFullScreen.bind(this,!0),!1),window.addEventListener("touchstart",this.goFullScreen.bind(this,!0),!1))}if("undefined"==typeof THREE)return function(){};var b=new THREE.Vector3(1,0,0),c=new THREE.Vector3(0,1,0),d=new THREE.Vector3(0,0,-1),e=.01,f=20,g=["keydown","keyup","keypress","mousedown","mouseup","mousemove","wheel","touchstart","touchend","touchmove"];return inherit(a,Primrose.ChatApplication),a.DEFAULTS={useLeap:!1,useFog:!1,avatarHeight:1.75,walkSpeed:3,gravity:.98,jumpHeight:.25,backgroundColor:11517951,drawDistance:50,chatTextSize:.25,dtNetworkUpdate:.125},a}(),Primrose.WebRTCSocket=function(){function a(a,b){function c(a,b,c){c.fromIndex=a,c.toIndex=b,g[b].setLocalDescription(c,function(){f.emit(c.type,c)})}function d(a,b,c){if(b.fromIndex===a){var d=new RTCSessionDescription(b);g[a].setRemoteDescription(d,c)}}function e(a){function b(){h[a]=null,g[a]=null;var b=0===h.filter(function(a){return a}).length;if(b&&i.close)for(var c=0;c<i.close.length;++c){var d=i.close[c];d&&d.call(this)}}h[a].addEventListener("open",function(){if(i.open)for(var a=0;a<i.open.length;++a){var b=i.open[a];b&&b.call(this)}},!1),h[a].addEventListener("message",function(a){var b=JSON.parse(a.data),c=b.shift();if(i[c])for(var d=0;d<i[c].length;++d){var e=i[c][d];e&&e.apply(this,b)}},!1),h[a].addEventListener("error",b,!1),h[a].addEventListener("close",b,!1)}var f,g=[],h=[],i={},j=null;if("string"==typeof a)f=io.connect(a,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":60});else{if(!(a&&a.on&&a.emit))throw console.error("proxy error",f),new Error("need a socket");f=a}this.on=function(a,b){i[a]||(i[a]=[]),i[a].push(b)},this.emit=function(){for(var a=JSON.stringify(Array.prototype.slice.call(arguments)),b=0;b<h.length;++b){var c=h[b];c&&"open"===c.readyState&&c.send(a)}},this.close=function(){h.forEach(function(a){a&&"open"===a.readyState&&a.close()}),g.forEach(function(a){a&&a.close()})},window.addEventListener("unload",this.close.bind(this)),this.connect=function(a){f.emit("handshake","peer"),f.on("handshakeComplete",function(b){"peer"===b&&f.emit("joinRequest",a)})},f.on("user",function(a,i){try{if(null===j&&(j=a),!g[i]){var k=new RTCPeerConnection({iceServers:["stun.l.google.com:19302","stun1.l.google.com:19302","stun2.l.google.com:19302","stun3.l.google.com:19302","stun4.l.google.com:19302"].map(function(a){return{url:"stun:"+a}})});if(g[i]=k,k.addEventListener("icecandidate",function(a){a.candidate&&(a.candidate.fromIndex=j,a.candidate.toIndex=i,f.emit("ice",a.candidate))},!1),f.on("ice",function(a){a.fromIndex===i&&g[i].addIceCandidate(new RTCIceCandidate(a))}),b===!0||void 0===b&&i>j){k.addEventListener("negotiationneeded",function(){k.createOffer(c.bind(this,j,i),console.error.bind(console,"createOffer error"))});var l=k.createDataChannel("data-channel-"+j+"-to-"+i,{id:j,ordered:!1,maxRetransmits:0});h[i]=l,e(i),f.on("answer",function(a){a.fromIndex===i&&d(i,a)})}else(b===!1||void 0===b&&j>i)&&(k.addEventListener("datachannel",function(a){a.channel.id===i&&(h[a.channel.id]=a.channel,e(i))},!1),f.on("offer",function(a){a.fromIndex===i&&d(i,a,function(){g[i].createAnswer(c,console.error.bind(console,"createAnswer error"))})}))}}catch(m){console.error(m)}})}return Window.prototype.RTCPeerConnection=Window.prototype.RTCPeerConnection||Window.prototype.webkitRTCPeerConnection||Window.prototype.mozRTCPeerConnection||function(){},Window.prototype.RTCIceCandidate=Window.prototype.RTCIceCandidate||Window.prototype.mozRTCIceCandidate||function(){},Window.prototype.RTCSessionDescription=Window.prototype.RTCSessionDescription||Window.prototype.mozRTCSessionDescription||function(){},a}(),Primrose.Workerize=function(){function a(b){var c,d=b.toString(),e=d.match(/function\s+(\w+)\s*\(/),f=e[1];for(c in b.prototype)d+="\n\n"+f+".prototype."+c+" = "+b.prototype[c].toString()+";";d+="\n\n(function(){\n  var instance = new "+f+"(true);",d+="\n  if(instance.addEventListener){\n    for(var k in instance.listeners) {\n      instance.addEventListener(k, function(){\n        var args = Array.prototype.slice.call(arguments);\n        postMessage(args);\n      }.bind(this, k));\n    }\n  }",d+="\n\n  onmessage = function(evt){\n    var f = evt.data.shift();\n    if(instance[f]){\n      instance[f].apply(instance, evt.data);\n    }\n  }\n\n})();",this.worker=a.createWorker(d,!1),this.listeners={},this.worker.onmessage=function(a){var b=a.data.shift();this.listeners[b]&&this.listeners[b].forEach(function(b){return b.apply(this,a.data)})}.bind(this);for(c in b.prototype)"addEventListener"!==c&&"_"!==c[0]&&(this[c]=this.methodShim.bind(this,c))}return a.prototype.methodShim=function(){var a=Array.prototype.slice.call(arguments);this.worker.postMessage(a)},a.prototype.addEventListener=function(a,b){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(b)},a.createWorker=function(a){var b=arguments.length<=1||void 0===arguments[1]?!0:arguments[1];if("function"==typeof a&&(a=a.toString()),b){a=a.trim();var c=a.indexOf("{");a=a.substring(c+1,a.length-1)}var d=new Blob([a],{type:"text/javascript"}),e=URL.createObjectURL(d);return new Worker(e)},a}();var isMobile=function(a){return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substring(0,4))}(navigator.userAgent||navigator.vendor||window.opera),isiOS=/Apple-iP(hone|od|ad)/.test(navigator.userAgent||""),isOSX=/Macintosh/.test(navigator.userAgent||""),isWindows=/Windows/.test(navigator.userAgent||""),isOpera=!!window.opera||navigator.userAgent.indexOf(" OPR/")>=0,isFirefox="undefined"!=typeof window.InstallTrigger,isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,isChrome=!!window.chrome&&!isOpera,isIE=!1||!!document.documentMode,fmt=function(){function a(a,b){return b.replace(/( AM| PM|$)/,function(b,c){return(a.getMilliseconds()/1e3).toString().substring(1)+c})}function b(b){var c=/\$(0*)(\d+)(?:\.(0+))?/g,d=arguments;return"string"!=typeof b&&(b=b.toString()),b.replace(c,function(b,c,e,f){if(e=parseInt(e,10),e>=0&&e<d.length){var g=d[e];if(null!==g&&void 0!==g){if(g instanceof Date&&f){switch(f.length){case 1:g=g.getYear();break;case 2:g=g.getMonth()+1+"/"+g.getYear();break;case 3:g=g.toLocaleDateString();break;case 4:g=a(g,g.toLocaleTimeString());break;case 5:case 6:g=g.toLocaleString();break;default:g=a(g,g.toLocaleString())}return g}if(g=f&&f.length>0?sigfig(g,f.length):g.toString(),c&&c.length>0)for(var h=new RegExp("^\\d{"+(c.length+1)+"}(\\.\\d+)?");!h.test(g);)g="0"+g;return g}}return void 0})}return b}(),px=fmt.bind(this,"$1px"),pct=fmt.bind(this,"$1%"),ems=fmt.bind(this,"$1em"),rgb=fmt.bind(this,"rgb($1, $2, $3)"),rgba=fmt.bind(this,"rgba($1, $2, $3, $4)"),hsl=fmt.bind(this,"hsl($1, $2, $3)"),hsla=fmt.bind(this,"hsla($1, $2, $3, $4)");"undefined"!=typeof window.THREE&&(InsideSphereGeometry.prototype=Object.create(THREE.Geometry.prototype),InsideSphereGeometry.prototype.constructor=InsideSphereGeometry);var TAU=2*Math.PI;!function(){var a=Function.prototype.bind;Function.prototype.bind=function(){var b=a.apply(this,arguments);return b.executionContext=arguments[0],b}}(),Primrose.Input.ButtonAndAxis=function(){function a(a,b,c,d){Primrose.NetworkedInput.call(this,a,b,c),this.inputState.axes=[],this.inputState.buttons=[],this.axisNames=d||[],this.commandNames=this.commands.map(function(a){return a.name});for(var e=0;e<this.axisNames.length;++e)this.inputState.axes[e]=0;this.setDeadzone=this.setProperty.bind(this,"deadzone"),this.setScale=this.setProperty.bind(this,"scale"),this.setDT=this.setProperty.bind(this,"dt"),this.setMin=this.setProperty.bind(this,"min"),this.setMax=this.setProperty.bind(this,"max"),this.addMetaKey=this.addToArray.bind(this,"metaKeys"),this.addAxis=this.addToArray.bind(this,"axes"),this.addButton=this.addToArray.bind(this,"buttons"),this.removeMetaKey=this.removeFromArray.bind(this,"metaKeys"),this.removeAxis=this.removeFromArray.bind(this,"axes"),this.removeButton=this.removeFromArray.bind(this,"buttons"),this.invertAxis=this.invertInArray.bind(this,"axes"),this.invertButton=this.invertInArray.bind(this,"buttons"),this.invertMetaKey=this.invertInArray.bind(this,"metaKeys")}return inherit(a,Primrose.NetworkedInput),a.inherit=function(b){inherit(b,a),b.AXES&&b.AXES.forEach(function(a,c){b[a]=c+1})},a.prototype.getAxis=function(a){var b=this.axisNames.indexOf(a);if(b>-1){var c=this.inputState.axes[b]||0;return c}return null},a.prototype.setAxis=function(a,b){var c=this.axisNames.indexOf(a);c>-1&&(this.inPhysicalUse=!0,this.inputState.axes[c]=b)},a.prototype.setButton=function(a,b){this.inPhysicalUse=!0,this.inputState.buttons[a]=b},a.prototype.getValue=function(a){var b=this.commandNames.indexOf(a);return(this.enabled||this.receiving&&this.socketReady)&&b>-1&&!this.commands[b].disabled&&this.commandState[a]&&this.commandState[a].value||this.getAxis(a)||0},a.prototype.getVector3=function(a,b,c,d){return d=d||new THREE.Vector3,d.set(this.getValue(a),this.getValue(b),this.getValue(c)),d},a.prototype.addVector3=function(a,b,c,d){return d.x+=this.getValue(a),d.y+=this.getValue(b),d.z+=this.getValue(c),d},a.prototype.isDown=function(a){var b=this.commandNames.indexOf(a);return(this.enabled||this.receiving&&this.socketReady)&&b>-1&&!this.commands[b].disabled&&this.commandState[a]&&this.commandState[a].pressed},a.prototype.isUp=function(a){var b=this.commandNames.indexOf(a);return(this.enabled||this.receiving&&this.socketReady)&&b>-1&&!this.commands[b].disabled&&this.commandState[a]&&!this.commandState[a].pressed},a.prototype.maybeClone=function(a){var b=[];if(a)for(var c=0;c<a.length;++c)b[c]={index:Math.abs(a[c])-1,toggle:a[c]<0,sign:a[c]<0?-1:1};return b},a.prototype.cloneCommand=function(a){return{name:a.name,disabled:!!a.disabled,dt:a.dt||0,deadzone:a.deadzone||0,threshold:a.threshold||0,repetitions:a.repetitions||1,scale:a.scale,offset:a.offset,min:a.min,max:a.max,integrate:a.integrate||!1,delta:a.delta||!1,axes:this.maybeClone(a.axes),commands:a.commands&&a.commands.slice()||[],buttons:this.maybeClone(a.buttons),metaKeys:this.maybeClone(a.metaKeys&&a.metaKeys.map(function(a){for(var b=0;b<Primrose.Keys.MODIFIER_KEYS.length;++b){var c=Primrose.Keys.MODIFIER_KEYS[b];if(Math.abs(a)===Primrose.Keys[c.toLocaleUpperCase()])return Math.sign(a)*(b+1)}}.bind(this))),commandDown:a.commandDown,commandUp:a.commandUp}},a.prototype.evalCommand=function(a,b,c,d){if(c){var e,f,g=!0,h=0;if(a.buttons)for(e=0;e<a.buttons.length;++e){var i=a.buttons[e],j=!!this.inputState.buttons[i.index+1];f=j?i.sign:0,g=g&&(j&&!i.toggle||!j&&i.toggle),Math.abs(f)>Math.abs(h)&&(h=f)}if(a.axes)for(e=0;e<a.axes.length;++e){var k=a.axes[e];f=k.sign*this.inputState.axes[k.index],Math.abs(f)>Math.abs(h)&&(h=f)}for(e=0;e<a.commands.length;++e)f=this.getValue(a.commands[e]),Math.abs(f)>Math.abs(h)&&(h=f);if(void 0!==a.scale&&(h*=a.scale),void 0!==a.offset&&(h+=a.offset),a.deadzone&&Math.abs(h)<a.deadzone&&(h=0),a.integrate)h=this.getValue(a.name)+h*d;else if(a.delta){var l=h;void 0!==b.lv&&(h-=b.lv),b.lv=l}void 0!==a.min&&(h=Math.max(a.min,h)),void 0!==a.max&&(h=Math.min(a.max,h)),a.threshold&&(g=g&&h>a.threshold),b.pressed=g,b.value=h}},a}(),Primrose.Input.Camera=function(){function a(b,c,d,e,f,g,h){MediaStreamTrack.getSources(function(a){var d=document.createElement("option");d.value="",d.innerHTML="-- select camera --",b.appendChild(d);for(var e=0;e<a.length;++e)"video"===a[e].kind&&(d=document.createElement("option"),d.value=a[e].id,d.innerHTML=fmt("[Facing: $1] [ID: $2...]",a[e].facing||"N/A",a[e].id.substring(0,8)),d.selected=a[e].id===c,b.appendChild(d))}),this.options=combineDefaults(h,a),this.videoElement=document.createElement("video"),this.buffer=document.createElement("canvas"),this.gfx=this.buffer.getContext("2d"),this.texture=new THREE.Texture(this.buffer);var i=new THREE.MeshBasicMaterial({map:this.texture,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading});this.gfx.width=500,this.gfx.height=500,this.gfx.fillStyle="white",this.gfx.fillRect(0,0,500,500);var j=new THREE.PlaneGeometry(d,d);j.computeBoundingBox(),j.computeVertexNormals(),this.mesh=new THREE.Mesh(j,i),this.mesh.position.set(e,f,g),this.streaming=!1,this.videoElement.autoplay=1;var k=function(a,b,c){navigator.getUserMedia({video:a},function(a){streamURL=window.URL.createObjectURL(a),this.videoElement.src=streamURL,b()}.bind(this),c)}.bind(this),l=function(a,b,c){if(c=c||0,this.options.videoModes&&c<this.options.videoModes.length){var d=this.options.videoModes[c],e={optional:[{sourceId:a}]};"default"!==d&&(e.mandatory={minWidth:d.w,minHeight:d.h},d=fmt("[w:$1, h:$2]",d.w,d.h)),k(e,function(){console.log(fmt("Connected to camera at mode $1.",d))},function(b){console.error(fmt("Failed to connect at mode $1. Reason: $2",d,b)),l(a,b,c+1)})}else b("no video modes specified.")}.bind(this);this.videoElement.addEventListener("canplay",function(){this.streaming||(this.streaming=!0)}.bind(this),!1),this.videoElement.addEventListener("playing",function(){this.videoElement.height=this.buffer.height=this.videoElement.videoHeight,this.videoElement.width=this.buffer.width=this.videoElement.videoWidth;var a=this.videoElement.videoWidth/this.videoElement.videoHeight;this.mesh.scale.set(a,1,1)}.bind(this),!1),this.connect=function(a){if(this.streaming)try{window.stream&&window.stream.stop(),this.videoElement.src=null,this.streaming=!1}catch(b){console.error("While stopping",b)}l(a,function(a){console.error(fmt("Couldn't connect at requested resolutions. Reason: $1",a)),k(!0,console.log.bind(console,"Connected to camera at default resolution"),console.error.bind(console,"Final connect attempt"))})}.bind(this),c&&this.connect(c)}return Navigator.prototype.getUserMedia=Navigator.prototype.getUserMedia||Navigator.prototype.webkitGetUserMedia||Navigator.prototype.mozGetUserMedia||Navigator.prototype.msGetUserMedia||Navigator.prototype.oGetUserMedia||function(){},a.DEFAULTS={videoModes:[{w:320,h:240},{w:640,h:480},"default"]},a.prototype.update=function(){this.gfx.drawImage(this.videoElement,0,0),this.texture.needsUpdate=!0},a}(),Primrose.Input.FPSInput=function(){function a(a){a=a||window,this.listeners={jump:[],zero:[]},this.managers=[new Primrose.Input.Keyboard("keyboard",window,[{name:"strafeLeft",buttons:[-Primrose.Input.Keyboard.A,-Primrose.Input.Keyboard.LEFTARROW]},{name:"strafeRight",buttons:[Primrose.Input.Keyboard.D,Primrose.Input.Keyboard.RIGHTARROW]},{name:"strafe",commands:["strafeLeft","strafeRight"]},{name:"driveForward",buttons:[-Primrose.Input.Keyboard.W,-Primrose.Input.Keyboard.UPARROW]},{name:"driveBack",buttons:[Primrose.Input.Keyboard.S,Primrose.Input.Keyboard.DOWNARROW]},{name:"drive",commands:["driveForward","driveBack"]},{name:"jump",buttons:[Primrose.Input.Keyboard.SPACEBAR],metaKeys:[-Primrose.Input.Keyboard.SHIFT],commandDown:fireAll.bind(this,"jump"),dt:.5},{name:"zero",buttons:[Primrose.Input.Keyboard.Z],commandUp:fireAll.bind(this,"zero")}]),new Primrose.Input.Mouse("mouse",a,[{name:"buttons",axes:[Primrose.Input.Mouse.BUTTONS]},{name:"dButtons",axes:[Primrose.Input.Mouse.BUTTONS],delta:!0},{name:"dx",axes:[-Primrose.Input.Mouse.X],delta:!0,scale:.5},{name:"heading",commands:["dx"],integrate:!0},{name:"dy",axes:[-Primrose.Input.Mouse.Y],delta:!0,scale:.5},{name:"pitch",commands:["dy"],integrate:!0,min:.5*-Math.PI,max:.5*Math.PI},{name:"pointerPitch",commands:["dy"],integrate:!0,min:.25*-Math.PI,max:.25*Math.PI}]),new Primrose.Input.Touch("touch",a,[{name:"buttons",axes:[Primrose.Input.Touch.FINGERS]},{name:"dButtons",axes:[Primrose.Input.Touch.FINGERS],delta:!0}]),new Primrose.Input.Gamepad("gamepad",[{name:"strafe",axes:[Primrose.Input.Gamepad.LSX]},{name:"drive",axes:[Primrose.Input.Gamepad.LSY]},{name:"heading",axes:[-Primrose.Input.Gamepad.RSX],integrate:!0},{name:"dheading",commands:["heading"],delta:!0},{name:"pitch",axes:[Primrose.Input.Gamepad.RSY],integrate:!0}]),new Primrose.Input.VR("vr")],this.managers.reduce(function(a,b){return a[b.name]=b,a},this),this.connectGamepad=function(a){!this.gamepad.isGamepadSet()&&confirm(fmt('Would you like to use this gamepad? "$1"',a))&&this.gamepad.setGamepad(a)},this.gamepad.addEventListener("gamepadconnected",this.connectGamepad.bind(this),!1)}a.prototype.update=function(a){for(var b=0;b<this.managers.length;++b)this.managers[b].update(a)},a.prototype.addEventListener=function(a,b,c){this.listeners[a]?this.listeners[a].push(b):this.managers.forEach(function(d){d.addEventListener&&d.addEventListener(a,b,c)})},a.prototype.getValue=function(a){for(var b=0,c=0;c<this.managers.length;++c)b+=this.managers[c].getValue(a);return b},a.prototype.getVector3=function(a,b,c,d){d=d||new THREE.Vector3,d.set(0,0,0);for(var e=0;e<this.managers.length;++e)this.managers[e].addVector3(a,b,c,d);return d},a.prototype.getVector3s=function(a,b,c,d){d=d||[];for(var e=0;e<this.managers.length;++e)d[e]=this.managers[e].getVector3(a,b,c,d[e]);return d};var b=new THREE.Quaternion;return a.prototype.getQuaternion=function(a,c,d,e,f){f=f||new THREE.Quaternion,f.set(0,0,0,1);for(var g=0;g<this.managers.length;++g){var h=this.managers[g];h.getQuaternion&&(h.getQuaternion(a,c,d,e,b),f.multiply(b))}return f},a}(),Primrose.Input.Gamepad=function(){function a(b,c,d,e){function f(a,b){var c=a.indexOf(b);c>-1&&a.splice(c,1)}function g(a,b){for(var c=0;c<a.length;++c)a[c](b)}function h(a){g(k.gamepadconnected,a)}function i(a){g(k.gamepaddisconnected,a)}Primrose.Input.ButtonAndAxis.call(this,b,c,d,a.AXES,!0);var j=[],k={gamepadconnected:[],gamepaddisconnected:[]};this.superUpdate=this.update,this.checkDevice=function(b){var c;for(c=0;c<b.buttons.length;++c)this.setButton(c,b.buttons[c].pressed);for(c=0;c<b.axes.length;++c)this.setAxis(a.AXES[c],b.axes[c])},this.update=function(a){var b,c,d=[];if(navigator.getGamepads?b=navigator.getGamepads():navigator.webkitGetGamepads&&(b=navigator.webkitGetGamepads()),b)for(c=0;c<b.length;++c){var f=b[c];f&&(-1===j.indexOf(f.id)&&(j.push(f.id),h(f.id)),f.id===e&&this.checkDevice(f),d.push(f.id))}for(c=j.length-1;c>=0;--c)-1===d.indexOf(j[c])&&(i(j[c]),j.splice(c,1));this.superUpdate(a)},this.getErrorMessage=function(){return errorMessage},this.setGamepad=function(a){e=a,this.inPhysicalUse=!0},this.clearGamepad=function(){e=null,this.inPhysicalUse=!1},this.isGamepadSet=function(){return!!e},this.getConnectedGamepads=function(){return j.slice()},this.addEventListener=function(a,b){k[a]&&k[a].push(b),"gamepadconnected"===a&&j.forEach(h)},this.removeEventListener=function(a,b){k[a]&&f(k[a],b)};try{this.update(0),available=!0}catch(l){avaliable=!1,errorMessage=l}}return a.AXES=["LSX","LSY","RSX","RSY"],Primrose.Input.ButtonAndAxis.inherit(a),a}(),Primrose.Input.Keyboard=function(){function a(b,c,d,e){function f(a,b){return function(a){j=!0,l="",m=0,k=a,k(!1,"|"),this.enable(!1)}.bind(a,b.commandUp)}function g(b,c){if(j&&b)if(c.keyCode===a.ENTER||c.keyCode===a.ESCAPE)j=!1,c.keyCode===a.ENTER&&k(!0,l),k(!1,null),this.enable(!0);else{var d=c.keyCode;d===a.BACKSPACE?(l=l.substring(0,m-1)+l.substring(m),--m):d===a.DELETE?l=l.substring(0,m)+l.substring(m+1):d===a.LEFTARROW?--m:d===a.RIGHTARROW?++m:d===a.HOME?m=0:d===a.END?m=l.length:c.shiftKey&&a.UPPERCASE[d]?(l=l.substring(0,m)+a.UPPERCASE[d]+l.substring(m),++m):!c.shiftKey&&a.LOWERCASE[d]?(l=l.substring(0,m)+a.LOWERCASE[d]+l.substring(m),++m):console.log(c.keyCode),m=Math.max(0,Math.min(l.length,m)),k(!1,l.substring(0,m)+"|"+l.substring(m)),c.preventDefault()}else this.setButton(c.keyCode,b)}c=c||window;for(var h=0;h<d.length;++h){var i=d[h];i.preamble&&(i.commandUp=f(this,i.commandUp))}Primrose.Input.ButtonAndAxis.call(this,b,d,e);var j=!1,k=null,l=null,m=null;c.addEventListener("keydown",g.bind(this,!0),!1),c.addEventListener("keyup",g.bind(this,!1),!1)}return Primrose.Input.ButtonAndAxis.inherit(a),a.BACKSPACE=8,a.TAB=9,a.ENTER=13,a.SHIFT=16,a.CTRL=17,a.ALT=18,a.PAUSEBREAK=19,a.CAPSLOCK=20,a.ESCAPE=27,a.SPACEBAR=32,a.PAGEUP=33,a.PAGEDOWN=34,a.END=35,a.HOME=36,a.LEFTARROW=37,a.UPARROW=38,a.RIGHTARROW=39,a.DOWNARROW=40,a.INSERT=45,a.DELETE=46,a.NUMBER0=48,a.NUMBER1=49,a.NUMBER2=50,a.NUMBER3=51,a.NUMBER4=52,a.NUMBER5=53,a.NUMBER6=54,a.NUMBER7=55,a.NUMBER8=56,a.NUMBER9=57,a.A=65,a.B=66,a.C=67,a.D=68,a.E=69,a.F=70,a.G=71,a.H=72,a.I=73,a.J=74,a.K=75,a.L=76,a.M=77,a.N=78,a.O=79,a.P=80,a.Q=81,a.R=82,a.S=83,a.T=84,a.U=85,a.V=86,a.W=87,a.X=88,a.Y=89,a.Z=90,a.LEFTWINDOWKEY=91,a.RIGHTWINDOWKEY=92,a.SELECTKEY=93,a.NUMPAD0=96,a.NUMPAD1=97,a.NUMPAD2=98,a.NUMPAD3=99,a.NUMPAD4=100,a.NUMPAD5=101,a.NUMPAD6=102,a.NUMPAD7=103,a.NUMPAD8=104,a.NUMPAD9=105,a.MULTIPLY=106,a.ADD=107,a.SUBTRACT=109,a.DECIMALPOINT=110,a.DIVIDE=111,a.F1=112,a.F2=113,a.F3=114,a.F4=115,a.F5=116,a.F6=117,a.F7=118,a.F8=119,a.F9=120,a.F10=121,a.F11=122,a.F12=123,a.NUMLOCK=144,a.SCROLLLOCK=145,a.SEMICOLON=186,a.EQUALSIGN=187,a.COMMA=188,a.DASH=189,a.PERIOD=190,a.FORWARDSLASH=191,a.GRAVEACCENT=192,a.OPENBRACKET=219,a.BACKSLASH=220,a.CLOSEBRACKET=221,a.SINGLEQUOTE=222,a.LOWERCASE={},a.LOWERCASE[a.A]="a",a.LOWERCASE[a.B]="b",a.LOWERCASE[a.C]="c",a.LOWERCASE[a.D]="d",a.LOWERCASE[a.E]="e",a.LOWERCASE[a.F]="f",a.LOWERCASE[a.G]="g",a.LOWERCASE[a.H]="h",a.LOWERCASE[a.I]="i",a.LOWERCASE[a.J]="j",a.LOWERCASE[a.K]="k",a.LOWERCASE[a.L]="l",a.LOWERCASE[a.M]="m",a.LOWERCASE[a.N]="n",a.LOWERCASE[a.O]="o",a.LOWERCASE[a.P]="p",a.LOWERCASE[a.Q]="q",a.LOWERCASE[a.R]="r",a.LOWERCASE[a.S]="s",a.LOWERCASE[a.T]="t",a.LOWERCASE[a.U]="u",a.LOWERCASE[a.V]="v",a.LOWERCASE[a.W]="w",a.LOWERCASE[a.X]="x",a.LOWERCASE[a.Y]="y",a.LOWERCASE[a.Z]="z",a.LOWERCASE[a.SPACEBAR]=" ",a.LOWERCASE[a.NUMBER0]="0",a.LOWERCASE[a.NUMBER1]="1",a.LOWERCASE[a.NUMBER2]="2",a.LOWERCASE[a.NUMBER3]="3",a.LOWERCASE[a.NUMBER4]="4",a.LOWERCASE[a.NUMBER5]="5",a.LOWERCASE[a.NUMBER6]="6",a.LOWERCASE[a.NUMBER7]="7",a.LOWERCASE[a.NUMBER8]="8",a.LOWERCASE[a.NUMBER9]="9",a.LOWERCASE[a.MULTIPLY]="*",a.LOWERCASE[a.ADD]="+",a.LOWERCASE[a.SUBTRACT]="-",a.LOWERCASE[a.DECIMALPOINT]=".",a.LOWERCASE[a.DIVIDE]="/",a.LOWERCASE[a.SEMICOLON]=";",a.LOWERCASE[a.EQUALSIGN]="=",a.LOWERCASE[a.COMMA]=",",a.LOWERCASE[a.DASH]="-",a.LOWERCASE[a.PERIOD]=".",a.LOWERCASE[a.FORWARDSLASH]="/",a.LOWERCASE[a.GRAVEACCENT]="`",a.LOWERCASE[a.OPENBRACKET]="[",a.LOWERCASE[a.BACKSLASH]="\\",a.LOWERCASE[a.CLOSEBRACKET]="]",a.LOWERCASE[a.SINGLEQUOTE]="'",a.UPPERCASE={},a.UPPERCASE[a.A]="A",a.UPPERCASE[a.B]="B",a.UPPERCASE[a.C]="C",a.UPPERCASE[a.D]="D",a.UPPERCASE[a.E]="E",a.UPPERCASE[a.F]="F",a.UPPERCASE[a.G]="G",a.UPPERCASE[a.H]="H",a.UPPERCASE[a.I]="I",a.UPPERCASE[a.J]="J",a.UPPERCASE[a.K]="K",a.UPPERCASE[a.L]="L",a.UPPERCASE[a.M]="M",a.UPPERCASE[a.N]="N",a.UPPERCASE[a.O]="O",a.UPPERCASE[a.P]="P",a.UPPERCASE[a.Q]="Q",a.UPPERCASE[a.R]="R",a.UPPERCASE[a.S]="S",a.UPPERCASE[a.T]="T",a.UPPERCASE[a.U]="U",a.UPPERCASE[a.V]="V",a.UPPERCASE[a.W]="W",a.UPPERCASE[a.X]="X",a.UPPERCASE[a.Y]="Y",a.UPPERCASE[a.Z]="Z",a.UPPERCASE[a.SPACEBAR]=" ",a.UPPERCASE[a.NUMBER0]=")",a.UPPERCASE[a.NUMBER1]="!",a.UPPERCASE[a.NUMBER2]="@",a.UPPERCASE[a.NUMBER3]="#",a.UPPERCASE[a.NUMBER4]="$",a.UPPERCASE[a.NUMBER5]="%",a.UPPERCASE[a.NUMBER6]="^",a.UPPERCASE[a.NUMBER7]="&",a.UPPERCASE[a.NUMBER8]="*",a.UPPERCASE[a.NUMBER9]="(",a.UPPERCASE[a.MULTIPLY]="*",a.UPPERCASE[a.ADD]="+",a.UPPERCASE[a.SUBTRACT]="-",a.UPPERCASE[a.DECIMALPOINT]=".",a.UPPERCASE[a.DIVIDE]="/",a.UPPERCASE[a.SEMICOLON]=":",a.UPPERCASE[a.EQUALSIGN]="+",a.UPPERCASE[a.COMMA]="<",a.UPPERCASE[a.DASH]="_",a.UPPERCASE[a.PERIOD]=">",a.UPPERCASE[a.FORWARDSLASH]="?",a.UPPERCASE[a.GRAVEACCENT]="~",a.UPPERCASE[a.OPENBRACKET]="{",a.UPPERCASE[a.BACKSLASH]="|",a.UPPERCASE[a.CLOSEBRACKET]="}",a.UPPERCASE[a.SINGLEQUOTE]='"',a}(),Primrose.Input.LeapMotion=function(){function a(b,c,d){this.isStreaming=!1,Primrose.Input.ButtonAndAxis.call(this,b,c,d,a.AXES),this.controller=new Leap.Controller({enableGestures:!0})}return a.COMPONENTS=["X","Y","Z"],a.NUM_HANDS=2,a.NUM_FINGERS=10,a.FINGER_PARTS=["tip","dip","pip","mcp","carp"],a.AXES=["X0","Y0","Z0","X1","Y1","Z1","FINGER0TIPX","FINGER0TIPY","FINGER0DIPX","FINGER0DIPY","FINGER0PIPX","FINGER0PIPY","FINGER0MCPX","FINGER0MCPY","FINGER0CARPX","FINGER0CARPY","FINGER1TIPX","FINGER1TIPY","FINGER1DIPX","FINGER1DIPY","FINGER1PIPX","FINGER1PIPY","FINGER1MCPX","FINGER1MCPY","FINGER1CARPX","FINGER1CARPY","FINGER2TIPX","FINGER2TIPY","FINGER2DIPX","FINGER2DIPY","FINGER2PIPX","FINGER2PIPY","FINGER2MCPX","FINGER2MCPY","FINGER2CARPX","FINGER2CARPY","FINGER3TIPX","FINGER3TIPY","FINGER3DIPX","FINGER3DIPY","FINGER3PIPX","FINGER3PIPY","FINGER3MCPX","FINGER3MCPY","FINGER3CARPX","FINGER3CARPY","FINGER4TIPX","FINGER4TIPY","FINGER4DIPX","FINGER4DIPY","FINGER4PIPX","FINGER4PIPY","FINGER4MCPX","FINGER4MCPY","FINGER4CARPX","FINGER4CARPY","FINGER5TIPX","FINGER5TIPY","FINGER5DIPX","FINGER5DIPY","FINGER5PIPX","FINGER5PIPY","FINGER5MCPX","FINGER5MCPY","FINGER5CARPX","FINGER5CARPY","FINGER6TIPX","FINGER6TIPY","FINGER6DIPX","FINGER6DIPY","FINGER6PIPX","FINGER6PIPY","FINGER6MCPX","FINGER6MCPY","FINGER6CARPX","FINGER6CARPY","FINGER7TIPX","FINGER7TIPY","FINGER7DIPX","FINGER7DIPY","FINGER7PIPX","FINGER7PIPY","FINGER7MCPX","FINGER7MCPY","FINGER7CARPX","FINGER7CARPY","FINGER8TIPX","FINGER8TIPY","FINGER8DIPX","FINGER8DIPY","FINGER8PIPX","FINGER8PIPY","FINGER8MCPX","FINGER8MCPY","FINGER8CARPX","FINGER8CARPY","FINGER9TIPX","FINGER9TIPY","FINGER9DIPX","FINGER9DIPY","FINGER9PIPX","FINGER9PIPY","FINGER9MCPX","FINGER9MCPY","FINGER9CARPX","FINGER9CARPY"],Primrose.Input.ButtonAndAxis.inherit(a),a.CONNECTION_TIMEOUT=5e3,a.prototype.E=function(a,b){b?this.controller.on(a,b):this.controller.on(a,console.log.bind(console,"Leap Motion Event: "+a))},a.prototype.start=function(b){if(this.isEnabled()){var c=null,d=null;if(b){var e=function(a){requestAnimationFrame(e),b(a)};d=requestAnimationFrame.bind(window,e);var f=setTimeout(d,a.CONNECTION_TIMEOUT);c=function(){clearTimeout(f),this.isStreaming=!0}.bind(this),this.E("deviceStreaming",c),this.E("streamingStarted",c),this.E("streamingStopped",d)}this.E("connect"),this.E("deviceStopped"),this.E("disconnect"),this.E("frame",this.setState.bind(this,b)),this.controller.connect()}},a.prototype.setState=function(b,c){var d,e,f=this.controller.history.get(1);if(!f||c.hands.length!==f.hands.length)for(d=0;d<this.commands.length;++d)this.enable(this.commands[d].name,c.hands.length>0);for(d=0;d<c.hands.length;++d){var g=c.hands[d].palmPosition,h="HAND"+d;for(e=0;e<a.COMPONENTS.length;++e)this.setAxis(h+a.COMPONENTS[e],g[e])}for(d=0;d<c.fingers.length;++d){var i=c.fingers[d],j="FINGER"+d;for(e=0;e<a.FINGER_PARTS.length;++e)for(var k=i[a.FINGER_PARTS[e]+"Position"],l=j+a.FINGER_PARTS[e].toUpperCase(),m=0;m<a.COMPONENTS.length;++m)this.setAxis(l+a.COMPONENTS[m],k[m])}b&&b(.001*c.timestamp)},a}(),Primrose.Input.Location=function(){function a(b,c,d,e){this.options=combineDefaults(e,a),Primrose.Input.ButtonAndAxis.call(this,b,c,d,a.AXES),this.available=!!navigator.geolocation,this.available&&navigator.geolocation.watchPosition(this.setState.bind(this),function(){this.available=!1}.bind(this),this.options)}return a.AXES=["LONGITUDE","LATITUDE","ALTITUDE","HEADING","SPEED"],Primrose.Input.ButtonAndAxis.inherit(a),a.DEFAULTS={enableHighAccuracy:!0,maximumAge:3e4,timeout:25e3},a.prototype.setState=function(b){for(var c in b.coords){var d=c.toUpperCase();a.AXES.indexOf(d)>-1&&this.setAxis(d,b.coords[c])}},a}(),Primrose.Input.Motion=function(){function a(a){if("number"!=typeof a)throw new Error("Angle must be initialized with a number. Initial value was: "+a);var b,c,d,e=a,f=0,g=Math.PI/180,h=180/Math.PI;this.setDegrees=function(a){do b=a+f-e,c=Math.abs(b+360),d=Math.abs(b-360),b=Math.abs(b),b>c&&d>c?f+=360:b>d&&(f-=360);while(b>c||b>d);e=a+f},this.getDegrees=function(){return e},this.getRadians=function(){return this.getDegrees()*g},this.setRadians=function(a){this.setDegrees(a*h)}}function b(c){function d(a){for(;0>a;)a+=360;for(;a>=360;)a-=360;return a}function e(){f&&g&&(s=Math.abs(f.x),t=Math.abs(f.y),u=Math.abs(f.z),v=s>0?f.x/s:1,w=t>0?f.y/t:1,x=u>0?f.z/u:1,s>t&&s>u&&s>4.5?y=-1===v:t>u&&t>s&&t>4.5&&(y=1===w),z=c?y?g.gamma>0:g.gamma<0:1===x,i=c&&z^!y||!c&&y?270:90,y?z?(m=1,l=-90,p=-1,o=0):(c?(m=1,l=90):(m=-1,l=90),p=1,o=180):z?(m=-1,l=-90,p=1,o=0):(c?(m=-1,l=90):(m=1,l=90),p=-1,o=180),k=d(j*g.alpha+i-B.alpha),n=d(m*g.gamma+l-B.gamma)-360,-180>n&&(n+=360),q=d(p*g.beta+o-B.beta),q>180&&(q-=360))}var f,g,h,i,j,k,l,m,n,o,p,q,s,t,u,v,w,x,y,z,A={x:0,y:0,z:0},B={alpha:0,beta:0,gamma:0};j=-1,this.setAcceleration=function(a){f=a,e()},this.setOrientation=function(a){g=a,e()},this.setRotation=function(a){h=a},this.getRotation=function(){return h},this.getAcceleration=function(){return f},this.getOrientation=function(){return g},this.getHeading=function(){return k},this.getPitch=function(){return n},this.getRoll=function(){return q},this.zeroAxes=function(){f&&(A.x=f.x,A.y=f.y,A.z=f.z),g&&(B.alpha=g.alpha,B.beta=g.beta,B.gamma=g.gamma)},this.addEventListener=function(c,d,e){if("deviceorientation"!==c)throw new Error('The only event type that is supported is "deviceorientation". Type parameter was: '+c);if("function"!=typeof d)throw new Error("A function must be provided as a callback parameter. Callback parameter was: "+d);var f,g,h=new a(0),i=new a(0),j=new a(0),k=new a(0),l=new a(0),m=new a(0);this.onChange=function(){f=this.getOrientation(),g=this.getAcceleration(),r=this.getRotation(),f&&g&&r&&(h.setDegrees(this.getHeading()),i.setDegrees(this.getPitch()),j.setDegrees(this.getRoll()),k.setDegrees(r.alpha),l.setDegrees(r.beta),m.setDegrees(r.gamma),d({HEADING:h.getRadians(),PITCH:i.getRadians(),ROLL:j.getRadians(),D_HEADING:k.getRadians(),D_PITCH:l.getRadians(),D_ROLL:m.getRadians(),ACCELX:g.x-A.x,ACCELY:g.y-A.y,ACCELZ:g.z-A.z}))
},this.checkOrientation=function(a){this.setOrientation(null!==a.alpha&&a),this.onChange()},this.checkMotion=function(a){a&&a.accelerationIncludingGravity&&a.accelerationIncludingGravity.x?this.setAcceleration(a.accelerationIncludingGravity):a&&a.acceleration&&a.acceleration.x&&this.setAcceleration(a.acceleration),a.rotationRate&&this.setRotation(a.rotationRate),this.onChange()},this.setAcceleration(b.ZERO_VECTOR),this.setOrientation(b.ZERO_EULER),window.addEventListener("deviceorientation",this.checkOrientation.bind(this),e),window.addEventListener("devicemotion",this.checkMotion.bind(this),e)}}function c(a,d,e){Primrose.Input.ButtonAndAxis.call(this,a,d,e,c.AXES);var f=new b(b.BROWSER_IS_GOOGLE_CHROME);f.addEventListener("deviceorientation",function(a){for(var b=0;b<c.AXES.length;++b){var d=c.AXES[b];this.setAxis(d,a[d])}}.bind(this)),this.zeroAxes=f.zeroAxes.bind(f)}return b.ZERO_VECTOR={x:-9.80665,y:0,z:0},b.ZERO_EULER={gamma:90,alpha:270,beta:0},b.BROWSER_IS_GOOGLE_CHROME=!!window.chrome&&!window.opera&&navigator.userAgent.indexOf(" OPR/")<0,c.AXES=["HEADING","PITCH","ROLL","D_HEADING","D_PITCH","D_ROLL","ACCELX","ACCELY","ACCELZ"],Primrose.Input.ButtonAndAxis.inherit(c),c}(),Primrose.Input.Mouse=function(){function a(b,c,d,e){c=c||window,Primrose.Input.ButtonAndAxis.call(this,b,d,e,a.AXES),this.setLocation=function(a,b){this.setAxis("X",a),this.setAxis("Y",b)},this.setMovement=function(a,b){this.setAxis("X",a+this.getAxis("X")),this.setAxis("Y",b+this.getAxis("Y"))},this.readEvent=function(b){if(this.setAxis("BUTTONS",b.buttons<<10),a.isPointerLocked()){var c=b.movementX,d=b.movementY;void 0===c&&(c=b.webkitMovementX||b.mozMovementX||0,d=b.webkitMovementY||b.mozMovementY||0),this.setMovement(c,d)}else this.setLocation(b.layerX,b.layerY)},c.addEventListener("mousedown",function(a){this.setButton(a.button,!0),this.setAxis("BUTTONS",a.buttons<<10)}.bind(this),!1),c.addEventListener("mouseup",function(a){this.setButton(a.button,!1),this.setAxis("BUTTONS",a.buttons<<10)}.bind(this),!1),c.addEventListener("mousemove",this.readEvent.bind(this),!1),c.addEventListener("wheel",function(a){isChrome?(this.setAxis("W",this.getAxis("W")+a.deltaX),this.setAxis("Z",this.getAxis("Z")+a.deltaY)):a.shiftKey?this.setAxis("W",this.getAxis("W")+a.deltaY):this.setAxis("Z",this.getAxis("Z")+a.deltaY),a.preventDefault()}.bind(this),!1),this.addEventListener=function(a,b,c){"pointerlockchange"===a&&(document.exitPointerLock?document.addEventListener("pointerlockchange",b,c):document.mozExitPointerLock?document.addEventListener("mozpointerlockchange",b,c):document.webkitExitPointerLock&&document.addEventListener("webkitpointerlockchange",b,c))},this.removeEventListener=function(a,b,c){"pointerlockchange"===a&&(document.exitPointerLock?document.removeEventListener("pointerlockchange",b,c):document.mozExitPointerLock?document.removeEventListener("mozpointerlockchange",b,c):document.webkitExitPointerLock&&document.removeEventListener("webkitpointerlockchange",b,c))},c.requestPointerLock=c.requestPointerLock||c.webkitRequestPointerLock||c.mozRequestPointerLock||function(){},this.requestPointerLock=function(){a.isPointerLocked()||c.requestPointerLock()},this.exitPointerLock=(document.webkitExitPointerLock||document.mozExitPointerLock||document.exitPointerLock||function(){}).bind(document),this.togglePointerLock=function(){a.isPointerLocked()?this.exitPointerLock():this.requestPointerLock()}}return a.isPointerLocked=function(){return!!(document.pointerLockElement||document.webkitPointerLockElement||document.mozPointerLockElement)},a.AXES=["X","Y","Z","W","BUTTONS"],Primrose.Input.ButtonAndAxis.inherit(a),a}(),Primrose.Input.Speech=function(){function a(a,b,c){function d(){var a=fmt("Failed to initialize speech engine. Reason: $1",i.message);return console.error(a),!1}function e(){return available?g?!1:(g=!0,h.start(),!0):d()}function f(){return available?g?(h.stop(),!0):!1:d()}Primrose.NetworkedInput.call(this,a,b,c);var g=!1,h=null,i=null;this.check=function(){this.enabled&&!g?e():!this.enabled&&g&&f()},this.getErrorMessage=function(){return i};try{h=window.SpeechRecognition?new SpeechRecognition:new webkitSpeechRecognition,h.continuous=!0,h.interimResults=!0,h.lang="en-US";var j=!1;h.addEventListener("start",function(){console.log("speech started"),command=""}.bind(this),!0),h.addEventListener("error",function(a){j=!0,console.log("speech error",a),g=!1,command="speech error"}.bind(this),!0),h.addEventListener("end",function(){console.log("speech ended",arguments),g=!1,command="speech ended",j&&(j=!1,this.enable(!0))}.bind(this),!0),h.addEventListener("result",function(a){var b=[],c=a.results[a.resultIndex],d=0,e=-1;if(c&&c.isFinal)for(var f=0;f<c.length;++f){var g=c[f];g.confidence>d&&(d=g.confidence,e=f)}d>.85&&b.push(c[e].transcript.trim()),b=b.join(" "),b!==this.inputState&&(this.inputState.text=b)}.bind(this),!0),available=!0}catch(k){i=k,available=!1}}return inherit(a,Primrose.NetworkedInput),a.maybeClone=function(a){return a&&a.slice()||[]},a.prototype.cloneCommand=function(b){return{name:b.name,preamble:b.preamble,keywords:a.maybeClone(b.keywords),commandUp:b.commandUp,disabled:b.disabled}},a.prototype.evalCommand=function(a,b,c){if(c&&this.inputState.text)for(var d=0;d<a.keywords.length;++d)0!==this.inputState.text.indexOf(a.keywords[d])||!a.preamble&&a.keywords[d].length!==this.inputState.text.length||(b.pressed=!0,b.value=this.inputState.text.substring(a.keywords[d].length).trim(),this.inputState.text=null)},a.prototype.enable=function(a,b){Primrose.NetworkedInput.prototype.enable.call(this,a,b),this.check()},a.prototype.transmit=function(a){Primrose.NetworkedInput.prototype.transmit.call(this,a),this.check()},a}(),Primrose.Input.Touch=function(){function a(b,c,d,e){function f(a,b,c){for(var d=c.changedTouches,e=0;e<d.length;++e){var f=d[e];b?(this.setAxis("X"+f.identifier,f.pageX),this.setAxis("Y"+f.identifier,f.pageY)):(this.setAxis("LX"+f.identifier,f.pageX),this.setAxis("LY"+f.identifier,f.pageY));var g,h=1<<f.identifier;a?(g=this.getValue("FINGERS")|h,this.setAxis("FINGERS",g)):(h=~h,g=this.getValue("FINGERS")&h,this.setAxis("FINGERS",g))}c.preventDefault()}c=c||window,Primrose.Input.ButtonAndAxis.call(this,b,d,e,a.AXES),c.addEventListener("touchstart",f.bind(this,!0,!1),!1),c.addEventListener("touchend",f.bind(this,!1,!0),!1),c.addEventListener("touchmove",f.bind(this,!0,!0),!1)}a.NUM_FINGERS=10,a.AXES=["FINGERS"];for(var b=0;b<a.NUM_FINGERS;++b)a.AXES.push("X"+b),a.AXES.push("Y"+b);return Primrose.Input.ButtonAndAxis.inherit(a),a}(),Primrose.Input.VR=function(){function a(b,c,d,e,f){function g(a,b){for(var c=0;c<a.length;++c)a[c](b)}function h(a){g(l.vrdeviceconnected,a)}function i(a){g(l.vrdevicelost,a)}function j(a,b){for(var c,d=[],e=Object.keys(this.devices),g=0;g<b.length;++g){var j=b[g];if(c=j.hardwareUnitId,!this.devices[c]){d.push(c);var k=e.indexOf(c);k>=0&&e.splice(k,1),this.devices[c]={display:null,sensor:null}}var l=this.devices[c];j instanceof HMDVRDevice?l.display=j:b[g]instanceof PositionSensorVRDevice&&(l.sensor=j)}if(this.deviceIDs=Object.keys(this.devices),this.deviceIDs.forEach(function(a){var b=this.devices[a],c=b.display.deviceName,d=b.sensor.deviceName;b.name="";for(var e=0;e<c.length&&e<d.length&&c[e]===d[e];++e)b.name+=c[e];for(;b.name.length>0&&!/\w/.test(b.name[b.name.length-1]);)b.name=b.name.substring(0,b.name.length-1)}.bind(this)),d.forEach(h),e.forEach(i),a){a.innerHTML="";for(c in this.devices){var m=document.createElement("option");m.value=c,m.innerHTML=this.devices[c].sensor.deviceName,m.selected=f===c,a.appendChild(m)}}f=f||1===this.deviceIDs.length&&this.deviceIDs[0],f&&this.connect(f)}function k(){navigator.getVRDevices?navigator.getVRDevices().then(j.bind(this,e))["catch"](console.error.bind(console,"Could not find VR devices")):navigator.mozGetVRDevices?navigator.mozGetVRDevices(j.bind(this,e)):console.log("Your browser doesn't have WebVR capability. Check out http://mozvr.com/")}(void 0===c||null===c)&&(c=a.AXES.map(function(a){return{name:a,axes:[Primrose.Input.VR[a]]}})),Primrose.Input.ButtonAndAxis.call(this,b,c,d,a.AXES),this.setAxis("headRW",1);var l={vrdeviceconnected:[],vrdevicelost:[]};this.addEventListener=function(a,b){l[a]&&l[a].push(b),"vrdeviceconnected"===a&&Object.keys(this.devices).forEach(b)},this.devices={},this.deviceIDs=null,this.sensor=null,this.display=null,this.params=null,this.transforms=null,k.call(this)}function b(){if(this.display){var a=null;return a=this.display.getEyeParameters?{left:this.display.getEyeParameters("left"),right:this.display.getEyeParameters("right")}:{left:{renderRect:this.display.getRecommendedEyeRenderRect("left"),eyeTranslation:this.display.getEyeTranslation("left"),recommendedFieldOfView:this.display.getRecommendedEyeFieldOfView("left")},right:{renderRect:this.display.getRecommendedEyeRenderRect("right"),eyeTranslation:this.display.getEyeTranslation("right"),recommendedFieldOfView:this.display.getRecommendedEyeFieldOfView("right")}}}}function c(a,b){var c=b.eyeTranslation;a.transform.makeTranslation(c.x,c.y,c.z),a.viewport=b.renderRect}return a.AXES=["headX","headY","headZ","headVX","headVY","headVZ","headAX","headAY","headAZ","headRX","headRY","headRZ","headRW","headRVX","headRVY","headRVZ","headRAX","headRAY","headRAZ"],Primrose.Input.ButtonAndAxis.inherit(a),a.prototype.update=function(a){if(this.sensor){var b=this.sensor.getState();b.position&&(this.setAxis("headX",b.position.x),this.setAxis("headY",b.position.y),this.setAxis("headZ",b.position.z)),b.linearVelocity&&(this.setAxis("headVX",b.linearVelocity.x),this.setAxis("headVY",b.linearVelocity.y),this.setAxis("headVZ",b.linearVelocity.z)),b.linearAcceleration&&(this.setAxis("headAX",b.linearAcceleration.x),this.setAxis("headAY",b.linearAcceleration.y),this.setAxis("headAZ",b.linearAcceleration.z)),b.orientation&&(this.setAxis("headRX",b.orientation.x),this.setAxis("headRY",b.orientation.y),this.setAxis("headRZ",b.orientation.z),this.setAxis("headRW",b.orientation.w)),b.angularVelocity&&(this.setAxis("headRVX",b.angularVelocity.x),this.setAxis("headRVY",b.angularVelocity.y),this.setAxis("headRVZ",b.angularVelocity.z),this.setAxis("headRVW",b.angularVelocity.w)),b.angularAcceleration&&(this.setAxis("headRAX",b.angularAcceleration.x),this.setAxis("headRAY",b.angularAcceleration.y),this.setAxis("headRAZ",b.angularAcceleration.z),this.setAxis("headRAW",b.angularAcceleration.w))}Primrose.Input.ButtonAndAxis.prototype.update.call(this,a)},a.prototype.getQuaternion=function(a,b,c,d,e){return e=e||new THREE.Quaternion,e.set(this.getValue(a),this.getValue(b),this.getValue(c),this.getValue(d)),e},a.prototype.connect=function(a){var d=this.devices[a];d&&(this.sensor=d.sensor,this.display=d.display,this.params=b.call(this),this.transforms=[{transform:new THREE.Matrix4},{transform:new THREE.Matrix4}],c(this.transforms[0],this.params.left),c(this.transforms[1],this.params.right))},a}(),Primrose.Output.Audio3D=function(){function a(){try{this.context=new AudioContext,this.sampleRate=this.context.sampleRate,this.mainVolume=this.context.createGain(),this.mainVolume.connect(this.context.destination),this.setPosition=this.context.listener.setPosition.bind(this.context.listener),this.setVelocity=this.context.listener.setVelocity.bind(this.context.listener),this.setOrientation=this.context.listener.setOrientation.bind(this.context.listener),this.isAvailable=!0}catch(a){this.isAvailable=!1,this.setPosition=function(){},this.setVelocity=function(){},this.setOrientation=function(){},this.error=a,console.error("AudioContext not available. Reason: ",a.message)}}return Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){},a.prototype.loadBuffer=function(a,b,c){if(!c)throw new Error("You need to provide a callback function for when the audio finishes loading");b||(b=function(){});var d=function(){b("error",a)};if(this.isAvailable){b("loading",a);var e=new XMLHttpRequest;e.open("GET",a),e.responseType="arraybuffer",e.onerror=d,e.onabort=d,e.onprogress=function(c){b("intermediate",a,c.loaded)},e.onload=function(){e.status<400?(b("success",a),this.context.decodeAudioData(e.response,c,d)):d()}.bind(this),e.send()}else d()},a.prototype.loadBufferCascadeSrcList=function(a,b,c,d){if(d=d||0,d===a.length)b&&a.forEach(function(a){b("error",a)});else{var e=c,f=b;c=function(b){if(f)for(var c=d+1;c<a.length;++c)console.log("Skipping loading alternate file ["+a[c]+"]. ["+a[d]+"] has already loaded."),f("skip",a[c],"["+a[d]+"] has already loaded.");e&&e(b)},b=function(b,c,g){f&&f(b,c,g),"error"===b&&(console.warn("Failed to decode "+a[d]),setTimeout(this.loadBufferCascadeSrcList.bind(this,a,f,e,d+1),0))},this.loadBuffer(a[d],b,c)}},a.prototype.createRawSound=function(a,b){if(1!==a.length&&2!==a.length)throw new Error("Incorrect number of channels. Expected 1 or 2, got "+a.length);var c=a[0].length;if(a.length>1&&a[1].length!==c)throw new Error("Second channel is not the same length as the first channel. Expected "+c+", but was "+a[1].length);for(var d=this.context.createBuffer(a.length,c,this.sampleRate),e=0;e<a.length;++e)for(var f=d.getChannelData(e),g=0;c>g;++g)f[g]=a[e][g];b(d)},a.prototype.createSound=function(a,b,c){var d={volume:this.context.createGain(),source:this.context.createBufferSource()};d.source.buffer=c,d.source.loop=a,d.source.connect(d.volume),b(d)},a.prototype.create3DSound=function(a,b,c,d,e){e.panner=this.context.createPanner(),e.panner.setPosition(a,b,c),e.panner.connect(this.mainVolume),e.volume.connect(e.panner),d(e)},a.prototype.createFixedSound=function(a,b){b.volume.connect(this.mainVolume),a(b)},a.prototype.loadSound=function(a,b,c,d){this.loadBuffer(a,c,this.createSound.bind(this,b,d))},a.prototype.loadSoundCascadeSrcList=function(a,b,c,d){this.loadBufferCascadeSrcList(a,c,this.createSound.bind(this,b,d))},a.prototype.load3DSound=function(a,b,c,d,e,f,g){this.loadSound(a,b,f,this.create3DSound.bind(this,c,d,e,g))},a.prototype.load3DSoundCascadeSrcList=function(a,b,c,d,e,f,g){this.loadSoundCascadeSrcList()(a,b,f,this.create3DSound.bind(this,c,d,e,g))},a.prototype.loadFixedSound=function(a,b,c,d){this.loadSound(a,b,c,this.createFixedSound.bind(this,d))},a.prototype.loadFixedSoundCascadeSrcList=function(a,b,c,d){this.loadSoundCascadeSrcList(a,b,c,this.createFixedSound.bind(this,d))},a.prototype.playBufferImmediate=function(a,b){this.createSound(!1,this.createFixedSound.bind(this,function(a){a.volume.gain.value=b,a.source.addEventListener("ended",function(){a.volume.disconnect(this.mainVolume)}.bind(this)),a.source.start(0)}),a)},a}(),Primrose.Output.HapticGlove=function(){function a(b){function c(a){if(a.valid){d=a.hands.length>0;for(var c=0;c<b.hands&&c<a.hands.length;++c)for(var e=a.hands[c],f=0;f<b.fingers;++f)for(var h=e.fingers[f],i=0;i<b.joints;++i){var j=c*b.fingers*b.joints+f*b.joints+i;if(j<this.tips.length){var k=h[g[i]],l=this.tips[j];l.position.set(k[0],k[1],k[2])}}}}b.port=b.port||a.DEFAULT_PORT,b.addr=b.addr||a.DEFAULT_HOST,this.tips=[],this.numJoints=b.hands*b.fingers*b.joints;var d=!1,e=!1;Leap.loop(),this.setEnvironment=function(a){b.world=a.world,b.scene=a.scene,b.camera=a.camera,Leap.loopController.on("frame",c.bind(this))};var f,g=["tipPosition","dipPosition","pipPosition","mcpPosition","carpPosition"],h=0;80!==b.port&&(b.addr+=":"+b.port),f=io.connect(b.addr,{reconnect:!0,"reconnection delay":1e3,"max reconnection attempts":5}),f.on("connect",function(){e=!0,console.log("Connected!")}),f.on("disconnect",function(){e=!1,console.log("Disconnected!")}),this.readContacts=function(a){for(var c=0,e=0;d&&2>c&&e<a.length;++e)for(var f=a[e],g=0;g<b.hands&&2>c;++g)for(var h=0;h<b.fingers;++h){var i=this.tips[h],j=!1;f.bi===i&&f.bj.graphics&&f.bj.graphics.isSolid&&(this.setFingerState(h,!0),j=!0,++c),j||this.setFingerState(h,!1)}},this.setFingerState=function(a,b){var c=1<<a;b?h|=c:h=h&~c&31,e&&f.emit("data",h)}}return a.DEFAULT_PORT=8383,a.DEFAULT_HOST=document.location.hostname,a}(),Primrose.Output.Music=function(){function a(a){return 440*Math.pow(c,a-49)}function b(a,b,c){if(this.audio=a||new AudioContext,this.audio&&this.audio.createGain){void 0===c&&(c=d),void 0===b&&(b="sawtooth"),this.available=!0,this.mainVolume=this.audio.createGain(),this.mainVolume.connect(this.audio.destination),this.numNotes=c,this.oscillators=[];for(var e=0;e<this.numNotes;++e){var f=this.audio.createOscillator(),g=this.audio.createGain();f.type=b,f.frequency.value=0,f.connect(g),f.start(),g.connect(this.mainVolume),this.oscillators.push({osc:f,gn:g,timeout:null})}}else this.available=!1,IS_IN_GRID=!0}Window.prototype.AudioContext=Window.prototype.AudioContext||Window.prototype.webkitAudioContext||function(){};var c=Math.pow(2,1/12),d=(navigator.maxTouchPoints||10)+1;return b.prototype.noteOn=function(b,c,d){if(this.available){void 0===d&&(d=0);var e=this.oscillators[d%this.numNotes],f=a(parseFloat(c)+1);return e.gn.gain.value=b,e.osc.frequency.setValueAtTime(f,0),e}},b.prototype.noteOff=function(a){if(this.available){void 0===a&&(a=0);var b=this.oscillators[a%this.numNotes];b.osc.frequency.setValueAtTime(0,0)}},b.prototype.play=function(a,b,c,d){if(this.available){void 0===d&&(d=0);var e=this.noteOn(b,a,d);e.timeout&&(clearTimeout(e.timeout),e.timeout=null),e.timeout=setTimeout(function(a,b){this.noteOff(a),b.timeout=null}.bind(this,d,e),1e3*c)}},b}(),Primrose.Output.Speech=function(){function a(a,b,c,d){return a[b]=void 0===a[b]?c+(d-c)*Math.random():Math.min(d,Math.max(c,a[b])),a[b]}try{return{Character:function(b){b=b||{};var c=speechSynthesis.getVoices().filter(function(a){return a["default"]||a.localService}.bind(this)),d=c[Math.floor(a(b,"voice",0,c.length))];this.speak=function(c,e){var f=new SpeechSynthesisUtterance;f.voice=d,f.volume=a(b,"volume",1,1),f.rate=a(b,"rate",.1,5),f.pitch=a(b,"pitch",0,2),f.text=c,f.onend=e,speechSynthesis.speak(f)}}}}catch(b){return{Character:function(){this.speak=function(){}}}}}(),Primrose.Text.CodePage=function(){"use strict";function a(a,b,c){this.name=a,this.language=b,copyObject(this,{NORMAL:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z"},SHIFT:{65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z"}}),copyObject(this,c);for(var d=0;9>=d;++d){var e=Primrose.Keys["NUMPAD"+d];this.NORMAL[e]=d.toString()}this.NORMAL[Primrose.Keys.MULTIPLY]="*",this.NORMAL[Primrose.Keys.ADD]="+",this.NORMAL[Primrose.Keys.SUBTRACT]="-",this.NORMAL[Primrose.Keys.DECIMALPOINT]=".",this.NORMAL[Primrose.Keys.DIVIDE]="/"}return a.DEAD=function(a){return function(b){b.setDeadKeyState("DEAD"+a)}},a}(),Primrose.Text.CommandPack=function(){"use strict";function a(a,b){this.name=a,copyObject(this,b)}return a}(),Primrose.Text.Control=function(){"use strict";function a(){this.controlID=b++,this.focused=!1}var b=1;return a.prototype.focus=function(){this.focused=!0},a.prototype.blur=function(){this.focused=!1},a}(),Primrose.Text.Cursor=function(){"use strict";function a(a,b,c){this.i=a||0,this.x=b||0,this.y=c||0,this.moved=!0}var b=function(){function a(d){d=d.replace(b,function(b,c,d){return a(d)+c}).replace(c,"$2$1");for(var e="",f=d.length-1;f>=0;--f)e+=d[f];return e}var b=/(<%= allExceptCombiningMarks %>)(<%= combiningMarks %>+)/g,c=/(<%= highSurrogates %>)(<%= lowSurrogates %>)/g;return a}();return a.min=function(a,b){return a.i<=b.i?a:b},a.max=function(a,b){return a.i>b.i?a:b},a.prototype.toString=function(){return fmt("[i:$1 x:$2 y:$3]",this.i,this.x,this.y)},a.prototype.copy=function(a){this.i=a.i,this.x=a.x,this.y=a.y,this.moved=!1},a.prototype.fullhome=function(){this.i=0,this.x=0,this.y=0,this.moved=!0},a.prototype.fullend=function(a){this.i=0;for(var b=0,c=0;c<a.length;++c){var d=a[c];b=d.length,this.i+=b}this.y=a.length-1,this.x=b,this.moved=!0},a.prototype.skipleft=function(a){if(0===this.x)this.left(a);else{var c=this.x-1,d=a[this.y],e=b(d.substring(0,c)),f=e.match(/(\s|\W)+/),g=f?f.index+f[0].length+1:e.length;this.i-=g,this.x-=g}this.moved=!0},a.prototype.left=function(a){if(this.i>0){if(--this.i,--this.x,this.x<0){--this.y;var b=a[this.y];this.x=b.length}this.reverseFromNewline(a)&&++this.i}this.moved=!0},a.prototype.skipright=function(a){var b=a[this.y];if(this.x===b.length||"\n"===b[this.x])this.right(a);else{var c=this.x+1;b=b.substring(c);var d=b.match(/(\s|\W)+/),e=d?d.index+d[0].length+1:b.length-this.x;this.i+=e,this.x+=e,this.reverseFromNewline(a)}this.moved=!0},a.prototype.fixCursor=function(a){this.x=this.i,this.y=0;for(var b=0,c=a[this.y];this.x>c.length;){if(this.x-=c.length,b+=c.length,this.y>=a.length-1){this.i=b,this.x=c.length,this.moved=!0;break}++this.y,c=a[this.y]}return this.moved},a.prototype.right=function(a){this.advanceN(a,1)},a.prototype.advanceN=function(a,b){var c=a[this.y];(this.y<a.length-1||this.x<c.length)&&(this.i+=b,this.fixCursor(a),c=a[this.y],this.x>0&&"\n"===c[this.x-1]&&(++this.y,this.x=0)),this.moved=!0},a.prototype.home=function(){this.i-=this.x,this.x=0,this.moved=!0},a.prototype.end=function(a){var b=a[this.y],c=b.length-this.x;this.i+=c,this.x+=c,this.reverseFromNewline(a),this.moved=!0},a.prototype.up=function(a){if(this.y>0){--this.y;var b=a[this.y],c=Math.min(0,b.length-this.x);this.x+=c,this.i-=b.length-c,this.reverseFromNewline(a)}this.moved=!0},a.prototype.down=function(a){if(this.y<a.length-1){++this.y;var b=a[this.y],c=a[this.y-1],d=Math.min(0,b.length-this.x);this.x+=d,this.i+=c.length+d,this.reverseFromNewline(a)}this.moved=!0},a.prototype.incY=function(a,b){this.y=Math.max(0,Math.min(b.length-1,this.y+a));var c=b[this.y];this.x=Math.max(0,Math.min(c.length,this.x)),this.i=this.x;for(var d=0;d<this.y;++d)this.i+=b[d].length;this.reverseFromNewline(b),this.moved=!0},a.prototype.setXY=function(a,b,c){this.y=Math.max(0,Math.min(c.length-1,b));var d=c[this.y];this.x=Math.max(0,Math.min(d.length,a)),this.i=this.x;for(var e=0;e<this.y;++e)this.i+=c[e].length;this.reverseFromNewline(c),this.moved=!0},a.prototype.setI=function(a,b){this.i=a,this.fixCursor(b),this.moved=!0},a.prototype.reverseFromNewline=function(a){var b=a[this.y];return this.x>0&&"\n"===b[this.x-1]?(--this.x,--this.i,!0):!1},a}(),Primrose.Text.Grammar=function(){"use strict";function a(a,b){function c(a){for(var b=!1,c=0,d=0;d<a.length;++d){var e=a[d];e.line=c,"newlines"===e.type&&++c,b?("endBlockComments"===e.type&&(b=!1),"newlines"!==e.type&&(e.type="comments")):"startBlockComments"===e.type&&(b=!0,e.type="comments")}}this.name=a,this.grammar=b.map(function(a){return new Primrose.Text.Rule(a[0],a[1])}),this.tokenize=function(a){for(var b=[new Primrose.Text.Token(a,"regular",0)],d=0;d<this.grammar.length;++d)for(var e=this.grammar[d],f=0;f<b.length;++f)e.carveOutMatchedToken(b,f);return c(b),b}}return a}(),Primrose.Text.OperatingSystem=function(){"use strict";function a(a,b,c,d,e){var f=b+"_"+c;a[f]=function(a,b){a["cursor"+d](b,a[e+"Cursor"])}}function b(b,c,d,e){a(b,c||"NORMAL",d,e,"front"),a(b,c+"SHIFT",d,e,"back")}function c(a,c,d,e,f,g,h,i,j,k){this.name=a,this[c+"_a"]=function(a,b){a.frontCursor.fullhome(b),a.backCursor.fullend(b)},this[e]=function(a){a.redo(),a.scrollIntoView(a.frontCursor)},this[c+"_z"]=function(a){a.undo(),a.scrollIntoView(a.frontCursor)},this[c+"_DOWNARROW"]=function(a,b){a.scroll.y<b.length&&++a.scroll.y},this[c+"_UPARROW"]=function(a){a.scroll.y>0&&--a.scroll.y},this.isClipboardReadingEvent=function(a){return a[c.toLowerCase()+"Key"]&&(67===a.keyCode||88===a.keyCode)},b(this,"","LEFTARROW","Left"),b(this,"","RIGHTARROW","Right"),b(this,"","UPARROW","Up"),b(this,"","DOWNARROW","Down"),b(this,"","PAGEUP","PageUp"),b(this,"","PAGEDOWN","PageDown"),b(this,d,"LEFTARROW","SkipLeft"),b(this,d,"RIGHTARROW","SkipRight"),b(this,f,g,"Home"),b(this,f,h,"End"),b(this,i,j,"FullHome"),b(this,i,k,"FullEnd")}return c}(),Primrose.Text.Point=function(){"use strict";function a(a,b){this.set(a||0,b||0)}return a.prototype.set=function(a,b){this.x=a,this.y=b},a.prototype.copy=function(a){a&&(this.x=a.x,this.y=a.y)},a.prototype.clone=function(){return new a(this.x,this.y)},a.prototype.toString=function(){return fmt("(x:$1, y:$2)",this.x,this.y)},a}(),Primrose.Text.Rectangle=function(){"use strict";function a(a,b,c,d){this.point=new Primrose.Text.Point(a,b),this.size=new Primrose.Text.Size(c,d),Object.defineProperties(this,{x:{get:function(){return this.point.x},set:function(a){this.point.x=a}},left:{get:function(){return this.point.x},set:function(a){this.point.x=a}},width:{get:function(){return this.size.width},set:function(a){this.size.width=a}},right:{get:function(){return this.point.x+this.size.width},set:function(a){this.point.x=a-this.size.width}},y:{get:function(){return this.point.y},set:function(a){this.point.y=a}},top:{get:function(){return this.point.y},set:function(a){this.point.y=a}},height:{get:function(){return this.size.height},set:function(a){this.size.height=a}},bottom:{get:function(){return this.point.y+this.size.height},set:function(a){this.point.y=a-this.size.height}}})}return a.prototype.set=function(a,b,c,d){this.point.set(a,b),this.size.set(c,d)},a.prototype.copy=function(a){a&&(this.point.copy(a.point),this.size.copy(a.size))},a.prototype.clone=function(){return new a(this.point.x,this.point.y,this.size.width,this.size.height)},a.prototype.toString=function(){return fmt("[$1 x $2]",this.point.toString(),this.size.toString())},a}(),Primrose.Text.Rule=function(){"use strict";function a(a,b){this.name=a,this.test=b}return a.prototype.carveOutMatchedToken=function(a,b){var c=a[b];if("regular"===c.type){var d=this.test.exec(c.value);if(d){for(var e=d[d.length-1],f=d.index,g=1;g<d.length-1;++g)f+=d[g].length;var h=f+e.length;if(0===f){if(c.type=this.name,h<c.value.length){var i=c.splitAt(h);i.type="regular",a.splice(b+1,0,i)}}else{var j=c.splitAt(f);if(e.length<j.value.length){var k=j.splitAt(e.length);a.splice(b+1,0,k)}j.type=this.name,a.splice(b+1,0,j)}}}},a}(),Primrose.Text.Size=function(){"use strict";function a(a,b){this.set(a||0,b||0)}return a.prototype.set=function(a,b){this.width=a,this.height=b},a.prototype.copy=function(a){a&&(this.width=a.width,this.height=a.height)},a.prototype.clone=function(){return new a(this.width,this.height)},a.prototype.toString=function(){return fmt("<w:$1, h:$2>",this.width,this.height)},a}(),Primrose.Text.Terminal=function(a,b){"use strict";function c(a){a.selectionStart=a.selectionEnd=a.value.length,a.scrollIntoView(a.frontCursor)}function d(){q.running&&(f(),q.running=!1,p&&(a.setTokenizer(k),a.value=j),c(a))}function e(){return b.selectionStart=b.selectionEnd=0,b.value="",!0}function f(){if(o.length>0){for(var a=o.split("\n"),b=0;m>b&&a.length>0;++b)n.push(a.shift());a.length>0&&n.push(" ----- more -----"),o=a.join("\n")}}function g(a){i=a,q.waitingForInput=!0,f()}function h(a){o+=a}b=b||a;var i=null,j=null,k=null,l=0,m=40,n=[],o="",p=a===b,q=this;this.running=!1,this.waitingForInput=!1,this.sendInput=function(a){if(o.length>0)f();else{b.keyDown(a);var c=b.value.substring(l);i(c.trim()),i=null,this.waitingForInput=!1}},this.execute=function(c){if(m=c?10:40,k=a.getTokenizer(),k&&k.interpret){this.running=!0;var f,i=function(){q.running&&setTimeout(f,1)};j=a.value,f=k.interpret(j,g,h,h,i,e,this.loadFile.bind(this),d),b.setTokenizer(Primrose.Text.Grammars.PlainText),e(),i()}},this.loadFile=function(b,c){GET(b.toLowerCase(),"text",function(b){isOSX&&(b=b.replace("CTRL+SHIFT+SPACE","CMD+OPT+E")),a.value=j=b,c&&c()})},this.update=function(){n.length>0&&(b.value+=n.shift()+"\n",c(b),l=b.selectionStart)}},Primrose.Text.Token=function(){"use strict";function a(a,b,c,d){this.value=a,this.type=b,this.index=c,this.line=d}return a.prototype.clone=function(){return new a(this.value,this.type,this.index,this.line)},a.prototype.splitAt=function(b){var c=this.value.substring(b);return this.value=this.value.substring(0,b),new a(c,this.type,this.index+b,this.line)},a.prototype.toString=function(){return fmt("[$1: $2]",this.type,this.value)},a}(),Primrose.Text.CodePages.DE_QWERTZ=function(){"use strict";var a=Primrose.Text.CodePage;return new a("Deutsch: QWERTZ","de",{deadKeys:[220,221,160,192],NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",60:"<",63:"ß",160:a.DEAD(3),163:"#",171:"+",173:"-",186:"ü",187:"+",188:",",189:"-",190:".",191:"#",192:a.DEAD(4),219:"ß",220:a.DEAD(1),221:a.DEAD(2),222:"ä",226:"<"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û",190:"."},DEAD2NORMAL:{65:"á",69:"é",73:"í",79:"ó",83:"s",85:"ú",89:"ý"},SHIFT:{48:"=",49:"!",50:'"',51:"§",52:"$",53:"%",54:"&",55:"/",56:"(",57:")",60:">",63:"?",163:"'",171:"*",173:"_",186:"Ü",187:"*",188:";",189:"_",190:":",191:"'",192:"Ö",219:"?",222:"Ä",226:">"},CTRLALT:{48:"}",50:"²",51:"³",55:"{",56:"[",57:"]",60:"|",63:"\\",69:"€",77:"µ",81:"@",171:"~",187:"~",219:"\\",226:"|"},CTRLALTSHIFT:{63:"ẞ",219:"ẞ"},DEAD3NORMAL:{65:"a",69:"e",73:"i",79:"o",85:"u",190:"."},DEAD4NORMAL:{65:"a",69:"e",73:"i",79:"o",83:"s",85:"u",89:"y"}})}(),Primrose.Text.CodePages.EN_UKX=function(){"use strict";var a=Primrose.Text.CodePage;return new a("English: UK Extended","en-GB",{CTRLALT:{52:"€",65:"á",69:"é",73:"í",79:"ó",85:"ú",163:"\\",192:"¦",222:"\\",223:"¦"},CTRLALTSHIFT:{65:"Á",69:"É",73:"Í",79:"Ó",85:"Ú",222:"|"},NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",163:"#",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"'",219:"[",220:"\\",221:"]",222:"#",223:"`"},SHIFT:{48:")",49:"!",50:'"',51:"£",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",163:"~",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",192:"@",219:"{",220:"|",221:"}",222:"~",223:"¬"}})}(),Primrose.Text.CodePages.EN_US=function(){"use strict";var a=Primrose.Text.CodePage;return new a("English: USA","en-US",{NORMAL:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'"},SHIFT:{48:")",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",59:":",61:"+",173:"_",186:":",187:"+",188:"<",189:"_",190:">",191:"?",219:"{",220:"|",221:"}",222:'"'}})}(),Primrose.Text.CodePages.FR_AZERTY=function(){"use strict";var a=Primrose.Text.CodePage;return new a("Français: AZERTY","fr",{deadKeys:[221,50,55],NORMAL:{48:"à",49:"&",50:"é",51:'"',52:"'",53:"(",54:"-",55:"è",56:"_",57:"ç",186:"$",187:"=",188:",",190:";",191:":",192:"ù",219:")",220:"*",221:a.DEAD(1),222:"²",223:"!",226:"<"},SHIFT:{48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",186:"£",187:"+",188:"?",190:".",191:"/",192:"%",219:"°",220:"µ",223:"§",226:">"},CTRLALT:{48:"@",50:a.DEAD(2),51:"#",52:"{",53:"[",54:"|",55:a.DEAD(3),56:"\\",57:"^",69:"€",186:"¤",187:"}",219:"]"},DEAD1NORMAL:{65:"â",69:"ê",73:"î",79:"ô",85:"û"},DEAD2NORMAL:{65:"ã",78:"ñ",79:"õ"},DEAD3NORMAL:{48:"à",50:"é",55:"è",65:"à",69:"è",73:"ì",79:"ò",85:"ù"}})}(),Primrose.Text.CommandPacks.TestViewer=function(){"use strict";return{name:"Basic commands",NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_BACKSPACE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.frontCursor.left(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_ENTER:function(a,b){var c="",d=b[a.frontCursor.y];d.length>0&&"whitespace"===d[0].type&&(c=d[0].value),a.overwriteText("\n"+c),a.scrollIntoView(a.frontCursor)},NORMAL_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.backCursor.right(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},SHIFT_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&(a.frontCursor.home(b),a.backCursor.end(b)),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_TAB:function(a){var b=a.getTabString();a.overwriteText(b)}}}(),Primrose.Text.CommandPacks.TextEditor=function(){"use strict";function a(a,b,c){var d={NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_BACKSPACE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.frontCursor.left(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)
},NORMAL_ENTER:function(a,b){var c="",d=b[a.frontCursor.y];d.length>0&&"whitespace"===d[0].type&&(c=d[0].value),a.overwriteText("\n"+c),a.scrollIntoView(a.frontCursor)},NORMAL_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&a.backCursor.right(b),a.overwriteText(),a.scrollIntoView(a.frontCursor)},SHIFT_DELETE:function(a,b){a.frontCursor.i===a.backCursor.i&&(a.frontCursor.home(b),a.backCursor.end(b)),a.overwriteText(),a.scrollIntoView(a.frontCursor)},NORMAL_TAB:function(a){var b=a.getTabString();a.overwriteText(b)}},e={};copyObject(e,b),copyObject(e,a),copyObject(e,d);for(var f in e)if(e.hasOwnProperty(f)){var g=e[f];"function"!=typeof g&&(g=c.overwriteText.bind(c,g)),e[f]=g}Primrose.Text.CommandPack.call(this,"Text editor commands",e)}return inherit(a,Primrose.Text.CommandPack),a}(),Primrose.Text.Controls.Keyboard=function(){"use strict";function a(a,b){function c(a,c){if(b.pointerEventSource){l.focus();var d=b.pointerEventSource.getBoundingClientRect();l.startPointer(a-d.left,c-d.top)}}function d(a,c){if(b.pointerEventSource){var d=b.pointerEventSource.getBoundingClientRect();l.movePointer(a-d.left,c-d.top)}}function e(a){0===a.button&&(c(a.clientX,a.clientY),a.preventDefault())}function f(a){l.focused&&d(a.clientX,a.clientY)}function g(a){l.focused&&0===a.button&&l.endPointer()}function h(a){if(l.focused&&a.touches.length>0&&!v){var b=a.touches[0];c(b.clientX,b.clientY),r=b.identifier}}function i(a){for(var b=0;b<a.changedTouches.length&&v;++b){var c=a.changedTouches[b];if(c.identifier===r){d(c.clientX,c.clientY);break}}}function j(a){for(var b=0;b<a.changedTouches.length&&v;++b){var c=a.changedTouches[b];c.identifier===r&&l.endPointer()}}function k(){if(p&&n){q={};var a={NORMAL_SPACE:" ",SHIFT_SPACE:" ",NORMAL_TAB:"	"},b={};copyObject(b,m),copyObject(b,n),copyObject(b,a)}}var l=this;b=b||{},"string"==typeof b&&(b={file:b}),Primrose.Text.Control.call(this);var m,n,o,p,q,r,s={keydown:[]},t="",u=[],v=!1,w=null;this.addEventListener=function(a,b){s.hasOwnProperty(a)&&s[a].push(b)},this.getDOMElement=function(){return w},this.setDeadKeyState=function(a){this.changed=!0,t=a||""},this.setOperatingSystem=function(a){this.changed=!0,n=a||(isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows),k()},this.getOperatingSystem=function(){return n},this.setSize=function(){},this.getWidth=function(){return null},this.getHeight=function(){return null},this.setCodePage=function(a){this.changed=!0;var b,c,d,e;if(m=a,!m){var f=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;f&&"en"!==f||(f="en-US");for(b in Primrose.Text.CodePages)if(a=Primrose.Text.CodePages[b],a.language===f){m=a;break}m||(m=Primrose.Text.CodePages.EN_US)}u=[];for(b in Primrose.Keys)c=Primrose.Keys[b],isNaN(c)||(u[c]=b);p={};for(var g in m){var h=m[g];if("object"==typeof h)for(c in h){if(c.indexOf("_")>-1){var i=c.split(" "),j=i[0];c=i[1],d=m.NORMAL[c],e=j+"_"+g+" "+d}else d=m.NORMAL[c],e=g+"_"+d;u[c]=d,p[e]=h[c]}}k()},this.getCodePage=function(){return m},this.startPicking=function(){},this.movePicking=function(){},this.startPointer=function(){},this.movePointer=function(){},this.endPointer=function(){v=!1},this.bindEvents=function(a,b){a&&a.addEventListener("keydown",this.keyDown.bind(this)),b&&(b.addEventListener("mousedown",e),b.addEventListener("mousemove",f),b.addEventListener("mouseup",g),b.addEventListener("touchstart",h),b.addEventListener("touchmove",i),b.addEventListener("touchend",j))},this.keyDown=function(a){if(this.focused){a=a||event;var b=a.keyCode;if(b!==Primrose.Keys.CTRL&&b!==Primrose.Keys.ALT&&b!==Primrose.Keys.META_L&&b!==Primrose.Keys.META_R&&b!==Primrose.Keys.SHIFT){var c=t,d=t;a.ctrlKey&&(d+="CTRL"),a.altKey&&(d+="ALT"),a.metaKey&&(d+="META"),a.shiftKey&&(d+="SHIFT"),d===t&&(d+="NORMAL"),d+="_"+u[b];var e=q[o+"_"+d]||q[d];e&&(this.frontCursor.moved=!1,this.backCursor.moved=!1,e(l,tokenRows),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),clampScroll(),a.preventDefault()),t===c&&(t="")}this.update()}},this.render=function(){Primrose.Text.Control.prototype.render.call(this)},o=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",w=cascadeElement(a,"canvas",HTMLCanvasElement),b.autoBindEvents&&(void 0===b.keyEventSource&&(b.keyEventSource=w),void 0===b.pointerEventSource&&(b.pointerEventSource=w)),this.setCodePage(b.codePage),this.setOperatingSystem(b.os),this.bindEvents(b.keyEventSource,b.pointerEventSource),this.keyboardSelect=makeSelectorFromObj("primrose-keyboard-selector-"+w.id,Primrose.Text.CodePages,m.name,l,"setCodePage","Localization",Primrose.Text.CodePage),this.operatingSystemSelect=makeSelectorFromObj("primrose-operating-system-selector-"+w.id,Primrose.Text.OperatingSystems,n.name,l,"setOperatingSystem","Shortcut style",Primrose.Text.OperatingSystem)}return inherit(a,Primrose.Text.Control),a}(),Primrose.Text.Controls.PlainText=function(){function a(a,b,c,d,e,f,g,h){a=a.replace(/\r\n/g,"\n");var i=a.split("\n");h=h||"center";var j=1e3*b,k=j*i.length,l=document.createElement("canvas"),m=l.getContext("2d");m.font=j+"px Arial";var n=m.measureText(a).width;l.width=n,l.height=k,m.font=.8*j+"px Arial","transparent"!==d&&(m.fillStyle=d,m.fillRect(0,0,l.width,l.height)),m.fillStyle=c,m.textBaseline="top";for(var o=0;o<i.length;++o)m.fillText(i[o],0,o*j);var p=new THREE.Texture(l);p.needsUpdate=!0;var q=new THREE.MeshBasicMaterial({map:p,transparent:"transparent"===d,useScreenCoordinates:!1,color:16777215,shading:THREE.FlatShading}),r=new THREE.PlaneGeometry(b*n/j,b*i.length);r.computeBoundingBox(),r.computeVertexNormals();var s=new THREE.Mesh(r,q);return"left"===h?e-=r.boundingBox.min.x:"right"===h&&(e+=r.boundingBox.min.x),s.position.set(e,f,g),s}return a}(),Primrose.Text.Controls.TextBox=function(){"use strict";function a(a,c){function d(){G=F.tokenize(y.value),y.update()}function e(){if(y.scroll.y<0)y.scroll.y=0;else for(;0<y.scroll.y&&y.scroll.y>J.length-V.height;)--y.scroll.y}function f(a,b,c){P.set(b,c),cb.pixel2cell(P,y.scroll,V);var d=P.x-y.scroll.x,e=P.y-y.scroll.y,f=e>=V.height,g=0>d,h=P.x>=V.width;if(Z||f||g||h){if(Z||h&&!f){Z=!0;var i=J.length-V.height;if(e>=0&&i>=0){var j=e*i/V.height;y.scroll.y=Math.floor(j)}}else if(f&&!g){for(var k=0,l=0;l<J.length;++l)k=Math.max(k,J[l].length);var m=k-V.width;if(d>=0&&m>=0){var n=d*m/V.width;y.scroll.x=Math.floor(n)}}}else a.setXY(P.x,P.y,J),y.backCursor.copy(a);Q.copy(P)}function g(){var a=y.frontCursor.fixCursor(J)||y.backCursor.fixCursor(J);a&&y.render()}function h(a,b){if(c.pointerEventSource){y.focus();var d=c.pointerEventSource.getBoundingClientRect();y.startPointer(a-d.left,b-d.top)}}function i(a,b){if(c.pointerEventSource){var d=c.pointerEventSource.getBoundingClientRect();y.movePointer(a-d.left,b-d.top)}}function j(a){0===a.button&&(h(a.clientX,a.clientY),a.preventDefault())}function k(a){y.focused&&i(a.clientX,a.clientY)}function l(a){y.focused&&0===a.button&&y.endPointer()}function m(a){if(y.focused&&a.touches.length>0&&!Y){var b=a.touches[0];h(b.clientX,b.clientY),N=b.identifier}}function n(a){for(var b=0;b<a.changedTouches.length&&Y;++b){var c=a.changedTouches[b];if(c.identifier===N){i(c.clientX,c.clientY);break}}}function o(a){for(var b=0;b<a.changedTouches.length&&Y;++b){var c=a.changedTouches[b];c.identifier===N&&y.endPointer()}}function p(){D&&A&&C&&(E=new C(A,D,y))}function q(a){var b=a.toLowerCase();y["cursor"+a]=function(a,c){c[b](a),y.scrollIntoView(c)}}function r(){W.width=$?1:0,_?ab?X.set(cb.VSCROLL_WIDTH,0):X.set(cb.VSCROLL_WIDTH,1):X.set(0,0)}function s(){var a=0;$&&(a=Math.max(1,Math.ceil(Math.log(y.getLineCount())/Math.LN10)));var b=W.width+a,c=0,d=Math.floor(y.getWidth()/cb.character.width)-b-X.width,e=Math.floor(y.getHeight()/cb.character.height)-c-X.height;V.set(b,c,d,e),V.lineCountWidth=a}function t(){H=[[]],I=[""],J=[""];for(var a=0,b=G.slice(),c=0;c<b.length;++c){var d=b[c].clone(),e=V.width-a,f=ab&&"newlines"!==d.type&&d.value.length>e,g="newlines"===d.type||f;if(f){var h=d.value.length>V.width?e:0;b.splice(c+1,0,d.splitAt(h))}d.value.length>0&&(H[H.length-1].push(d),I[I.length-1]+=JSON.stringify(d),J[J.length-1]+=d.value,a+=d.value.length),g&&(H.push([]),I.push(""),J.push(""),a=0)}}function u(a){a.returnValue=!1}function v(a,b,c){var d=a-b,e=a-c+5,f=0;return(0>d||e>=0)&&(f=Math.abs(d)<Math.abs(e)?d:e),f}function w(a,b,c,d){var e=document.createElement("span"),f=document.createElement("input");f.type="checkbox",f.checked=b,f.id=a,e.appendChild(f);var g=document.createElement("label");return g.innerHTML=c+" ",g["for"]=a,e.appendChild(g),f.addEventListener("change",function(){y[d](f.checked)}),e}function x(a,b,c,d,e,f,g){var h=cascadeElement(a,"select",window.HTMLSelectElement),i=[];for(var j in b)if(b.hasOwnProperty(j)){var k=b[j];if(!g||k instanceof g){k=k.name||j;var l=document.createElement("option");l.innerHTML=k,i.push(b[j]),k===c&&(l.selected="selected"),h.appendChild(l)}}"function"==typeof d[e]?h.addEventListener("change",function(){d[e](i[h.selectedIndex])}):h.addEventListener("change",function(){d[e]=i[h.selectedIndex]});var m=cascadeElement("container -"+a,"div",window.HTMLDivElement),n=cascadeElement("label-"+a,"span",window.HTMLSpanElement);return n.innerHTML=f+": ",n["for"]=h,h.title=f,h.alt=f,m.appendChild(n),m.appendChild(h),m}var y=this;c=c||{},"string"==typeof c&&(c={file:c}),Primrose.Text.Control.call(this);var z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O=c.renderer||Primrose.Text.Renderers.Canvas,P=new Primrose.Text.Point,Q=new Primrose.Text.Point,R="",S=[],T=[],U=-1,V=new Primrose.Text.Rectangle,W=new Primrose.Text.Size,X=new Primrose.Text.Size,Y=!1,Z=!1,$=!0,_=!0,ab=!1,bb=0,cb=new O(a,c),db=null,eb=null;this.frontCursor=new Primrose.Text.Cursor,this.backCursor=new Primrose.Text.Cursor,this.scroll=new Primrose.Text.Point,["Left","Right","SkipLeft","SkipRight","Up","Down","Home","End","FullHome","FullEnd"].map(q.bind(this)),this.addEventListener=function(a,b){"keydown"===a&&c.keyEventSource.addEventListener(a,b)},this.cursorPageUp=function(a,b){b.incY(-V.height,a),this.scrollIntoView(b)},this.cursorPageDown=function(a,b){b.incY(V.height,a),this.scrollIntoView(b)},this.getDOMElement=function(){return cb.getDOMElement()},this.getRenderer=function(){return cb},this.setWheelScrollSpeed=function(a){bb=a||4},this.getWheelScrollSpeed=function(){return bb},this.setWordWrap=function(a){ab=a||!1,r()},this.getWordWrap=function(){return ab},this.setShowLineNumbers=function(a){$=a,r()},this.getShowLineNumbers=function(){return $},this.setShowScrollBars=function(a){_=a,r()},this.getShowScrollBars=function(){return _},this.setTheme=function(a){K=a||Primrose.Text.Themes.Default,cb.setTheme(K),cb.resize(),this.update()},this.getTheme=function(){return K},this.setDeadKeyState=function(a){R=a||""},this.setOperatingSystem=function(a){A=a||(isOSX?Primrose.Text.OperatingSystems.OSX:Primrose.Text.OperatingSystems.Windows),p()},this.getOperatingSystem=function(){return A},this.setCommandSystem=function(a){C=a||Primrose.Text.CommandPacks.TextEditor,p()},this.setSize=function(a,b){cb.setSize(a,b)},this.getWidth=function(){return cb.getWidth()},this.getHeight=function(){return cb.getHeight()},this.setCodePage=function(a){var b,c,d,e;if(z=a,!z){var f=navigator.languages&&navigator.languages[0]||navigator.language||navigator.userLanguage||navigator.browserLanguage;f&&"en"!==f||(f="en-US");for(b in Primrose.Text.CodePages)if(a=Primrose.Text.CodePages[b],a.language===f){z=a;break}z||(z=Primrose.Text.CodePages.EN_US)}S=[];for(b in Primrose.Keys)c=Primrose.Keys[b],isNaN(c)||(S[c]=b);D={};for(var g in z){var h=z[g];if("object"==typeof h)for(c in h){if(c.indexOf("_")>-1){var i=c.split(" "),j=i[0];c=i[1],d=z.NORMAL[c],e=j+"_"+g+" "+d}else d=z.NORMAL[c],e=g+"_"+d;S[c]=d,D[e]=h[c]}}p()},this.getCodePage=function(){return z},this.setTokenizer=function(a){F=a||Primrose.Text.Grammars.JavaScript,T&&T.length>0&&(d(),this.update())},this.getTokenizer=function(){return F},this.getLines=function(){return T[U].slice()},this.getLineCount=function(){return T[U].length},Object.defineProperties(this,{value:{get:function(){return T[U].join("\n")},set:function(a){a=a||"",a=a.replace(/\r\n/g,"\n");var b=a.split("\n");this.pushUndo(b),this.update()}},selectionStart:{get:function(){return this.frontCursor.i},set:function(a){this.frontCursor.setI(a,J)}},selectionEnd:{get:function(){return this.backCursor.i},set:function(a){this.backCursor.setI(a,J)}},selectionDirection:{get:function(){return this.frontCursor.i<=this.backCursor.i?"forward":"backward"}}}),this.pushUndo=function(a){U<T.length-1&&T.splice(U+1),T.push(a),U=T.length-1,d()},this.redo=function(){U<T.length-1&&++U,d(),g()},this.undo=function(){U>0&&--U,d(),g()},this.setTabWidth=function(a){L=a||4,M="";for(var b=0;L>b;++b)M+=" "},this.getTabWidth=function(){return L},this.getTabString=function(){return M},this.scrollIntoView=function(a){this.scroll.y+=v(a.y,this.scroll.y,this.scroll.y+V.height),ab||(this.scroll.x+=v(a.x,this.scroll.x,this.scroll.x+V.width)),e()},this.increaseFontSize=function(){++K.fontSize,cb.resize()},this.decreaseFontSize=function(){K.fontSize>1&&(--K.fontSize,cb.resize())},this.setFontSize=function(a){K.fontSize=a,cb.resize()},this.readWheel=function(a){this.focused&&(isChrome?(this.scroll.y+=Math.floor(a.deltaY*bb/b),this.setFontSize(K.fontSize+a.deltaX/b)):a.shiftKey?this.setFontSize(K.fontSize+a.deltaY/b):this.scroll.y+=Math.floor(a.deltaY*bb/b),e(),a.preventDefault())},this.startPointer=function(a,b){f(this.frontCursor,a,b),Y=!0,this.update()},this.movePointer=function(a,b){Y&&(f(this.backCursor,a,b),this.update())},this.endPointer=function(){Y=!1,Z=!1},this.bindEvents=function(a,b,c,d){b&&(c||b.addEventListener("wheel",this.readWheel.bind(this),!1),b.addEventListener("mousedown",j,!1),b.addEventListener("mousemove",k,!1),b.addEventListener("mouseup",l,!1),b.addEventListener("touchstart",m,!1),b.addEventListener("touchmove",n,!1),b.addEventListener("touchend",o,!1)),c&&c.addEventListener("wheel",this.readWheel.bind(this),!1),a&&(a instanceof HTMLCanvasElement&&!a.tabindex&&(a.tabindex=0),d&&(db=cascadeElement("primrose-surrogate-textarea-"+cb.id,"textarea",window.HTMLTextAreaElement),eb=makeHidingContainer("primrose-surrogate-textarea-container-"+cb.id,db),eb.style.position="absolute",eb.style.overflow="hidden",eb.style.width=0,eb.style.height=0,document.body.insertBefore(eb,document.body.children[0]),a.addEventListener("beforepaste",u,!1),a.addEventListener("paste",this.readClipboard.bind(this),!1),a.addEventListener("keydown",function(a){y.focused&&A.isClipboardReadingEvent(a)&&(db.style.display="block",db.focus())},!0),db.addEventListener("beforecopy",u,!1),db.addEventListener("copy",this.copySelectedText.bind(this),!1),db.addEventListener("beforecut",u,!1),db.addEventListener("cut",this.cutSelectedText.bind(this),!1)),a.addEventListener("keydown",this.keyDown.bind(this),!1))},this.overwriteText=function(a){if(a=a||"",a=a.replace(/\r\n/g,"\n"),this.frontCursor.i!==this.backCursor.i||a.length>0){var b=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),c=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),f=this.value,g=f.substring(0,b.i),h=f.substring(c.i);this.value=g+a+h,d(),s(),t(),b.advanceN(J,Math.max(0,a.length)),this.scrollIntoView(c),e(),c.copy(b),this.render()}},this.copySelectedText=function(a){if(this.focused){if(a.returnValue=!1,this.frontCursor.i!==this.backCursor.i){var b=Primrose.Text.Cursor.min(this.frontCursor,this.backCursor),d=Primrose.Text.Cursor.max(this.frontCursor,this.backCursor),e=this.value,f=e.substring(b.i,d.i),g=a.clipboardData||window.clipboardData;g.setData(window.clipboardData?"Text":"text/plain",f)}a.preventDefault(),db.style.display="none",c.keyEventSource.focus()}},this.cutSelectedText=function(a){this.focused&&(this.copySelectedText(a),this.readOnly||(this.overwriteText(),this.update()))},this.readClipboard=function(a){if(this.focused&&!this.readOnly){a.returnValue=!1;var b=a.clipboardData||window.clipboardData,c=b.getData(window.clipboardData?"Text":"text/plain");c&&this.overwriteText(c)}},this.keyDown=function(a){if(this.focused){a=a||event;var b=a.keyCode;if(b!==Primrose.Keys.CTRL&&b!==Primrose.Keys.ALT&&b!==Primrose.Keys.META_L&&b!==Primrose.Keys.META_R&&b!==Primrose.Keys.SHIFT&&(!this.readOnly||b===Primrose.Keys.UPARROW||b===Primrose.Keys.DOWNARROW||b===Primrose.Keys.LEFTARROW||b===Primrose.Keys.RIGHTARROW||b===Primrose.Keys.PAGEUP||b===Primrose.Keys.PAGEDOWN||b===Primrose.Keys.END||b===Primrose.Keys.HOME)){var c=R,d=R;a.ctrlKey&&(d+="CTRL"),a.altKey&&(d+="ALT"),a.metaKey&&(d+="META"),a.shiftKey&&(d+="SHIFT"),d===R&&(d+="NORMAL"),d+="_"+S[b];var f=E[B+"_"+d]||E[d];f&&(this.frontCursor.moved=!1,this.backCursor.moved=!1,f(y,J),this.frontCursor.moved&&!this.backCursor.moved&&this.backCursor.copy(this.frontCursor),e(),a.preventDefault()),R===c&&(R="")}this.update()}},this.update=function(){cb.hasResized()&&cb.resize()};var fb,gb,hb,ib,jb,kb;this.render=function(){if(G){s();var a=V.toString()!==kb,b=fb!==this.value,c=cb.character.width!==gb,d=cb.character.height!==hb,e=cb.getWidth()!==ib,f=cb.getHeight()!==jb,g=a||b||c||d||e||f;kb=V.toString(),fb=this.value,gb=cb.character.width,hb=cb.character.height,ib=cb.getWidth(),jb=cb.getHeight(),g&&t(V),cb.render(H,I,this.frontCursor,this.backCursor,V,this.scroll,this.focused,$,_,ab,V.lineCountWidth,g)}},this.appendControls=function(a){a.appendChild(this.lineNumberToggler),a.appendChild(this.wordWrapToggler),a.appendChild(this.scrollBarToggler),a.appendChild(this.operatingSystemSelect),a.appendChild(this.keyboardSelect),a.appendChild(this.commandSystemSelect),a.appendChild(this.tokenizerSelect),a.appendChild(this.themeSelect)},B=isChrome?"CHROMIUM":isFirefox?"FIREFOX":isIE?"IE":isOpera?"OPERA":isSafari?"SAFARI":"UNKNOWN",this.readOnly=!!c.readOnly,(c.autoBindEvents||cb.autoBindEvents)&&(c.readOnly||void 0!==c.keyEventSource||(c.keyEventSource=cb.getDOMElement()),void 0===c.pointerEventSource&&(c.pointerEventSource=cb.getDOMElement()),void 0===c.wheelEventSource&&(c.wheelEventSource=cb.getDOMElement())),this.setWheelScrollSpeed(c.wheelScrollSpeed),this.setWordWrap(!c.disableWordWrap),this.setShowLineNumbers(!c.hideLineNumbers),this.setShowScrollBars(!c.hideScrollBars),this.setTabWidth(c.tabWidth),this.setTheme(c.theme),this.setFontSize(c.fontSize||16),this.setTokenizer(c.tokenizer),this.setCodePage(c.codePage),this.setOperatingSystem(c.os),this.setCommandSystem(c.commands),this.value=c.file,this.bindEvents(c.keyEventSource,c.pointerEventSource,c.wheelEventSource,!c.disableClipboard),this.lineNumberToggler=w("primrose-line-number-toggler-"+cb.id,!c.hideLineNumbers,"Line numbers","setShowLineNumbers"),this.wordWrapToggler=w("primrose-word-wrap-toggler-"+cb.id,!c.disableWordWrap,"Line wrap","setWordWrap"),this.scrollBarToggler=w("primrose-scrollbar-toggler-"+cb.id,!c.hideScrollBars,"Scroll bars","setShowScrollBars"),this.themeSelect=x("primrose-theme-selector-"+cb.id,Primrose.Text.Themes,K.name,y,"setTheme","theme"),this.commandSystemSelect=x("primrose-command-system-selector-"+cb.id,Primrose.Text.Commands,C.name,y,"setCommandSystem","Command system"),this.tokenizerSelect=x("primrose-tokenizer-selector-"+cb.id,Primrose.Text.Grammars,F.name,y,"setTokenizer","Language syntax",Primrose.Text.Grammar),this.keyboardSelect=x("primrose-keyboard-selector-"+cb.id,Primrose.Text.CodePages,z.name,y,"setCodePage","Localization",Primrose.Text.CodePage),this.operatingSystemSelect=x("primrose-operating-system-selector-"+cb.id,Primrose.Text.OperatingSystems,A.name,y,"setOperatingSystem","Shortcut style",Primrose.Text.OperatingSystem)}var b=isFirefox?3:100;return inherit(a,Primrose.Text.Control),a}(),Primrose.Text.Grammars.Basic=function(){var grammar=new Primrose.Text.Grammar("BASIC",[["newlines",/(?:\r\n|\r|\n)/],["lineNumbers",/^\d+\s+/],["comments",/^REM.*$/],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:RESTORE|REPEAT|RETURN|LOAD|LABEL|DATA|READ|THEN|ELSE|FOR|DIM|LET|IF|TO|STEP|NEXT|WHILE|WEND|UNTIL|GOTO|GOSUB|ON|TAB|AT|END|STOP|PRINT|INPUT|RND|INT|CLS|CLK|LEN)\b/],["keywords",/^DEF FN/],["operators",/(?:\+|;|,|-|\*\*|\*|\/|>=|<=|=|<>|<|>|OR|AND|NOT|MOD|\(|\)|\[|\])/],["identifiers",/\w+\$?/]]),oldTokenize=grammar.tokenize;return grammar.tokenize=function(a){return oldTokenize.call(this,a.toUpperCase())},grammar.interpret=function(sourceCode,input,output,errorOut,next,clearScreen,loadFile,done){function toNum(a){return new Primrose.Text.Token(a.toString(),"numbers")}function toStr(a){return new Primrose.Text.Token('"'+a.replace("\n","\\n").replace('"','\\"')+'"',"strings")}function process(a){if(a&&a.length>0){var b=a.shift();if(b){if(commands.hasOwnProperty(b.value))return commands[b.value](a);if(isNumber(b.value))return setProgramCounter([b]);if(state[b.value]||a.length>0&&"operators"===a[0].type&&"="===a[0].value)return a.unshift(b),translate(a);error("Unknown command. >>> "+b.value)}}return pauseBeforeComplete()}function error(a){errorOut("At line "+lineNumbers[counter]+": "+a)}function getLine(a){var b=lineNumbers[a],c=program[b];return c&&c.slice()}function evaluate(line){for(var script="",i=0;i<line.length;++i){var t=line[i],nest=0;if("identifiers"===t.type&&"function"!=typeof state[t.value]&&i<line.length-1&&"("===line[i+1].value)for(var j=i+1;j<line.length;++j){var t2=line[j];if("("===t2.value?(0===nest&&(t2.value="["),++nest):")"===t2.value?(--nest,0===nest&&(t2.value="]")):","===t2.value&&1===nest&&(t2.value="]["),0===nest)break}script+=t.value}with(state)try{return eval(script)}catch(exp){console.debug(line.join(", ")),console.error(exp),console.error(script),error(exp.message+": "+script)}}function declareVariable(a){var b,c=[],d=[c],e=0;for(b=0;b<a.length;++b){var f=a[b];"("===f.value?++e:")"===f.value&&--e,0===e&&","===f.value?(c=[],d.push(c)):c.push(f)}for(b=0;b<d.length;++b){c=d[b];var g=c.shift();if("identifiers"===g.type){var h,i=null;if(g=g.value,"("===c[0].value&&")"===c[c.length-1].value){var j=[];for(h=1;h<c.length-1;++h)"numbers"===c[h].type&&j.push(0|c[h].value);if(0===j.length)i=[];else{i=new Array(j[0]);var k=[i];for(h=1;h<j.length;++h)for(var l=j[h],m=0,n=k.length;n>m;++m)for(var o=k.shift(),p=0;p<o.length;++p)o[p]=new Array(l),h<j.length-1&&k.push(o[p])}}return state[g]=i,!0}error("Identifier expected: "+g.value)}}function print(a){var b="\n",c=0;a=a.map(function(d,e){return d=d.clone(),"operators"===d.type&&(","===d.value?0===c&&(d.value='+ ", " + '):";"===d.value?(d.value='+ " "',e<a.length-1?d.value+=" + ":b=""):"("===d.value?++c:")"===d.value&&--c),d});var d=evaluate(a);return void 0===d&&(d=""),output(d+b),!0}function setProgramCounter(a){var b=parseFloat(evaluate(a));for(counter=-1;counter<lineNumbers.length-1&&lineNumbers[counter+1]<b;)++counter;return!0}function checkConditional(a){var b,c=-1,d=-1;for(b=0;b<a.length;++b)"keywords"===a[b].type&&"THEN"===a[b].value?c=b:"keywords"===a[b].type&&"ELSE"===a[b].value&&(d=b);if(-1===c)error("Expected THEN clause.");else{var e=a.slice(0,c);for(b=0;b<e.length;++b){var f=e[b];"operators"===f.type&&"="===f.value&&(f.value="==")}var g,h;if(-1===d?g=a.slice(c+1):(g=a.slice(c+1,d),h=a.slice(d+1)),evaluate(e))return process(g);if(h)return process(h)}return!0}function pauseBeforeComplete(){return output("PROGRAM COMPLETE - PRESS RETURN TO FINISH."),input(function(){isDone=!0,done&&done()}),!1}function labelLine(a){return a.push(EQUAL_SIGN),a.push(toNum(lineNumbers[counter])),translate(a)}function waitForInput(a){var b=a.pop();return a.length>0&&print(a),input(function(a){a=a.toUpperCase();var c=null;c=isNumber(a)?toNum(a):toStr(a),evaluate([b,EQUAL_SIGN,c]),next&&next()}),!1}function onStatement(a){var b=[],c=null,d=[];try{for(;a.length>0&&("keywords"!==a[0].type||"GOTO"!==a[0].value);)b.push(a.shift());if(a.length>0){a.shift();for(var e=0;e<a.length;++e){var f=a[e];("operators"!==f.type||","!==f.value)&&d.push(f)}if(c=evaluate(b)-1,c>=0&&c<d.length)return setProgramCounter([d[c]])}}catch(g){console.error(g)}return!0}function gotoSubroutine(a){return returnStack.push(toNum(lineNumbers[counter+1])),setProgramCounter(a)}function setRepeat(){return returnStack.push(toNum(lineNumbers[counter])),!0}function conditionalReturn(a){var b=!0,c=returnStack.pop();return c&&a&&(b=setProgramCounter([c])),b}function untilLoop(a){var b=!evaluate(a);return conditionalReturn(b)}function findNext(a){for(i=counter+1;i<lineNumbers.length;++i){var b=getLine(i);if(b[0].value===a)return i}return lineNumbers.length}function whileLoop(a){var b=evaluate(a);return b?returnStack.push(toNum(lineNumbers[counter])):counter=findNext("WEND"),!0}function forLoop(a){var b=lineNumbers[counter],c=[],d=[],e=[],f=[],g=[c,d,e,f],h=0,i=0;for(i=0;i<a.length;++i){var j=a[i];j.value===FOR_LOOP_DELIMS[h]?(0===h&&c.push(j),++h):g[h].push(j)}var k=1;f.length>0&&(k=evaluate(f)),void 0===forLoopCounters[b]&&(forLoopCounters[b]=evaluate(d));var l=evaluate(e),m=forLoopCounters[b]<=l;return m?(c.push(toNum(forLoopCounters[b])),process(c),forLoopCounters[b]+=k,returnStack.push(toNum(lineNumbers[counter]))):(delete forLoopCounters[b],counter=findNext("NEXT")),!0}function stackReturn(){return conditionalReturn(!0)}function loadCodeFile(a){return loadFile(evaluate(a),function(){next&&next()}),!1}function noop(){return!0}function loadData(a){for(;a.length>0;){var b=a.shift();"operators"!==b.type&&data.push(b.value)}return!0}function readData(a){if(0===data.length){var b=findNext("DATA");process(getLine(b))}var c=data[dataCounter];return++dataCounter,a.push(EQUAL_SIGN),a.push(toNum(c)),translate(a)}function restoreData(){return dataCounter=0,!0}function defineFunction(line){for(var name=line.shift().value,signature="",body="",fillSig=!0,i=0;i<line.length;++i){var t=line[i];"operators"===t.type&&"="===t.value?fillSig=!1:fillSig?signature+=t.value:body+=t.value}name="FN"+name;var script="(function "+name+signature+"{ return "+body+"; })";return state[name]=eval(script),!0}function translate(a){return evaluate(a),!0}for(var tokens=this.tokenize(sourceCode),EQUAL_SIGN=new Primrose.Text.Token("=","operators"),counter=0,isDone=!1,program={},lineNumbers=[],currentLine=[],lines=[currentLine],data=[],returnStack=[],forLoopCounters={},dataCounter=0,state={INT:function(a){return 0|a},RND:function(){return Math.random()},CLK:function(){return Date.now()/36e5},LEN:function(a){return a.length},LINE:function(){return lineNumbers[counter]},TAB:function(a){for(var b="",c=0;a>c;++c)b+=" ";return b},POW:function(a,b){return Math.pow(a,b)}},tokenMap={OR:"||",AND:"&&",NOT:"!",MOD:"%","<>":"!="};tokens.length>0;){var token=tokens.shift();"newlines"===token.type?(currentLine=[],lines.push(currentLine)):"regular"!==token.type&&"comments"!==token.type&&(token.value=tokenMap[token.value]||token.value,currentLine.push(token))}for(var i=0;i<lines.length;++i){var line=lines[i];if(line.length>0){var lastLine=lineNumbers[lineNumbers.length-1],lineNumber=line.shift();if("lineNumbers"!==lineNumber.type&&(line.unshift(lineNumber),void 0===lastLine&&(lastLine=-1),lineNumber=toNum(lastLine+1)),lineNumber=parseFloat(lineNumber.value),lastLine&&lastLine>=lineNumber)throw new Error("expected line number greater than "+lastLine+", but received "+lineNumber+".");line.length>0&&(lineNumbers.push(lineNumber),program[lineNumber]=line)}}var FOR_LOOP_DELIMS=["=","TO","STEP"],commands={DIM:declareVariable,LET:translate,PRINT:print,GOTO:setProgramCounter,IF:checkConditional,INPUT:waitForInput,END:pauseBeforeComplete,STOP:pauseBeforeComplete,REM:noop,"'":noop,CLS:clearScreen,ON:onStatement,GOSUB:gotoSubroutine,RETURN:stackReturn,LOAD:loadCodeFile,DATA:loadData,READ:readData,RESTORE:restoreData,REPEAT:setRepeat,UNTIL:untilLoop,"DEF FN":defineFunction,WHILE:whileLoop,WEND:stackReturn,FOR:forLoop,NEXT:stackReturn,LABEL:labelLine};return function(){if(!isDone)for(var a=!0;a;){var b=getLine(counter);a=process(b),++counter}}},grammar}(),Primrose.Text.Grammars.JavaScript=function(){"use strict";return new Primrose.Text.Grammar("JavaScript",[["newlines",/(?:\r\n|\r|\n)/],["comments",/\/\/.*$/],["startBlockComments",/\/\*/],["endBlockComments",/\*\//],["strings",/"(?:\\"|[^"])*"/],["strings",/'(?:\\'|[^'])*'/],["strings",/\/(?:\\\/|[^/])*\/\w*/],["numbers",/-?(?:(?:\b\d*)?\.)?\b\d+\b/],["keywords",/\b(?:break|case|catch|const|continue|debugger|default|delete|do|else|export|finally|for|function|if|import|in|instanceof|let|new|return|super|switch|this|throw|try|typeof|var|void|while|with)\b/],["functions",/(\w+)(?:\s*\()/],["members",/(?:(?:\w+\.)+)(\w+)/]])}(),Primrose.Text.Grammars.PlainText=function(){"use strict";return new Primrose.Text.Grammar("PlainText",[["newlines",/(?:\r\n|\r|\n)/]])}(),Primrose.Text.Grammars.TestResults=function(){"use strict";return new Primrose.Text.Grammar("TestResults",[["newlines",/(?:\r\n|\r|\n)/,!0],["numbers",/(\[)(o+)/,!0],["numbers",/(\d+ succeeded), 0 failed/,!0],["numbers",/^    Successes:/,!0],["functions",/(x+)\]/,!0],["functions",/[1-9]\d* failed/,!0],["functions",/^    Failures:/,!0],["comments",/(\d+ms:)(.*)/,!0],["keywords",/(Test results for )(\w+):/,!0],["strings",/        \w+/,!0]])}(),Primrose.Text.OperatingSystems.OSX=function(){"use strict";return new Primrose.Text.OperatingSystem("OS X","META","ALT","METASHIFT_z","META","LEFTARROW","RIGHTARROW","META","UPARROW","DOWNARROW")}(),Primrose.Text.OperatingSystems.Windows=function(){"use strict";return new Primrose.Text.OperatingSystem("Windows","CTRL","CTRL","CTRL_y","","HOME","END","CTRL","HOME","END")}(),Primrose.Text.Renderers.Canvas=function(){"use strict";return function(a,b){function c(a,b,c,d,e,f){a.fillStyle=b,a.fillRect(c*h.character.width,d*h.character.height,e*h.character.width+1,f*h.character.height+1)}function d(a,b,c,d,e,f){a.strokeStyle=b,a.strokeRect(c*h.character.width,d*h.character.height,e*h.character.width+1,f*h.character.height+1)}function e(a,b,d,e,f,g){var j=Primrose.Text.Cursor.min(e,f),k=Primrose.Text.Cursor.max(e,f),l=new Primrose.Text.Cursor,m=new Primrose.Text.Cursor,n=q.regular.backColor?"fillRect":"clearRect";q.regular.backColor&&(o.fillStyle=q.regular.backColor),o[n](0,0,i.width,i.height),o.save(),o.translate((b.x-d.x)*h.character.width,-d.y*h.character.height),g&&c(o,q.regular.currentRowBackColor||Primrose.Text.Themes.Default.regular.currentRowBackColor,0,j.y,b.width,k.y-j.y+1);for(var p=0;p<a.length;++p){for(var r=a[p],s=0;s<r.length;++s){var t=r[s];if(m.x+=t.value.length,m.i+=t.value.length,d.y<=p&&p<d.y+b.height&&d.x<=m.x&&l.x<d.x+b.width){var u=j.i<=m.i&&l.i<k.i;if(u){var v=Primrose.Text.Cursor.max(j,l),w=Primrose.Text.Cursor.min(k,m),x=w.i-v.i;c(o,q.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,v.x,v.y,x,1)}}l.copy(m)}l.x=0,++l.y,m.copy(l)}if(g){var y=q.cursorColor||"black",z=1/h.character.width;c(o,y,j.x,j.y,z,1),c(o,y,k.x,k.y,z,1)}o.restore()}function f(a,b,c,d){var e,f=new Primrose.Text.Cursor,g=new Primrose.Text.Cursor,j=Math.ceil(.2*h.character.height);n.clearRect(0,0,i.width,i.height),n.save(),n.translate((b.x-c.x)*h.character.width,0);for(var l=0;l<a.length;++l){var m=d[l],o=a[l],p=!1,r=(l+.8-c.y)*h.character.height,s=(l-c.y-.2)*h.character.height+j;for(e=0;e<o.length;++e){var u=o[e];if(g.x+=u.value.length,g.i+=u.value.length,c.y<=l&&l<c.y+b.height&&c.x<=g.x&&f.x<c.x+b.width)if(void 0!==t[m])0===e&&n.putImageData(t[m],0,s);else{var v=q[u.type]||{},w=(v.fontWeight||q.regular.fontWeight||"")+" "+(v.fontStyle||q.regular.fontStyle||"")+" "+h.character.height+"px "+q.fontFamily;n.font=w.trim(),n.fillStyle=v.foreColor||q.regular.foreColor,n.fillText(u.value,f.x*h.character.width,r),p=!0}f.copy(g)}f.x=0,++f.y,g.copy(f),p&&void 0===t[m]&&(t[m]=n.getImageData(0,s,k.width,h.character.height))}n.restore()}function g(a,b,e,f,g,j,k,l){var m,n=new Primrose.Text.Cursor,o=new Primrose.Text.Cursor,r=0;p.clearRect(0,0,i.width,i.height),p.save(),p.lineWidth=2,p.translate(0,-e.y*h.character.height);for(var s=0,t=-1;s<a.length;++s){var u=a[s];for(m=0;m<u.length;++m){var v=u[m];
o.x+=v.value.length,o.i+=v.value.length,n.copy(o)}if(r=Math.max(r,o.x),n.x=0,++n.y,o.copy(n),f&&e.y<=s&&s<e.y+b.height){for(var w=u.length>0?u[0].line:t+1,x=w.toString();x.length<k;)x=" "+x;c(p,q.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor,0,s,b.x,1),p.font="bold "+h.character.height+"px "+q.fontFamily,w>t&&(p.fillStyle=q.regular.foreColor,p.fillText(x,0,(s+.8)*h.character.height)),t=w}}if(p.restore(),f&&d(p,q.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,0,0,b.x,b.height),g){var y=b.width*h.character.width,z=b.height*h.character.height,A=e.x*y/r+b.x*h.character.width,B=e.y*z/a.length+b.y*h.character.height;p.fillStyle=q.regular.selectedBackColor||Primrose.Text.Themes.Default.regular.selectedBackColor;var C;if(!j&&r>b.width){var D=y*(b.width/r),E=(b.height+.25)*h.character.height;C=Math.max(h.character.width,D),p.fillRect(A,E,C,h.character.height),p.strokeRect(A,E,C,h.character.height)}if(a.length>b.height){var F=z*(b.height/a.length),G=i.width-h.VSCROLL_WIDTH*h.character.width,H=Math.max(h.character.height,F);C=h.VSCROLL_WIDTH*h.character.width,p.fillRect(G,B,C,H),p.strokeRect(G,B,C,H)}}d(p,q.regular.foreColor||Primrose.Text.Themes.Default.regular.foreColor,b.x,0,b.width,b.height),p.strokeRect(0,0,i.width,i.height),l||(p.fillStyle=q.regular.unfocused||Primrose.Text.Themes.Default.regular.unfocused,p.fillRect(0,0,i.width,i.height))}var h=this,i=cascadeElement(a,"canvas",window.HTMLCanvasElement),j=cascadeElement(i.id+"-back","canvas",window.HTMLCanvasElement),k=cascadeElement(i.id+"-front","canvas",window.HTMLCanvasElement),l=cascadeElement(i.id+"-trim","canvas",window.HTMLCanvasElement),m=i.getContext("2d"),n=k.getContext("2d"),o=j.getContext("2d"),p=l.getContext("2d"),q=null,r=null,s=b.size,t={},u=!1,v=-1,w=-1,x=-1,y=-1,z=-1,A=-1,B=null;this.VSCROLL_WIDTH=2,this.character=new Primrose.Text.Size,this.id=i.id,this.autoBindEvents=!0,this.setTheme=function(a){q=a},this.pixel2cell=function(a,b,c){var d=a.x*i.width/i.clientWidth,e=a.y*i.height/i.clientHeight;a.set(Math.round(d/this.character.width)+b.x-c.x,Math.floor(e/this.character.height-.25)+b.y)},this.hasResized=function(){var a=i.width,b=i.height,c=i.clientWidth,d=i.clientHeight;return a!==c||b!==d},this.resize=function(){if(q){var a=s&&s.width||i.clientWidth,b=s&&s.height||i.clientHeight;this.character.height=q.fontSize,m.font=this.character.height+"px "+q.fontFamily,this.character.width=m.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,(x!==a||y!==b)&&a>0&&b>0&&(x=j.width=k.width=l.width=i.width=a,y=j.height=k.height=l.height=i.height=b)}},this.setSize=function(a,b){return i.style.width=a+"px",i.style.height=b+"px",this.resize()},this.getWidth=function(){return i.width},this.getHeight=function(){return i.height},this.render=function(a,b,c,d,h,n,o,p,s,x,y,C){if(q){var D=c.i!==v||w!==d.i,E=n.x!==z||n.y!==A,F=m.font!==B,G=o!==u;v=c.i,w=d.i,u=o,B=m.font,z=n.x,A=n.y,C&&(t={});var H=C||F||E,I=H||G||D;(H||I)&&(e(a,h,n,c,d,o),(H||G)&&(H&&f(a,h,n,b),g(a,h,n,p,s,x,y,o)),m.clearRect(0,0,i.width,i.height),m.drawImage(j,0,0),m.drawImage(k,0,0),m.drawImage(l,0,0),r&&(r.needsUpdate=!0))}},this.getDOMElement=function(){return i},this.getTexture=function(){return"undefined"==typeof window.THREE||r||(r=new THREE.Texture(i),r.needsUpdate=!0),r},a instanceof window.HTMLCanvasElement||!s||(i.style.position="absolute",i.style.width=s.width,i.style.height=s.height),i.parentElement||(this.autoBindEvents=!1,document.body.appendChild(makeHidingContainer("primrose-container-"+i.id,i)))}}(),Primrose.Text.Renderers.DOM=function(){"use strict";function a(a){function c(a){a.style.font=d.font,a.style.lineHeight=px(parseInt(d.font,10)),a.style.padding="0",a.style.margin="0"}var d=this;this.font=null,this.fillStyle=null;var e=[new Point];this.measureText=function(a){var d=document.createElement("div");c(d),d.style.position="absolute",d.style.visibility="hidden",d.innerHTML=a,document.body.appendChild(d);var e=new b(d.clientWidth,d.clientHeight);return document.body.removeChild(d),e},this.clearRect=function(){a.innerHTML=""},this.drawImage=function(b,c,d){var f=e[e.length-1];b.style.position="absolute",b.style.left=px(c+f.x),b.style.top=px(d+f.y),a.appendChild(b)},this.fillRect=function(b,c,d,f){var g=e[e.length-1],h=document.createElement("div");h.style.position="absolute",h.style.left=px(b+g.x),h.style.top=px(c+g.y),h.style.width=px(d),h.style.height=px(f),h.style.backgroundColor=this.fillStyle,a.appendChild(h)},this.fillText=function(b,d,f){var g=e[e.length-1],h=document.createElement("span");h.style.position="absolute",h.style.left=px(d+g.x),h.style.top=px(f+g.y),h.style.whiteSpace="pre",c(h),h.style.color=this.fillStyle,h.appendChild(document.createTextNode(b)),a.appendChild(h)},this.save=function(){var a=e[e.length-1];e.push(a.clone())},this.restore=function(){e.pop()},this.translate=function(a,b){var c=e[e.length-1];c.x+=a,c.y+=b}}var b=Primrose.Text.Size,c=Primrose.Text.Cursor,d=Primrose.Text.Themes.Default;return window.HTMLDivElement.prototype.getContext=function(b){if("2d"!==b)throw new Exception("type parameter needs to be '2d'.");return this.style.width=pct(100),this.style.height=pct(100),new a(this)},function(a,e){function f(a,b,c,d,e,f){a.fillStyle=b,a.fillRect(c*j.character.width,d*j.character.height,e*j.character.width+1,f*j.character.height+1)}function g(a,b,e,g,h,i){var k=c.min(b,e),m=c.max(b,e),n=new c,o=new c;s.regular.backColor&&(q.fillStyle=s.regular.backColor,l.style.backgroundColor=s.regular.backColor),q.clearRect(0,0,t,u),q.save(),q.translate((g.x-h.x)*j.character.width,-h.y*j.character.height),i&&f(q,s.regular.currentRowBackColor||d.regular.currentRowBackColor,0,k.y+.2,g.width,m.y-k.y+1);for(var p=0;p<a.length;++p){for(var r=a[p],v=0;v<r.length;++v){var w=r[v];if(o.x+=w.value.length,o.i+=w.value.length,h.y<=p&&p<h.y+g.height&&h.x<=o.x&&n.x<h.x+g.width){var x=k.i<=o.i&&n.i<m.i;if(x){var y=c.max(k,n),z=c.min(m,o),A=z.i-y.i;f(q,s.regular.selectedBackColor||d.regular.selectedBackColor,y.x,y.y+.2,A,1)}}n.copy(o)}n.x=0,++n.y,o.copy(n)}if(i){var B=s.cursorColor||"black",C=1/j.character.width;f(q,B,k.x,k.y,C,1),f(q,B,m.x,m.y,C,1)}q.restore()}function h(a,b,d){var e=new c,f=new c,g=0;p.clearRect(0,0,t,u),p.save(),p.translate((b.x-d.x)*j.character.width,-d.y*j.character.height);for(var h=0;h<a.length;++h){for(var i=a[h],k=0;k<i.length;++k){var l=i[k];if(f.x+=l.value.length,f.i+=l.value.length,d.y<=h&&h<d.y+b.height&&d.x<=f.x&&e.x<d.x+b.width){var m=s[l.type]||{},n=(m.fontWeight||s.regular.fontWeight||"")+" "+(m.fontStyle||s.regular.fontStyle||"")+" "+j.character.height+"px "+s.fontFamily;p.font=n.trim(),p.fillStyle=m.foreColor||s.regular.foreColor,p.fillText(l.value,e.x*j.character.width,h*j.character.height)}e.copy(f)}g=Math.max(g,f.x),e.x=0,++e.y,f.copy(e)}return p.restore(),g}function i(a,b,c,e,g,h,i,k){if(r.clearRect(0,0,t,u),r.save(),r.translate(0,-c.y*j.character.height),e)for(var l=c.y,m=-1;l<c.y+b.height&&l<a.length;++l){for(var n=a[l],o=n.length>0?n[0].line:m+1,p=o.toString();p.length<i;)p=" "+p;f(r,s.regular.selectedBackColor||d.regular.selectedBackColor,0,l+.2,b.x,1),r.font="bold "+j.character.height+"px "+s.fontFamily,o>m&&(r.fillStyle=s.regular.foreColor,r.fillText(p,0,l*j.character.height)),m=o}if(r.restore(),g){var q=b.width*j.character.width,v=b.height*j.character.height,w=c.x*q/k+b.x*j.character.width,x=c.y*v/a.length+b.y*j.character.height;if(r.fillStyle=s.regular.selectedBackColor||d.regular.selectedBackColor,!h&&k>b.width){var y=q*(b.width/k);r.fillRect(w,(b.height+.25)*j.character.height,Math.max(j.character.width,y),j.character.height)}if(a.length>b.height){var z=v*(b.height/a.length);r.fillRect(t-j.VSCROLL_WIDTH*j.character.width,x,j.VSCROLL_WIDTH*j.character.width,Math.max(j.character.height,z))}}}var j=this,k=cascadeElement(a,"div",window.HTMLDivElement),l=cascadeElement(k.id+"-back","div",window.HTMLDivElement),m=cascadeElement(k.id+"-front","div",window.HTMLDivElement),n=cascadeElement(k.id+"-trim","div",window.HTMLDivElement),o=k.getContext("2d"),p=m.getContext("2d"),q=l.getContext("2d"),r=n.getContext("2d"),s=null,t=null,u=null;this.VSCROLL_WIDTH=2,this.character=new b,this.id=k.id,this.autoBindEvents=!0,this.setTheme=function(a){s=a},this.pixel2cell=function(a,b,c){a.set(Math.round(a.x/this.character.width)+b.x-c.x,Math.floor(a.y/this.character.height-.25)+b.y)},this.hasResized=function(){var a=k.clientWidth,b=k.clientHeight;return t!==a||u!==b},this.resize=function(){var a=!1;if(s){var b=this.character.width,c=this.character.height,d=k.clientWidth,e=k.clientHeight,f=o.font;this.character.height=s.fontSize,o.font=px(this.character.height)+" "+s.fontFamily,this.character.width=o.measureText("MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM").width/100,a=b!==this.character.width||c!==this.character.height||f!==o.font,d>0&&e>0&&(l.width=m.width=n.width=d,l.height=m.height=n.height=e,a=a||t!==d||u!==d,t=d,u=e)}return a},this.setSize=function(a,b){return k.style.width=px(a),k.style.height=px(b),this.resize()},this.getWidth=function(){return t},this.getHeight=function(){return u},this.render=function(a,b,c,d,e,f,j,k,p,q,r){var s=0;g(a,c,d,e,f,j),s=h(a,e,f),i(a,e,f,k,p,q,r,s),o.clearRect(0,0,t,u),o.drawImage(l,0,0),o.drawImage(m,0,0),o.drawImage(n,0,0)},this.getDOMElement=function(){return k},a instanceof window.HTMLDivElement||!e.width||!e.height||(k.style.position="absolute",k.style.width=e.width,k.style.height=e.height),k.parentElement||(this.autoBindEvents=!1,document.body.appendChild(makeHidingContainer("primrose-container-"+k.id,k)))}},Primrose.Text.Themes.Dark=function(){"use strict";return{name:"Dark",fontFamily:"monospace",cursorColor:"white",fontSize:16,lineNumbers:{foreColor:"white"},regular:{backColor:"black",foreColor:"#c0c0c0",currentRowBackColor:"#202020",selectedBackColor:"#404040",unfocused:"rgba(0, 0, 0, 0.5)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"yellow",fontStyle:"italic"},keywords:{foreColor:"cyan"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.Text.Themes.Default=function(){"use strict";return{name:"Light",fontFamily:"monospace",cursorColor:"black",fontSize:16,regular:{backColor:"white",foreColor:"black",currentRowBackColor:"#f0f0f0",selectedBackColor:"#c0c0c0",unfocused:"rgba(255, 255, 255, 0.75)"},strings:{foreColor:"#aa9900",fontStyle:"italic"},numbers:{foreColor:"green"},comments:{foreColor:"grey",fontStyle:"italic"},keywords:{foreColor:"blue"},functions:{foreColor:"brown",fontWeight:"bold"},members:{foreColor:"green"},error:{foreColor:"red",fontStyle:"underline italic"}}}(),Primrose.VERSION="v0.18.0",console.log("Using Primrose v0.18.0. Find out more at http://www.primrosevr.com");