function getSourceCode(e){var t=pacman.toString(),n=e&&t||getSetting(CODE_KEY,t);if(n===t){var i=n.replace("\r\n","\n").split("\n");i.pop(),i.shift();for(var o=0;o<i.length;++o)i[o]=i[o].substring(2);n=i.join("\n")}return n.trim()}function wipeScene(){for(var e=subScene.children.length-1;e>=0;--e)subScene.remove(subScene.children[e])}function updateScript(){var e=editor.value;e!==lastScript&&(env.transition(function(){scriptUpdateTimeout=null,lastScript=e,e.indexOf("function update")>=0&&e.indexOf("return update")<0&&(e+="\nreturn update;"),console.log("----- loading new script -----"),scriptAnimate=null;try{var t=new Function("scene",e);wipeScene(),scriptAnimate=t.call(env,subScene),scriptAnimate&&scriptAnimate(0),console.log("----- script loaded -----"),scriptAnimate?env.quality===Primrose.Constants.Quality.NONE&&(env.quality=Primrose.Constants.Quality.MEDIUM):console.log("----- No update script provided -----")}catch(n){t=null,console.error(n),console.error(e)}},null,first),first=!1)}function pacman(){function e(e,t,n){0!==e&&cylinder(.5,.5,r).colored(255).addTo(scene).rot(0,e*Math.PI/2,Math.PI/2).at(r*t-a/2,env.options.avatarHeight,r*n-c/2)}function t(e,t,n){var i=Math.floor((t.position.x+a/2+1)/r),o=Math.floor((t.position.z+c/2+1)/r),s=l[o],d=s&&0|s[i],u=t.velocity.clone().multiplyScalar(1.5*-e);d>0&&((n||t.isOnGround)&&t.position.add(u),n&&t.velocity.set(t.velocity.z,0,-t.velocity.x))}for(var n,i=Primrose.Random.int,o=Primrose.Graphics.ModelFactory.loadObject,r=3,a=30,c=30,s=[16711680,16776960,16711935,65535],l=["12222222221","10000000001","10222022201","10001000001","10101022201","10100010101","10222220101","10000000001","12222222221"],d=0;d<l.length;++d)for(var u=l[d],p=0;p<u.length;++p)e(0|u[p],p,d);return console.log("Here we go"),o("../models/ghost.obj").then(function(e){console.log("ghost",e),n=s.map(function(t,n){var o=e.clone(),r=o.children[0];return colored(r,t),scene.appendChild(o),o.position.set(3*n-4,0,-5),o.velocity=v3(0,0,0),o.velocity.x=i(-1,2),0===o.velocity.x&&0===o.velocity.z&&(o.velocity.z=i(-1,2)),o})}),function(e){n&&n.forEach(function(n){n.position.add(n.velocity.clone().multiplyScalar(e)),t(e,n,env.input.head)}),t(e,env.input.head,null)}}var GRASS="../images/grass.png",ROCK="../images/rock.png",SAND="../images/sand.png",WATER="../images/water.png",DECK="../images/deck.png",CODE_KEY="Pacman code",env=new Primrose.BrowserEnvironment({backgroundColor:0,skyTexture:DECK,groundTexture:DECK,font:"../fonts/helvetiker_regular.typeface.json",fullScreenButtonContainer:"#fullScreenButtonContainer",progress:Preloader.thunk}),editor=null,modA=isMacOS?"metaKey":"ctrlKey",modB=isMacOS?"altKey":"shiftKey",cmdA=isMacOS?"CMD":"CTRL",cmdB=isMacOS?"OPT":"SHIFT",cmdPre=cmdA+"+"+cmdB,scriptUpdateTimeout,lastScript=null,scriptAnimate=null,subScene=hub();env.addEventListener("ready",function(){env.scene.add(subScene);var e=isMobile?512:1024,t=isMobile?10:20;editor=new Primrose.Controls.TextBox({id:"Editor",width:e,height:e,geometry:shell(1.5,25,25),fontSize:t,tokenizer:Primrose.Text.Grammars.JavaScript,value:getSourceCode(isInIFrame)}).addTo(env.vicinity).at(0,env.options.avatarHeight,0),Preloader.hide()},!1),window.addEventListener("beforeunload",function(e){},!1),window.addEventListener("unload",function(e){var t=editor&&editor.value;t&&t.length>0&&setSetting(CODE_KEY,t)},!1),env.addEventListener("update",function(){if(scriptUpdateTimeout||(scriptUpdateTimeout=setTimeout(updateScript,500)),scriptAnimate)if(env.quality===Primrose.Constants.Quality.NONE)scriptAnimate=null,wipeScene();else try{scriptAnimate.call(env,env.deltaTime)}catch(e){console.error(e),scriptAnimate=null}}),env.addEventListener("keydown",function(e){e[modA]&&e[modB]&&(e.keyCode===Primrose.Keys.E?editor.visible=!editor.visible:e.keyCode===Primrose.Keys.X&&(editor.value=getSourceCode(!0))),scriptUpdateTimeout&&(clearTimeout(scriptUpdateTimeout),scriptUpdateTimeout=null)});var first=!0;